<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharmacy Finder</title>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_lP5NeY2aU2pHP79V0sx3wc6F8tQRRIk&libraries=places,directions"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f4f4;
        }

        #container {
            display: flex;
            width: 90%;
            height: 80%;
            max-width: 1200px;
            background: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        #map {
            width: 70%;
            height: 100%;
        }

        #pharmacyListContainer {
            width: 30%;
            overflow-y: auto;
            padding: 20px;
            background-color: #fafafa;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #pharmacyListContainer h3 {
            margin-top: 10px;
        }

        #inputContainer {
            display: flex;
            margin-bottom: 10px;
            justify-content: space-between;
        }

        #inputContainer input {
            flex: 1;
            padding: 8px;
            font-size: 16px;
            margin-right: 5px;
        }

        #inputContainer button {
            padding: 8px 12px;
            font-size: 16px;
            background-color: #333;
            cursor: pointer;
            color: #fff;
        }

        #geolocationButton {
            background-color: #ddd;
            border: none;
            padding: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 5px;
        }

        #geolocationButton.active {
            background-color: #0099D8;
        }

        .pharmacy-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }

        .pharmacy-item:hover {
            background-color: #f0f0f0;
        }

        .directions-link {
            color: #0066cc;
            text-decoration: none;
            font-size: 14px;
        }

        .directions-link:hover {
            text-decoration: underline;
        }

        #pharmacyList {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Custom styles for the infowindow close button */
        .gm-style-iw-c {
            padding-right: 20px !important; /* Adds some padding to reduce the impact of the close button */
        }

        .gm-ui-hover-effect {
            top: 10px !important; /* Adjusts the position */
            right: 10px !important; /* Adjusts the position */
            width: 20px !important; /* Adjusts the size */
            height: 20px !important; /* Adjusts the size */
            margin: -5px 0 0 19px !important; /* Applies the custom margin */
        }

    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        <div id="pharmacyListContainer">
            <div id="inputContainer">
            <input type="text" id="zipCode" placeholder="Enter ZIP Code">
                <button onclick="findPharmacies()">Search</button>
                <button id="geolocationButton" onclick="toggleGeolocation()"><img src="i/geo.svg" width="auto" height="22px"></button>
            </div>
            <h3>Nearby Pharmacies</h3>
            <div id="pharmacyList"></div>
        </div>
    </div>

    <script>
        let map;
        let service;
        let infowindow;
        let directionsService;
        let directionsRenderer;
        const markers = [];

        function initializeMap(lat, lng, zoomLevel = 11) {
            const location = new google.maps.LatLng(lat, lng);

            if (!map) {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: location,
                    zoom: zoomLevel
                });

                infowindow = new google.maps.InfoWindow();
                directionsService = new google.maps.DirectionsService();
                directionsRenderer = new google.maps.DirectionsRenderer();
                directionsRenderer.setMap(map);
            } else {
                map.panTo(location);
                map.setZoom(zoomLevel);
            }
        }

        function loadDefaultMap() {
            const phoenixLatLng = { lat: 33.4484, lng: -112.0740 }; // Phoenix, Arizona
            initializeMap(phoenixLatLng.lat, phoenixLatLng.lng);
        }

        function findPharmacies(lat, lng) {
            const location = lat && lng ? new google.maps.LatLng(lat, lng) : null;
            const radius = 4828.03; // 3 miles in meters
            const zoomLevel = 13;

            if (location) {
                initializeMap(lat, lng, zoomLevel);
            } else {
                const zipCode = document.getElementById('zipCode').value;

                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': zipCode }, function(results, status) {
                    if (status == 'OK') {
                        const lat = results[0].geometry.location.lat();
                        const lng = results[0].geometry.location.lng();
                        initializeMap(lat, lng, zoomLevel);
                        searchNearbyPharmacies(lat, lng, radius);
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                });
            }
        }

        function searchNearbyPharmacies(lat, lng, radius) {
            const location = new google.maps.LatLng(lat, lng);
            const request = {
                location: location,
                radius: radius,
                type: ['pharmacy']
            };

            service = new google.maps.places.PlacesService(map);
            service.nearbySearch(request, handleSearchResults);
        }

        function handleSearchResults(results, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                const pharmacyList = document.getElementById('pharmacyList');
                pharmacyList.innerHTML = '';

                results.forEach((place, index) => {
                    const marker = createMarker(place);
                    markers.push(marker);

                    const pharmacyItem = document.createElement('div');
                    pharmacyItem.className = 'pharmacy-item';
                    pharmacyItem.innerHTML = `
                        <strong>${place.name}</strong><br>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.vicinity)}" target="_blank" class="directions-link">Directions</a>
                    `;

                    pharmacyItem.addEventListener('click', () => {
                        map.panTo(marker.getPosition()); // Smoothly pans to the marker's position
                        map.setZoom(15); // Adjust zoom level if needed
                        infowindow.setContent(`
                            <strong>${place.name}</strong><br>
                            ${place.vicinity}<br>
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.vicinity)}" target="_blank" class="directions-link">Directions</a>
                        `);
                        infowindow.open(map, marker);
                    });

                    pharmacyItem.addEventListener('mouseover', () => {
                        marker.setAnimation(google.maps.Animation.BOUNCE);
                    });

                    pharmacyItem.addEventListener('mouseout', () => {
                        marker.setAnimation(null);
                    });

                    pharmacyList.appendChild(pharmacyItem);
                });
            }
        }

        function createMarker(place) {
            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location
            });

            google.maps.event.addListener(marker, 'click', function() {
                infowindow.setContent(`
                    <strong>${place.name}</strong><br>
                    ${place.vicinity}<br>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(place.vicinity)}" target="_blank" class="directions-link">Directions</a>
                `);
                infowindow.open(map, this);
                map.panTo(marker.getPosition()); // Smoothly pans to the marker's position
            });

            return marker;
        }

        function useGeolocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    findPharmacies(lat, lng);
                }, () => {
                    alert('Geolocation failed. Please try again.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        // Load the default map centered on Phoenix, AZ
        window.onload = loadDefaultMap;
    </script>
</body>
</html>
