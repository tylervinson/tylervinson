<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Upload Project - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#5B9A9E",
                        "primary-dark": "#4A8287",
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Upload New Project</h1>
                <p class="text-gray-600">Add a PDF to your portfolio</p>
            </div>

            <!-- Upload Form -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <form id="uploadForm" class="space-y-6">
                    <div>
                        <label for="projectTitle" class="block text-sm font-semibold text-gray-700 mb-2">
                            Project Title *
                        </label>
                        <input 
                            type="text" 
                            id="projectTitle" 
                            required
                            placeholder="e.g., Research on Neural Networks"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition"
                        />
                    </div>
                    
                    <div>
                        <label for="projectDesc" class="block text-sm font-semibold text-gray-700 mb-2">
                            Description *
                        </label>
                        <textarea 
                            id="projectDesc" 
                            required 
                            rows="4"
                            placeholder="Describe what this project is about..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition resize-none"
                        ></textarea>
                    </div>
                    
                    <div>
                        <label for="projectTags" class="block text-sm font-semibold text-gray-700 mb-2">
                            Tags (comma-separated)
                        </label>
                        <input 
                            type="text" 
                            id="projectTags"
                            placeholder="e.g., Python, Machine Learning, Research"
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition"
                        />
                        <p class="text-xs text-gray-500 mt-1">Optional - separate multiple tags with commas.</p>
                    </div>
                    
                    <div>
                        <label for="pdfFile" class="block text-sm font-semibold text-gray-700 mb-2">
                            PDF File *
                        </label>
                        <div class="relative">
                            <input 
                                type="file" 
                                id="pdfFile" 
                                accept=".pdf" 
                                required
                                class="w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer
                                       file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 
                                       file:text-sm file:font-semibold file:bg-primary file:text-white
                                       hover:file:bg-primary-dark file:cursor-pointer
                                       hover:border-primary transition"
                            />
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Maximum file size: 10MB</p>
                    </div>

                    <!-- Status Messages -->
                    <div id="uploadStatus" class="hidden rounded-lg p-4"></div>

                    <!-- Progress Bar -->
                    <div id="progressContainer" class="hidden">
                        <div class="mb-2 flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-700" id="progressText">Uploading...</span>
                            <span class="text-sm font-medium text-gray-700" id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <button 
                        type="submit" 
                        id="uploadBtn"
                        class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-4 px-6 rounded-lg 
                               transition-all duration-200 shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed
                               flex items-center justify-center gap-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <span id="uploadBtnText">Upload to Portfolio</span>
                    </button>
                </form>

                <!-- Success Message -->
                <div id="successMessage" class="hidden mt-6 p-6 bg-green-50 border border-green-200 rounded-lg">
                    <div class="flex items-start gap-3">
                        <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-green-900 mb-1">Upload Successful! üéâ</h3>
                            <p class="text-green-700 text-sm mb-3">Your project has been added to the portfolio.</p>
                            <button 
                                onclick="resetForm()" 
                                class="text-sm font-medium text-green-700 hover:text-green-800 underline"
                            >
                                Upload Another Project
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Link back to portfolio -->
            <div class="text-center mt-6">
                <a href="morgan-vinson-portfolio.html" class="text-sm text-gray-600 hover:text-primary transition">
                    ‚Üê Back to Portfolio
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // =================================================================
        // GITHUB CONFIGURATION - UPDATE THESE VALUES
        // =================================================================
        const GITHUB_CONFIG = {
            token: 'YOUR_GITHUB_TOKEN_HERE',           // Replace with your actual token
            repo: 'username/repo-name',                 // Replace with your repo (e.g., 'morganvinson/portfolio')
            branch: 'main'                              // Usually 'main' or 'gh-pages'
        };
        // =================================================================

        // Form submission handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate GitHub config
            if (GITHUB_CONFIG.token === 'YOUR_GITHUB_TOKEN_HERE' || GITHUB_CONFIG.repo === 'username/repo-name') {
                showStatus('‚ö†Ô∏è GitHub configuration is not set up. Please edit the admin-upload.html file and add your GitHub credentials.', 'error');
                return;
            }
            
            const title = document.getElementById('projectTitle').value;
            const description = document.getElementById('projectDesc').value;
            const tags = document.getElementById('projectTags').value;
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a PDF file', 'error');
                return;
            }

            // Check file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('File is too large. Maximum size is 10MB.', 'error');
                return;
            }
            
            // Disable form
            const submitBtn = document.getElementById('uploadBtn');
            submitBtn.disabled = true;
            document.getElementById('uploadForm').classList.add('opacity-50', 'pointer-events-none');
            
            try {
                await uploadToGitHub(file, title, description, tags);
            } catch (error) {
                showStatus('Upload failed: ' + error.message, 'error');
                console.error('Upload error:', error);
            } finally {
                submitBtn.disabled = false;
                document.getElementById('uploadForm').classList.remove('opacity-50', 'pointer-events-none');
            }
        });

        async function uploadToGitHub(file, title, description, tags) {
            updateProgress(0, 'Reading PDF file...');
            
            // Convert file to base64
            const pdfBase64 = await fileToBase64(file);
            const pdfContent = pdfBase64.split(',')[1];
            
            updateProgress(25, 'Generating thumbnail...');
            
            // Generate thumbnail
            const thumbnail = await generatePDFThumbnail(file);
            
            // Create safe filenames
            const timestamp = Date.now();
            const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
            const pdfPath = `pdfs/${timestamp}_${safeName}`;
            
            updateProgress(40, 'Uploading PDF to repository...');
            
            // Upload PDF
            await uploadFileToGitHub(pdfPath, pdfContent, `Add PDF: ${title}`);
            
            // Upload thumbnail
            let thumbnailPath = null;
            if (thumbnail) {
                updateProgress(60, 'Uploading thumbnail...');
                thumbnailPath = `thumbnails/${timestamp}_${safeName.replace('.pdf', '.jpg')}`;
                const thumbnailContent = thumbnail.split(',')[1];
                await uploadFileToGitHub(thumbnailPath, thumbnailContent, `Add thumbnail for: ${title}`);
            }
            
            updateProgress(80, 'Updating projects list...');
            
            // Create project object
            const project = {
                id: timestamp,
                title: title,
                description: description,
                tags: tags ? tags.split(',').map(t => t.trim()) : ['PDF'],
                pdfUrl: pdfPath,
                thumbnailUrl: thumbnailPath,
                uploadDate: new Date().toISOString().split('T')[0]
            };
            
            // Update projects.json
            await updateProjectsJSON(project);
            
            updateProgress(100, 'Complete!');
            
            // Show success
            setTimeout(() => {
                document.getElementById('progressContainer').classList.add('hidden');
                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('uploadForm').classList.add('hidden');
            }, 500);
        }

        async function uploadFileToGitHub(path, content, message) {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/${path}`;
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    content: content,
                    branch: GITHUB_CONFIG.branch
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`GitHub API error: ${error.message || response.statusText}`);
            }
            
            return await response.json();
        }

        async function updateProjectsJSON(newProject) {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.repo}/contents/projects.json`;
            
            let currentSHA = null;
            let currentProjects = [];
            
            // Get current file
            try {
                const response = await fetch(url + `?ref=${GITHUB_CONFIG.branch}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentSHA = data.sha;
                    const content = atob(data.content);
                    currentProjects = JSON.parse(content);
                }
            } catch (e) {
                // File doesn't exist yet
            }
            
            // Add new project
            currentProjects.push(newProject);
            
            // Upload updated file
            const newContent = btoa(JSON.stringify(currentProjects, null, 2));
            
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: `Add project: ${newProject.title}`,
                    content: newContent,
                    sha: currentSHA,
                    branch: GITHUB_CONFIG.branch
                })
            });
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(`Failed to update projects.json: ${error.message}`);
            }
        }

        async function generatePDFThumbnail(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1);
                
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({ canvasContext: context, viewport }).promise;
                return canvas.toDataURL('image/jpeg', 0.8);
            } catch (error) {
                console.error('Thumbnail generation failed:', error);
                return null;
            }
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateProgress(percent, text) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            const percentText = document.getElementById('progressPercent');
            const progressText = document.getElementById('progressText');
            
            container.classList.remove('hidden');
            bar.style.width = percent + '%';
            percentText.textContent = percent + '%';
            progressText.textContent = text;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            
            const colors = {
                success: 'bg-green-50 text-green-800 border border-green-200',
                error: 'bg-red-50 text-red-800 border border-red-200',
                info: 'bg-blue-50 text-blue-800 border border-blue-200'
            };
            
            statusDiv.className = `p-4 rounded-lg ${colors[type] || colors.info}`;
            statusDiv.textContent = message;
            statusDiv.classList.remove('hidden');
            
            if (type !== 'info') {
                setTimeout(() => {
                    statusDiv.classList.add('hidden');
                }, 7000);
            }
        }

        function resetForm() {
            document.getElementById('uploadForm').reset();
            document.getElementById('uploadForm').classList.remove('hidden');
            document.getElementById('successMessage').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('uploadStatus').classList.add('hidden');
        }
    </script>
</body>
</html>
