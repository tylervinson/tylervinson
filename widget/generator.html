<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Code Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      font-weight: 400;
      line-height: 1.6;
      padding-bottom: 48px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 80px 40px;
    }

    /* ── HEADER ── */
    header {
      position: relative;
      margin-bottom: 60px;
    }
    header h1 {
      font-size: 56px;
      font-weight: 600;
      letter-spacing: -1.5px;
      color: #fff;
      margin-bottom: 12px;
    }
    .subtitle {
      font-size: 18px;
      color: #999;
      font-weight: 400;
      margin-bottom: 32px;
    }
    .version-badge {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .header-actions {
      position: absolute;
      bottom: 0;
      right: 0;
    }

    /* ── TAB NAV ── */
    .tab-nav {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 0;
    }
    .tab-nav-link {
      padding: 12px 20px;
      text-decoration: none;
      color: #666;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: color 0.2s;
    }
    .tab-nav-link:hover { color: #999; }
    .tab-nav-link.active { color: #fff; border-bottom-color: #FFBE5F; }

    /* ── LAYOUT ── */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    /* ── PANELS ── */
    .panel {
      background: #242424;
      padding: 30px;
      border: 1px solid #333;
    }
    .panel-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #999;
    }

    /* ── INNER TABS ── */
    .tab-row {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 24px;
    }
    .tab {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      cursor: pointer;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: inherit;
    }
    .tab:hover { color: #999; background: none; }
    .tab.active { color: #fff; border-bottom-color: #FFBE5F; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ── FORMS ── */
    .form-group { margin-bottom: 20px; }
    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      background: #1a1a1a;
      color: #e0e0e0;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #FFBE5F;
    }
    textarea {
      resize: vertical;
      font-family: 'Courier New', monospace;
      line-height: 1.5;
    }
    input::placeholder, textarea::placeholder { color: #555; }
    .field-hint {
      font-size: 11px;
      color: #555;
      margin-top: 4px;
    }

    /* ── BUTTONS ── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s;
    }
    .btn-primary { background: #FFBE5F; color: #1a1a1a; }
    .btn-primary:hover { background: #FFD699; }
    .btn-outline {
      background: transparent;
      color: #999;
      border: 1px solid #444;
    }
    .btn-outline:hover { border-color: #666; color: #ccc; background: transparent; }
    .btn-sm { padding: 8px 14px; font-size: 12px; }
    .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 24px; }

    /* ── NOTICES ── */
    .notice {
      padding: 14px 16px;
      border-radius: 6px;
      font-size: 13px;
      margin-bottom: 16px;
      line-height: 1.7;
    }
    .notice code {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      background: rgba(0,0,0,0.3);
      color: #FFBE5F;
      padding: 1px 5px;
      border: 1px solid rgba(255,190,95,0.2);
      border-radius: 3px;
    }
    .notice-info { background: #1e2a3a; color: #90bce8; border: 1px solid #2a4060; }
    .notice-success { background: #1a2e1c; color: #7dbf82; border: 1px solid #2a5030; }
    .notice-warn { background: #2e2510; color: #c8a55a; border: 1px solid #504020; }
    .notice-err { background: #2e1a1a; color: #e57373; border: 1px solid #502020; }

    /* ── ANALYSIS RESULT ── */
    .analysis-box {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 16px;
      margin-top: 12px;
    }
    .analysis-box h4 {
      font-size: 11px;
      font-weight: 500;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      margin-bottom: 12px;
    }
    .field-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #222;
      font-size: 13px;
    }
    .field-row:last-child { border-bottom: none; }
    .field-name {
      font-family: 'Courier New', monospace;
      color: #FFBE5F;
      font-size: 12px;
    }
    .field-type {
      font-size: 11px;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* ── WIDGET REGISTRY ITEMS ── */
    .widget-item {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: border-color 0.2s;
    }
    .widget-item:hover { border-color: #444; }
    .widget-item-name { font-size: 14px; color: #e0e0e0; }
    .widget-item-meta { font-size: 11px; color: #555; margin-top: 2px; }
    .widget-item-actions { flex-shrink: 0; margin-left: 12px; }

    /* ── OUTPUT PANEL ── */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #444;
    }
    .empty-state p { font-size: 13px; line-height: 1.7; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 14px;
      text-align: center;
    }
    .stat-box-value { font-size: 24px; font-weight: 600; color: #FFBE5F; }
    .stat-box-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 3px; }

    .output-section { margin-bottom: 24px; }
    .output-section-title {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
      margin-bottom: 8px;
    }

    .field-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      margin: 3px;
      color: #ccc;
      font-family: 'Courier New', monospace;
    }
    .field-tag .dot { width: 6px; height: 6px; border-radius: 50%; background: #FFBE5F; flex-shrink: 0; }
    .field-list { display: flex; flex-wrap: wrap; gap: 4px; }

    .code-block {
      position: relative;
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 6px;
      margin-top: 8px;
    }
    .code-block pre {
      margin: 0;
      padding: 16px;
      padding-right: 48px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-all;
      color: #ccc;
      max-height: 320px;
      overflow-y: auto;
    }
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #2a2a2a;
      color: #888;
      border: 1px solid #3a3a3a;
      border-radius: 4px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: all 0.2s;
      font-size: 11px;
      font-family: inherit;
      text-transform: none;
      letter-spacing: 0;
    }
    .copy-btn:hover { background: #333; color: #ccc; }

    hr { border: none; border-top: 1px solid #2a2a2a; margin: 20px 0; }

    /* ── STATUS BAR ── */
    .status-bar {
      background: #242424;
      border-top: 1px solid #333;
      padding: 10px 40px;
      font-size: 11px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 8px;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
    }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #3a3a3a; flex-shrink: 0; }
    .status-dot.ok  { background: #4caf50; }
    .status-dot.warn { background: #FFBE5F; }
    .status-dot.err  { background: #f44336; }

    code {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      background: #1a1a1a;
      color: #FFBE5F;
      padding: 2px 6px;
      border: 1px solid #333;
      border-radius: 3px;
    }

    @media (max-width: 1024px) {
      .layout { grid-template-columns: 1fr; }
      .container { padding: 40px 20px; }
      header h1 { font-size: 36px; }
    }
  </style>
</head>
<body>

<div class="container">

  <header>
    <div class="version-badge" id="extVersion">v4</div>
    <h1>Code Generator</h1>
    <p class="subtitle">Generate a complete Chrome extension from your widget HTML</p>

    <nav class="tab-nav">
      <a href="overview.html" class="tab-nav-link">Extension Overview</a>
      <a href="workflow.html" class="tab-nav-link">Widget Workflow</a>
      <a href="generator.html" class="tab-nav-link active">Code Generator</a>
    </nav>

    <div class="header-actions" style="display:flex;gap:8px;align-items:center">
      <span id="registrySource" style="font-size:11px;color:#555"></span>
      <button class="btn btn-outline btn-sm" onclick="importRegistry()">Import Registry</button>
      <button class="btn btn-outline btn-sm" onclick="exportRegistry()">Export Registry</button>
      <button class="btn btn-outline btn-sm" onclick="clearAllWidgets()">Reset</button>
    </div>
    <input type="file" id="registryFileInput" accept=".json" style="display:none" onchange="handleRegistryFile(event)">
  </header>

  <div class="layout">

    <!-- LEFT PANEL -->
    <div class="panel">
      <div class="panel-title">Widget Configuration</div>

      <div class="tab-row">
        <button class="tab active" onclick="switchTab('generate')">Generate Widget</button>
        <button class="tab" onclick="switchTab('registry')">Widget Registry</button>
      </div>

      <!-- GENERATE TAB -->
      <div class="tab-content active" id="tab-generate">

        <div class="notice notice-info" style="margin-bottom:24px">
          <strong style="color:#90bce8;display:block;margin-bottom:6px">How it works</strong>
          Paste your widget HTML with <code>data-item-id</code> on each repeating element and <code>data-*</code> attributes holding the field values. The generator reads your structure as-is, registers the widget, and downloads a complete installable extension ZIP — no manual editing required.
        </div>

        <div class="form-group">
          <label>Widget Class <span style="color:#f44336">*</span></label>
          <input type="text" id="widgetClass" placeholder="e.g. insurance-comparison-tool" oninput="onClassInput()">
          <div class="field-hint">The CSS class on the widget's outermost container element</div>
        </div>

        <div class="form-group">
          <label>Widget Display Name <span style="color:#f44336">*</span></label>
          <input type="text" id="widgetName" placeholder="e.g. Insurance Plan Comparison">
        </div>

        <div class="form-group">
          <label>Description</label>
          <input type="text" id="widgetDesc" placeholder="e.g. Edit plan prices, deductibles and coverage details">
        </div>

        <hr>

        <div class="form-group">
          <label>Widget HTML</label>
          <textarea id="widgetHTML" rows="14" placeholder="Paste your widget HTML here.

The generator accepts two formats:

1. Raw HTML with item-* classes on field elements (recommended):
   The generator reads item-target, item-text etc. and writes
   data-item-id and data-* attributes automatically.

2. Pre-annotated HTML with data-item-id and data-* already in place:
   Passed through as-is.

Either way you get back annotated HTML ready for Sitecore
plus a complete installable extension ZIP." oninput="liveAnalyze()"></textarea>
        </div>

        <div id="analysisResult"></div>

        <div class="btn-row">
          <button class="btn btn-primary" onclick="generate()">Generate Extension ZIP</button>
          <button class="btn btn-outline" onclick="clearForm()">Clear</button>
        </div>

        <div id="generateStatus" style="margin-top:16px"></div>

      </div>

      <!-- REGISTRY TAB -->
      <div class="tab-content" id="tab-registry">
        <div id="registryList"></div>
        <div style="margin-top:16px;display:flex;flex-direction:column;gap:10px">
          <div class="notice notice-info" style="font-size:12px">
            Every widget in the registry is included in each generated ZIP. The version number lives in <code>widget-registry.json</code> — import it to restore your full registry on any machine.
          </div>
          <button class="btn btn-outline" style="width:100%" onclick="importRegistry()">Import widget-registry.json</button>
        </div>
      </div>

    </div>

    <!-- RIGHT PANEL -->
    <div class="panel">
      <div class="panel-title">Output</div>
      <div id="outputPanel">
        <div class="empty-state">
          <p>Paste your widget HTML on the left and click <strong style="color:#ccc">Generate Extension ZIP</strong> to produce a complete, installable Chrome extension.</p>
        </div>
      </div>
    </div>

  </div>

</div>

<div class="status-bar">
  <div class="status-dot" id="statusDot"></div>
  <span id="statusText">Ready</span>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const REGISTRY_URL = 'https://www.tylervinson.com/widget/widget-registry.json';
const DOWNLOAD_URL = 'https://www.tylervinson.com/widget/';

// ============================================================
// REGISTRY — in-memory, sourced from widget-registry.json
// ============================================================
let _registry = { version: '1.0.0', widgets: [], updatedAt: null };

function getRegistry()  { return _registry.widgets; }
function getVersion()   { return _registry.version; }

function saveRegistry(widgets) {
  _registry.widgets = widgets;
  // Recalculate version: 1.{widgetCount}.{totalFieldCount}
  const fieldTotal = widgets.reduce((sum, w) => sum + (w.fields ? w.fields.length : 0), 0);
  _registry.version = '1.' + widgets.length + '.' + fieldTotal;
  _registry.updatedAt = new Date().toISOString();
}

function getRegistryJSON() {
  return JSON.stringify({
    version: _registry.version,
    updatedAt: _registry.updatedAt || new Date().toISOString(),
    downloadUrl: DOWNLOAD_URL,
    widgets: _registry.widgets
  }, null, 2);
}

// ============================================================
// IMPORT / EXPORT
// ============================================================
function importRegistry() {
  document.getElementById('registryFileInput').click();
}

function handleRegistryFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.widgets || !Array.isArray(data.widgets)) throw new Error('Invalid registry format');
      _registry.widgets   = data.widgets;
      _registry.version   = data.version || '1.' + data.widgets.length + '.0';
      _registry.updatedAt = data.updatedAt || null;
      updateVersionBadge();
      renderRegistry();
      setStatus('Registry loaded — ' + data.widgets.length + ' widget(s)', 'ok');
      document.getElementById('registrySource').textContent = 'Loaded from file';
      // Reset file input so same file can be re-imported
      event.target.value = '';
    } catch(err) {
      setStatus('Invalid registry file: ' + err.message, 'err');
    }
  };
  reader.readAsText(file);
}

function exportRegistry() {
  if (_registry.widgets.length === 0) {
    setStatus('Nothing to export — generate a widget first', 'warn');
    return;
  }
  const blob = new Blob([getRegistryJSON()], { type: 'application/json' });
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = 'widget-registry.json';
  a.click();
  URL.revokeObjectURL(url);
  setStatus('Registry exported', 'ok');
}

function clearAllWidgets() {
  if (!confirm('Reset the registry? This clears all widgets from memory.')) return;
  _registry = { version: '1.0.0', widgets: [], updatedAt: null };
  updateVersionBadge();
  renderRegistry();
  setStatus('Registry reset', 'warn');
}

// Try loading registry from GitHub Pages on startup
async function fetchRemoteRegistry() {
  try {
    const res = await fetch(REGISTRY_URL + '?cb=' + Date.now());
    if (!res.ok) return;
    const data = await res.json();
    if (!data.widgets || !Array.isArray(data.widgets)) return;
    _registry.widgets   = data.widgets;
    _registry.version   = data.version || '1.' + data.widgets.length + '.0';
    _registry.updatedAt = data.updatedAt || null;
    updateVersionBadge();
    renderRegistry();
    setStatus('Registry synced from tylervinson.com', 'ok');
    document.getElementById('registrySource').textContent = 'Synced from tylervinson.com';
  } catch(e) {
    // Silent fail — user can import manually
    document.getElementById('registrySource').textContent = 'Import registry to restore';
  }
}

// ============================================================
// UI HELPERS
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', (i === 0 && name === 'generate') || (i === 1 && name === 'registry'));
  });
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
  if (name === 'registry') renderRegistry();
}

function setStatus(msg, type) {
  document.getElementById('statusDot').className = 'status-dot' + (type ? ' ' + type : '');
  document.getElementById('statusText').textContent = msg;
}

function updateVersionBadge() {
  document.getElementById('extVersion').textContent = 'Generator v4 · ext ' + getVersion();
}

function onClassInput() {
  const val = document.getElementById('widgetClass').value.trim();
  const nameEl = document.getElementById('widgetName');
  if (!nameEl.value) {
    nameEl.value = val.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }
}

function clearForm() {
  ['widgetClass', 'widgetName', 'widgetDesc', 'widgetHTML'].forEach(id => {
    document.getElementById(id).value = '';
  });
  document.getElementById('analysisResult').innerHTML = '';
  document.getElementById('generateStatus').innerHTML = '';
  document.getElementById('outputPanel').innerHTML = `
    <div class="empty-state">
      <p>Paste your widget HTML on the left and click <strong style="color:#ccc">Generate Extension ZIP</strong> to produce a complete, installable Chrome extension.</p>
    </div>`;
  setStatus('Ready');
}

// clearAllWidgets defined in registry section above

// ============================================================
// HTML ANALYSIS — reads data-item-id and data-* as-is
// ============================================================
// ============================================================
// ANNOTATE — transforms raw HTML into generator-ready HTML
// Uses item-* classes as the signal for field names/values
// Also accepts already-annotated HTML (data-item-id present)
// ============================================================
function annotateHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const root = doc.body.firstElementChild;
  if (!root) return null;

  // ── Already annotated? Pass through. ──────────────────────
  const existingItems = root.querySelectorAll('[data-item-id]');
  if (existingItems.length > 0) {
    return { annotated: root.outerHTML, fromExisting: true };
  }

  // ── Detect repeating items via item-* classes ──────────────
  // Find all elements that have at least one item-* class
  const itemClassEls = Array.from(root.querySelectorAll('*')).filter(el =>
    Array.from(el.classList).some(c => c.startsWith('item-'))
  );

  if (itemClassEls.length === 0) {
    // No item-* classes found — try single widget via data-* on root
    return { annotated: root.outerHTML, fromExisting: false, noItems: true };
  }

  // Walk up from item-class elements to find the repeating parent
  // The repeating parent is the closest ancestor that appears multiple times
  // at the same level (same parent, same tag)
  function findRepeatingParent(els) {
    // Collect all ancestors up to root
    const candidates = new Map(); // element -> count of item-class descendants
    els.forEach(el => {
      let node = el.parentElement;
      while (node && node !== root) {
        candidates.set(node, (candidates.get(node) || 0) + 1);
        node = node.parentElement;
      }
    });

    // Find elements that are direct children of the same parent
    // and appear more than once with the same tag
    const parentGroups = new Map();
    Array.from(root.children).forEach(child => {
      const key = child.tagName;
      if (!parentGroups.has(key)) parentGroups.set(key, []);
      parentGroups.get(key).push(child);
    });

    // Direct children repeated = definite repeating items
    for (const [tag, group] of parentGroups) {
      if (group.length > 1) return group;
    }

    // Otherwise go one level deeper
    for (const child of root.children) {
      const subGroups = new Map();
      Array.from(child.children).forEach(grandchild => {
        const key = grandchild.tagName;
        if (!subGroups.has(key)) subGroups.set(key, []);
        subGroups.get(key).push(grandchild);
      });
      for (const [tag, group] of subGroups) {
        if (group.length > 1) return group;
      }
    }

    return null;
  }

  const repeatingItems = findRepeatingParent(itemClassEls);
  if (!repeatingItems || repeatingItems.length === 0) {
    return { annotated: root.outerHTML, fromExisting: false, noItems: true };
  }

  // ── Extract fields from first item's item-* classes ────────
  const firstItem = repeatingItems[0];
  const fieldNames = [];
  firstItem.querySelectorAll('*').forEach(el => {
    el.classList.forEach(cls => {
      if (cls.startsWith('item-')) {
        const field = cls.replace('item-', '');
        if (!fieldNames.includes(field)) fieldNames.push(field);
      }
    });
  });

  // ── Annotate each repeating item ───────────────────────────
  repeatingItems.forEach((item, idx) => {
    item.setAttribute('data-item-id', String(idx + 1));

    fieldNames.forEach(field => {
      // Find the visible element with this item-* class
      const visibleEl = item.querySelector('.item-' + field);
      if (!visibleEl) return;

      // Extract value — for links use href, for images use src, otherwise text
      let value = '';
      const tag = visibleEl.tagName.toLowerCase();
      if (tag === 'a') {
        value = visibleEl.getAttribute('href') || visibleEl.textContent.trim();
      } else if (tag === 'img') {
        value = visibleEl.getAttribute('src') || visibleEl.getAttribute('alt') || '';
      } else if (visibleEl.hasAttribute('data-' + field)) {
        // Already has a matching data attribute — use that value
        value = visibleEl.getAttribute('data-' + field);
      } else {
        // Use text content, stripping child element text we don't want
        // Clone and remove child elements that are purely decorative (span.percent-symbol etc)
        const clone = visibleEl.cloneNode(true);
        clone.querySelectorAll('span, sup, sub').forEach(s => {
          // Only remove if it looks decorative (single char or symbol-like content)
          if (s.textContent.trim().length <= 2) s.remove();
        });
        value = clone.textContent.trim();
      }

      item.setAttribute('data-' + field, value);
    });
  });

  return { annotated: formatHTML(root.outerHTML), fields: fieldNames, itemCount: repeatingItems.length };
}

// ============================================================
// ANALYZE — reads annotated HTML to extract field/item info
// ============================================================
function analyzeHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const root = doc.body.firstElementChild;
  if (!root) return { error: 'No root element found. Make sure your HTML has a single outer container.' };

  const items = root.querySelectorAll('[data-item-id]');
  const hasItems = items.length > 0;

  if (!hasItems) {
    const fields = [];
    Array.from(root.attributes).forEach(attr => {
      if (attr.name.startsWith('data-') && attr.name !== 'data-widget-detected') {
        fields.push(attr.name.replace('data-', ''));
      }
    });
    return {
      hasItems: false,
      itemCount: 1,
      fields,
      widgetClass: root.className.split(' ')[0] || ''
    };
  }

  const firstItem = items[0];
  const fields = [];
  Array.from(firstItem.attributes).forEach(attr => {
    if (attr.name.startsWith('data-') && attr.name !== 'data-item-id') {
      fields.push(attr.name.replace('data-', ''));
    }
  });

  if (fields.length === 0) {
    return { error: 'Found elements with data-item-id but no data-* field attributes. Make sure your repeating items have data-* attributes or item-* classes.' };
  }

  return {
    hasItems: true,
    itemCount: items.length,
    fields,
    widgetClass: root.className.split(' ').filter(c => c && c !== 'editable-widget')[0] || ''
  };
}

// ============================================================
// LIVE ANALYSIS — runs on paste/type
// ============================================================
function liveAnalyze() {
  const html = document.getElementById('widgetHTML').value.trim();
  const container = document.getElementById('analysisResult');
  if (!html) { container.innerHTML = ''; return; }

  // Try annotating first to get accurate field info
  const annotation = annotateHTML(html);
  const htmlToAnalyze = (annotation && annotation.annotated) ? annotation.annotated : html;
  const result = analyzeHTML(htmlToAnalyze);

  if (result.error) {
    container.innerHTML = `<div class="notice notice-warn" style="margin-top:12px">${result.error}</div>`;
    return;
  }

  const fieldTags = result.fields.map(f =>
    `<span class="field-tag"><span class="dot"></span>data-${f}</span>`
  ).join('');

  const wasAnnotated = annotation && !annotation.fromExisting && annotation.fields && annotation.fields.length > 0;

  container.innerHTML = `
    <div class="analysis-box" style="margin-top:12px">
      <h4>Detected Structure</h4>
      <div class="field-row">
        <span class="field-name">Type</span>
        <span class="field-type">${result.hasItems ? 'Items-based (' + result.itemCount + ' item' + (result.itemCount !== 1 ? 's' : '') + ')' : 'Single widget'}</span>
      </div>
      <div class="field-row">
        <span class="field-name">Fields</span>
        <span class="field-type">${result.fields.length} found${wasAnnotated ? ' via item-* classes' : ''}</span>
      </div>
      <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:4px">
        ${fieldTags || '<span style="color:#555;font-size:12px">No fields detected</span>'}
      </div>
    </div>`;
}

// ============================================================
// MAIN GENERATE
// ============================================================
function generate() {
  const widgetClass = document.getElementById('widgetClass').value.trim();
  const widgetName  = document.getElementById('widgetName').value.trim();
  const widgetDesc  = document.getElementById('widgetDesc').value.trim();
  const rawHTML     = document.getElementById('widgetHTML').value.trim();

  const statusEl = document.getElementById('generateStatus');

  if (!widgetClass || !widgetName) {
    statusEl.innerHTML = `<div class="notice notice-warn">Widget Class and Widget Name are required.</div>`;
    return;
  }
  if (!rawHTML) {
    statusEl.innerHTML = `<div class="notice notice-warn">Please paste your widget HTML.</div>`;
    return;
  }

  // Step 1: Annotate (or pass through if already annotated)
  const annotation = annotateHTML(rawHTML);
  if (!annotation) {
    statusEl.innerHTML = '<div class="notice notice-err">Could not parse HTML. Make sure it has a single root element.</div>';
    return;
  }
  const annotatedHTML = annotation.annotated;

  // Step 2: Analyze annotated HTML
  const analysis = analyzeHTML(annotatedHTML);
  if (analysis.error) {
    statusEl.innerHTML = '<div class="notice notice-err">' + analysis.error + '</div>';
    return;
  }

  setStatus('Building extension...', 'warn');
  statusEl.innerHTML = '';

  // Step 3: Register/update widget
  let reg = getRegistry();
  const idx = reg.findIndex(w => w.class === widgetClass);
  const entry = {
    class: widgetClass,
    name: widgetName,
    desc: widgetDesc,
    hasItems: analysis.hasItems,
    fields: analysis.fields,
    date: new Date().toLocaleDateString()
  };
  if (idx >= 0) reg[idx] = entry;
  else reg.push(entry);
  saveRegistry(reg);
  updateVersionBadge();

  const version = getVersion();

  // Step 4: Show output including annotated HTML
  showOutput(analysis, version, annotatedHTML, annotation.fromExisting);

  // Step 5: Build and download ZIP
  buildZip(reg, version, annotatedHTML).then(() => {
    statusEl.innerHTML = '<div class="notice notice-success">'
      + '<strong style="display:block;margin-bottom:4px">Extension downloaded — sitecore-widget-editor-' + version + '.zip</strong>'
      + 'Unzip → chrome://extensions → Developer mode → Load unpacked → select the folder.'
      + '</div>';
    setStatus('Done · ' + version, 'ok');
  }).catch(err => {
    statusEl.innerHTML = '<div class="notice notice-err">ZIP error: ' + err.message + '</div>';
    setStatus('Error', 'err');
  });
}

// ============================================================
// OUTPUT PANEL
// ============================================================
function showOutput(analysis, version, annotatedHTML, fromExisting) {
  const fieldTags = analysis.fields.map(f =>
    '<span class="field-tag"><span class="dot"></span>data-' + f + '</span>'
  ).join('');

  const escapedHTML = annotatedHTML
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  const annotationNote = fromExisting
    ? '<span style="color:#555;font-size:11px">Passed through — already annotated</span>'
    : '<span style="color:#7dbf82;font-size:11px">Annotated from item-* classes</span>';

  document.getElementById('outputPanel').innerHTML =
    '<div class="stats-grid">'
    + '<div class="stat-box"><div class="stat-box-value">' + analysis.itemCount + '</div><div class="stat-box-label">' + (analysis.hasItems ? 'Items' : 'Widget') + '</div></div>'
    + '<div class="stat-box"><div class="stat-box-value">' + analysis.fields.length + '</div><div class="stat-box-label">Fields</div></div>'
    + '<div class="stat-box"><div class="stat-box-value">' + version + '</div><div class="stat-box-label">Ext Version</div></div>'
    + '</div>'

    + '<div class="output-section">'
    + '<div class="output-section-title">Fields</div>'
    + '<div class="field-list">' + (fieldTags || '<span style="color:#555;font-size:12px">None</span>') + '</div>'
    + '</div>'

    + '<div class="output-section">'
    + '<div class="output-section-title" style="display:flex;justify-content:space-between;align-items:center">'
    + '<span>Annotated HTML — copy into Sitecore</span>' + annotationNote
    + '</div>'
    + '<div class="code-block">'
    + '<button class="copy-btn" onclick="copyAnnotatedHTML()" title="Copy">&#10064;</button>'
    + '<pre id="annotatedHTMLOut">' + escapedHTML + '</pre>'
    + '</div>'
    + '</div>'

    + '<div class="output-section">'
    + '<div class="output-section-title">ZIP Contents</div>'
    + '<div class="analysis-box">'
    + '<div class="field-row"><span class="field-name">manifest.json</span><span class="field-type">MV3</span></div>'
    + '<div class="field-row"><span class="field-name">content-script.js</span><span class="field-type">All ' + getRegistry().length + ' widget(s)</span></div>'
    + '<div class="field-row"><span class="field-name">sidepanel.js</span><span class="field-type">Editor UI + update banner</span></div>'
    + '<div class="field-row"><span class="field-name">sidepanel.html</span><span class="field-type">Panel shell</span></div>'
    + '<div class="field-row"><span class="field-name">background.js</span><span class="field-type">Version checker</span></div>'
    + '<div class="field-row"><span class="field-name">sitecore-bridge.js</span><span class="field-type">Change detection</span></div>'
    + '<div class="field-row"><span class="field-name">icon16/48/128.png</span><span class="field-type">Auto-generated</span></div>'
    + '</div>'
    + '</div>'
    + '<div class="output-section">'
    + '<div class="output-section-title" style="display:flex;justify-content:space-between">'
    + '<span>Registry JSON — commit this to GitHub</span>'
    + '<span style="color:#7dbf82;font-size:11px">tylervinson.com/widget/widget-registry.json</span>'
    + '</div>'
    + '<div style="display:flex;gap:8px;margin-top:6px">'
    + '<button class="btn btn-outline" style="flex:1;padding:10px" onclick="exportRegistry()">Download widget-registry.json</button>'
    + '</div>'
    + '</div>';
}

function copyAnnotatedHTML() {
  const el = document.getElementById('annotatedHTMLOut');
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => {
    const btn = document.querySelector('.copy-btn');
    if (!btn) return;
    const orig = btn.innerHTML;
    btn.textContent = 'Copied';
    setTimeout(() => { btn.innerHTML = orig; }, 2000);
  });
}

// ============================================================
// REGISTRY RENDER
// ============================================================
function renderRegistry() {
  const reg = getRegistry();
  const container = document.getElementById('registryList');

  if (reg.length === 0) {
    container.innerHTML = `<div class="empty-state"><p>No widgets registered yet.<br>Generate your first widget to get started.</p></div>`;
    return;
  }

  container.innerHTML = reg.map((w, i) => `
    <div class="widget-item">
      <div style="flex:1">
        <div class="widget-item-name">${w.name}</div>
        <div class="widget-item-meta">.${w.class} &middot; ${w.hasItems ? w.fields.length + ' field(s)' : 'single element'} &middot; ${w.date}</div>
      </div>
      <div class="widget-item-actions">
        <button class="btn btn-outline btn-sm" onclick="removeWidget(${i})">Remove</button>
      </div>
    </div>
  `).join('');
}

function removeWidget(i) {
  const reg = getRegistry();
  reg.splice(i, 1);
  saveRegistry(reg);
  renderRegistry();
  updateVersionBadge();
  setStatus('Widget removed', 'warn');
}

// ============================================================
// ZIP BUILDER
// ============================================================
function buildZip(reg, version, widgetHTML) {
  const zip = new JSZip();
  const folder = zip.folder('sitecore-widget-editor');

  folder.file('manifest.json',      generateManifest(version));
  folder.file('background.js',      generateBackground());
  folder.file('sitecore-bridge.js', generateSitecoreBridge());
  folder.file('content-script.js',  generateContentScript(reg, version));
  folder.file('sidepanel.html',     generateSidepanelHTML());
  folder.file('sidepanel.js',       generateSidepanelJS(reg));
  folder.file('README.txt',         generateReadme(version, reg));

  [16, 48, 128].forEach(size => {
    folder.file('icon' + size + '.png', generateIcon(size), { base64: true });
  });

  return zip.generateAsync({ type: 'blob' }).then(blob => {
    const url = URL.createObjectURL(blob);
    const a   = document.createElement('a');
    a.href     = url;
    a.download = 'sitecore-widget-editor-' + version + '.zip';
    a.click();
    URL.revokeObjectURL(url);
  });
}

// ============================================================
// ICON
// ============================================================
function generateIcon(size) {
  const canvas = document.createElement('canvas');
  canvas.width  = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  ctx.beginPath();
  ctx.arc(size / 2, size / 2, size / 2 - 1, 0, Math.PI * 2);
  ctx.fillStyle = '#FFBE5F';
  ctx.fill();
  ctx.fillStyle = '#1a1a1a';
  ctx.font = `bold ${Math.floor(size * 0.55)}px system-ui, sans-serif`;
  ctx.textAlign    = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('W', size / 2, size / 2 + size * 0.03);
  return canvas.toDataURL('image/png').split(',')[1];
}

// ============================================================
// manifest.json
// ============================================================
function generateManifest(version) {
  return JSON.stringify({
    manifest_version: 3,
    name: 'Sitecore Widget Editor',
    version: version,
    description: 'Edit Sitecore widget content directly from the browser sidebar',
    permissions: ['sidePanel', 'activeTab', 'storage'],
    host_permissions: ['<all_urls>'],
    background: { service_worker: 'background.js' },
    side_panel: { default_path: 'sidepanel.html' },
    action: {
      default_title: 'Sitecore Widget Editor',
      default_icon: { '16': 'icon16.png', '48': 'icon48.png', '128': 'icon128.png' }
    },
    icons: { '16': 'icon16.png', '48': 'icon48.png', '128': 'icon128.png' },
    content_scripts: [{
      matches: ['<all_urls>'],
      js: ['sitecore-bridge.js', 'content-script.js'],
      all_frames: false,
      run_at: 'document_idle'
    }]
  }, null, 2);
}

// ============================================================
// background.js
// ============================================================
function generateBackground() {
  const version = getVersion();
  return [
    '// background.js — Sitecore Widget Editor v' + version,
    '// Checks tylervinson.com/widget/widget-registry.json for updates',
    '',
    "const REGISTRY_URL = 'https://www.tylervinson.com/widget/widget-registry.json';",
    "const CURRENT_VERSION = '" + version + "';",
    "const DOWNLOAD_URL = 'https://www.tylervinson.com/widget/';",
    '',
    'chrome.action.onClicked.addListener((tab) => {',
    '  chrome.sidePanel.open({ tabId: tab.id });',
    '});',
    '',
    'chrome.sidePanel.setPanelBehavior({ openPanelOnActionClick: true }).catch(console.error);',
    '',
    '// ── Version check ──────────────────────────────────────',
    'async function checkForUpdates() {',
    '  try {',
    "    const res = await fetch(REGISTRY_URL + '?cb=' + Date.now());",
    '    if (!res.ok) return;',
    '    const data = await res.json();',
    '    const remoteVersion = data.version || null;',
    '    if (remoteVersion && remoteVersion !== CURRENT_VERSION) {',
    '      chrome.runtime.sendMessage({',
    "        type: 'UPDATE_AVAILABLE',",
    '        currentVersion: CURRENT_VERSION,',
    '        remoteVersion: remoteVersion,',
    '        downloadUrl: DOWNLOAD_URL',
    '      }).catch(() => {});',
    '      // Badge the icon',
    "      chrome.action.setBadgeText({ text: '!' });",
    "      chrome.action.setBadgeBackgroundColor({ color: '#FFBE5F' });",
    '    } else {',
    "      chrome.action.setBadgeText({ text: '' });",
    '    }',
    '  } catch(e) {}',
    '}',
    '',
    '// Check on install/startup and every 4 hours',
    "chrome.runtime.onInstalled.addListener(checkForUpdates);",
    "chrome.runtime.onStartup.addListener(checkForUpdates);",
    'setInterval(checkForUpdates, 4 * 60 * 60 * 1000);',
  ].join('\n');
}

// ============================================================
// sitecore-bridge.js
// ============================================================
function generateSitecoreBridge() {
  return [
    '// sitecore-bridge.js — Notifies Sitecore of DOM changes',
    'window.SitecoreBridge = {',
    '  notifyChange: function(element) {',
    '    if (!element) return;',
    "    ['input', 'change', 'blur'].forEach(evtType => {",
    '      element.dispatchEvent(new Event(evtType, { bubbles: true, cancelable: true }));',
    '    });',
    '    try {',
    '      if (window.tinymce) {',
    '        const editors = window.tinymce.get();',
    '        if (editors && editors.length) {',
    '          editors.forEach(ed => {',
    "            try { ed.setDirty(true); ed.fire('change'); } catch(e) {}",
    '          });',
    '        }',
    '      }',
    '    } catch(e) {}',
    '    try {',
    '      if (window.Sitecore && window.Sitecore.PageModes) {',
    '        if (window.Sitecore.PageModes.ChromeManager) {',
    '          window.Sitecore.PageModes.ChromeManager.resetChromes();',
    '        }',
    "        document.dispatchEvent(new CustomEvent('scEditableChanged', {",
    '          bubbles: true, detail: { element: element }',
    '        }));',
    '      }',
    '    } catch(e) {}',
    '    try {',
    "      const m = element.getAttribute('data-sc-modified') === 'true' ? 'false' : 'true';",
    "      element.setAttribute('data-sc-modified', m);",
    '    } catch(e) {}',
    '  }',
    '};',
  ].join('\n');
}

// ============================================================
// content-script.js
// ============================================================
function generateContentScript(reg, version) {
  const registryEntries = reg.map(w =>
    '  {\n' +
    "    class: '" + w.class + "',\n" +
    "    name: '" + w.name + "',\n" +
    '    hasItems: ' + w.hasItems + ',\n' +
    '    fields: [' + w.fields.map(f => "'" + f + "'").join(', ') + ']\n' +
    '  }'
  ).join(',\n');

  const getRoutes = reg.map(w => {
    const fn = toPascal(w.class);
    return "  if (widgetClass === '" + w.class + "') return get" + fn + "Data(element);";
  }).join('\n');

  const updateRoutes = reg.map(w => {
    const fn = toPascal(w.class);
    return "  if (widgetClass === '" + w.class + "') return update" + fn + "Data(element, data);";
  }).join('\n');

  const widgetFns = reg.map(w => buildWidgetFunctions(w)).join('\n\n');

  return [
    '// content-script.js — Sitecore Widget Editor v' + version,
    '// Auto-generated. Do not edit manually.',
    '',
    '// ============================================================',
    '// WIDGET REGISTRY',
    '// ============================================================',
    'const WIDGET_REGISTRY = [',
    registryEntries,
    '];',
    '',
    '// ============================================================',
    '// DETECT WIDGETS ON PAGE',
    '// ============================================================',
    'function detectWidgets() {',
    '  const found = [];',
    '  WIDGET_REGISTRY.forEach(config => {',
    "    document.querySelectorAll('.' + config.class).forEach((el, idx) => {",
    '      found.push({',
    '        widgetClass: config.class,',
    '        widgetName: config.name,',
    '        hasItems: config.hasItems,',
    '        fields: config.fields,',
    '        index: idx,',
    "        itemCount: config.hasItems ? el.querySelectorAll('[data-item-id]').length : 1",
    '      });',
    '    });',
    '  });',
    '  return found;',
    '}',
    '',
    '// ============================================================',
    '// FIND WIDGET ELEMENT',
    '// ============================================================',
    'function findWidget(widgetClass, index) {',
    "  return document.querySelectorAll('.' + widgetClass)[index] || null;",
    '}',
    '',
    '// ============================================================',
    '// GET WIDGET DATA (router)',
    '// ============================================================',
    'function getWidgetData(widgetClass, index) {',
    '  const element = findWidget(widgetClass, index);',
    '  if (!element) return null;',
    getRoutes,
    '  return null;',
    '}',
    '',
    '// ============================================================',
    '// UPDATE WIDGET DATA (router)',
    '// ============================================================',
    'function updateWidgetData(widgetClass, index, data) {',
    '  const element = findWidget(widgetClass, index);',
    '  if (!element) return false;',
    updateRoutes,
    '  return false;',
    '}',
    '',
    '// ============================================================',
    '// WIDGET IMPLEMENTATIONS',
    '// ============================================================',
    widgetFns,
    '',
    '// ============================================================',
    '// MUTATION OBSERVER',
    '// ============================================================',
    'let _observerTimer = null;',
    'new MutationObserver(() => {',
    '  clearTimeout(_observerTimer);',
    '  _observerTimer = setTimeout(() => {',
    "    chrome.runtime.sendMessage({ type: 'WIDGETS_UPDATED', widgets: detectWidgets() }).catch(() => {});",
    '  }, 500);',
    '}).observe(document.body, { childList: true, subtree: true });',
    '',
    '// ============================================================',
    '// MESSAGE HANDLER',
    '// ============================================================',
    'chrome.runtime.onMessage.addListener((msg, sender, sendResponse) => {',
    "  if (msg.type === 'GET_WIDGETS') {",
    '    sendResponse({ widgets: detectWidgets() });',
    '    return true;',
    '  }',
    "  if (msg.type === 'GET_WIDGET_DATA') {",
    '    sendResponse({ data: getWidgetData(msg.widgetClass, msg.index || 0) });',
    '    return true;',
    '  }',
    "  if (msg.type === 'UPDATE_WIDGET_DATA') {",
    '    sendResponse({ success: updateWidgetData(msg.widgetClass, msg.index || 0, msg.data) });',
    '    return true;',
    '  }',
    '});',
    '',
    '// Initial scan',
    "chrome.runtime.sendMessage({ type: 'WIDGETS_UPDATED', widgets: detectWidgets() }).catch(() => {});",
  ].join('\n');
}

function buildWidgetFunctions(widget) {
  const Fn     = toPascal(widget.class);
  const fields = widget.fields;

  if (!widget.hasItems) {
    // Single-element widget — reads data-* off the root element
    const getLines    = fields.map(f => "    " + f.replace(/-/g, '_') + ": el.getAttribute('data-" + f + "') || ''").join(',\n');
    const updateLines = fields.map(f =>
      "  if (data." + f.replace(/-/g, '_') + " !== undefined) {\n" +
      "    el.setAttribute('data-" + f + "', data." + f.replace(/-/g, '_') + ");\n" +
      "    const v = el.querySelector('.item-" + f + "');\n" +
      "    if (v) v.textContent = data." + f.replace(/-/g, '_') + ";\n" +
      "    if (window.SitecoreBridge) window.SitecoreBridge.notifyChange(el);\n" +
      "  }"
    ).join('\n');

    return [
      '// --- ' + widget.name + ' ---',
      'function get' + Fn + 'Data(el) {',
      '  return {',
      getLines,
      '  };',
      '}',
      '',
      'function update' + Fn + 'Data(el, data) {',
      updateLines,
      '  return true;',
      '}',
    ].join('\n');
  }

  // Items-based widget — reads data-* off each [data-item-id] element
  const getItemLines    = fields.map(f => "      " + f.replace(/-/g, '_') + ": item.getAttribute('data-" + f + "') || ''").join(',\n');
  const updateItemLines = fields.map(f =>
    "    if (d." + f.replace(/-/g, '_') + " !== undefined) {\n" +
    "      item.setAttribute('data-" + f + "', d." + f.replace(/-/g, '_') + ");\n" +
    "      item.querySelectorAll('[data-" + f + "]').forEach(n => n.setAttribute('data-" + f + "', d." + f.replace(/-/g, '_') + "));\n" +
    "      const v = item.querySelector('.item-" + f + "');\n" +
    "      if (v) v.textContent = d." + f.replace(/-/g, '_') + ";\n" +
    "      if (window.SitecoreBridge) window.SitecoreBridge.notifyChange(item);\n" +
    "    }"
  ).join('\n');

  return [
    '// --- ' + widget.name + ' ---',
    'function get' + Fn + 'Data(el) {',
    "  return { items: Array.from(el.querySelectorAll('[data-item-id]')).map(item => ({",
    "    id: item.getAttribute('data-item-id'),",
    getItemLines,
    '  })) };',
    '}',
    '',
    'function update' + Fn + 'Data(el, data) {',
    '  if (!data.items) return false;',
    '  data.items.forEach(d => {',
    "    const item = el.querySelector('[data-item-id=\"' + d.id + '\"]');",
    '    if (!item) return;',
    updateItemLines,
    '  });',
    '  return true;',
    '}',
  ].join('\n');
}

// ============================================================
// sidepanel.html
// ============================================================
function generateSidepanelHTML() {
  return '<!DOCTYPE html>\n' +
    '<html lang="en">\n' +
    '<head>\n' +
    '  <meta charset="UTF-8">\n' +
    '  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
    '  <title>Widget Editor</title>\n' +
    '  <style>\n' +
    '    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }\n' +
    '    body {\n' +
    '      font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', system-ui, sans-serif;\n' +
    '      background: #262c2e; color: #e0e0e0; font-size: 13px;\n' +
    '      line-height: 1.5; height: 100vh;\n' +
    '      display: flex; flex-direction: column; overflow: hidden;\n' +
    '    }\n' +
    '    #header { padding: 12px 14px 10px; border-bottom: 1px solid #343d3f; flex-shrink: 0; }\n' +
    '    #header h1 { font-size: 13px; font-weight: 500; color: #fff; }\n' +
    '    #header .sub { font-size: 11px; color: #666; margin-top: 2px; }\n' +
    '    #content { flex: 1; overflow-y: auto; padding: 12px 14px; }\n' +
    '    #footer { padding: 10px 14px; border-top: 1px solid #343d3f; font-size: 11px; color: #555; flex-shrink: 0; }\n' +
    '    .widget-btn {\n' +
    '      display: block; width: 100%; text-align: left;\n' +
    '      background: #2e3436; border: 1px solid #3d4749;\n' +
    '      border-radius: 4px; padding: 8px 10px; color: #ccc;\n' +
    '      font-size: 12px; cursor: pointer; margin-bottom: 6px;\n' +
    '      transition: all 0.2s ease; font-family: inherit;\n' +
    '    }\n' +
    '    .widget-btn:hover { background: #343d3f; border-color: #FFBE5F; color: #fff; }\n' +
    '    .widget-btn .name { font-weight: 500; color: #fff; }\n' +
    '    .widget-btn .meta { font-size: 11px; color: #666; margin-top: 2px; }\n' +
    '    .form-group { margin-bottom: 10px; }\n' +
    '    .form-group label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }\n' +
    '    .form-group input, .form-group textarea {\n' +
    '      width: 100%; background: #2e3436; border: 1px solid #3d4749;\n' +
    '      border-radius: 3px; padding: 6px 8px; color: #e0e0e0;\n' +
    '      font-size: 12px; font-family: inherit; transition: border-color 0.2s;\n' +
    '    }\n' +
    '    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #FFBE5F; }\n' +
    '    .form-group textarea { resize: vertical; min-height: 60px; }\n' +
    '    .item-card { background: #2e3436; border: 1px solid #3d4749; border-radius: 4px; padding: 10px; margin-bottom: 8px; }\n' +
    '    .item-card-header { font-size: 11px; color: #FFBE5F; font-weight: 500; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }\n' +
    '    .btn-row { display: flex; gap: 8px; margin-top: 14px; }\n' +
    '    .btn { flex: 1; padding: 7px 10px; border: none; border-radius: 3px; font-size: 12px; font-family: inherit; cursor: pointer; transition: all 0.2s; }\n' +
    '    .btn-apply { background: #FFBE5F; color: #1a1a1a; font-weight: 500; }\n' +
    '    .btn-apply:hover { background: #f0ad4e; }\n' +
    '    .btn-clear { background: #343d3f; color: #ccc; }\n' +
    '    .btn-clear:hover { background: #3d4749; }\n' +
    '    .back-btn { background: none; border: none; color: #666; cursor: pointer; font-size: 12px; padding: 0; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; font-family: inherit; }\n' +
    '    .back-btn:hover { color: #ccc; }\n' +
    '    .section-label { font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 8px; font-weight: 500; }\n' +
    '    .success-msg { background: #1b3a1f; border: 1px solid #2e7d32; border-radius: 3px; padding: 8px 10px; color: #a5d6a7; font-size: 12px; margin-bottom: 10px; }\n' +
    '    .error-msg { background: #3b1a1a; border: 1px solid #7d2e2e; border-radius: 3px; padding: 8px 10px; color: #f44336; font-size: 12px; margin-bottom: 10px; }\n' +
    '    .empty { color: #555; font-size: 12px; text-align: center; padding: 24px 0; }\n' +
    '    hr { border: none; border-top: 1px solid #343d3f; margin: 12px 0; }\n' +
    '    #status { color: #555; font-size: 11px; margin-top: 4px; }\n' +
    '  </style>\n' +
    '</head>\n' +
    '<body>\n' +
    '  <div id="updateBanner" style="display:none;background:#3a2e00;border-bottom:1px solid #FFBE5F;padding:8px 14px;font-size:11px;color:#FFBE5F;line-height:1.5"></div>\n' +
    '  <div id="header">\n' +
    '    <h1>Widget Editor</h1>\n' +
    '    <div class="sub" id="pageUrl">Scanning page...</div>\n' +
    '  </div>\n' +
    '  <div id="content"><div class="empty">Loading...</div></div>\n' +
    '  <div id="footer"><span id="status">Ready</span></div>\n' +
    '  <scr' + 'ipt src="sidepanel.js"></scr' + 'ipt>\n' +
    '</body>\n' +
    '</html>';
}

// ============================================================
// sidepanel.js
// ============================================================
function generateSidepanelJS(reg) {
  const renderRoutes = reg.map(w => {
    const Fn = toPascal(w.class);
    return "  if (widget.widgetClass === '" + w.class + "') return render" + Fn + "Editor(widget, data);";
  }).join('\n');

  const editorImpls = reg.map(w => buildEditorImpl(w)).join('\n\n');

  return [
    '// sidepanel.js — Sitecore Widget Editor',
    '// Auto-generated. Do not edit manually.',
    '',
    'let currentTab = null;',
    'let selectedWidget = null;',
    'let widgetList = [];',
    '',
    "document.addEventListener('DOMContentLoaded', () => {",
    '  chrome.tabs.query({ active: true, currentWindow: true }, tabs => {',
    '    if (!tabs[0]) return;',
    '    currentTab = tabs[0];',
    '    try {',
    '      const url = new URL(tabs[0].url);',
    "      document.getElementById('pageUrl').textContent = url.hostname + url.pathname.slice(0, 40);",
    '    } catch(e) {}',
    '    scanPage();',
    '  });',
    '});',
    '',
    'function scanPage() {',
    "  setStatus('Scanning...');",
    "  chrome.tabs.sendMessage(currentTab.id, { type: 'GET_WIDGETS' }, response => {",
    '    if (chrome.runtime.lastError || !response) {',
    "      setStatus('Could not connect — reload the page and try again');",
    '      showList([]);',
    '      return;',
    '    }',
    '    widgetList = response.widgets || [];',
    "    setStatus(widgetList.length + ' widget(s) found');",
    '    showList(widgetList);',
    '  });',
    '}',
    '',
    'function showList(widgets) {',
    "  const content = document.getElementById('content');",
    '  if (widgets.length === 0) {',
    "    content.innerHTML = '<div class=\"empty\">No registered widgets found on this page.<br><br>Make sure the page contains elements with the registered CSS classes.</div>';",
    '    return;',
    '  }',
    "  let html = '<div class=\"section-label\">Widgets on this page</div>';",
    '  widgets.forEach((w, i) => {',
    '    html += \'<button class="widget-btn" onclick="selectWidget(\' + i + \')">\'',
    '         + \'<div class="name">\' + w.widgetName + \'</div>\'',
    '         + \'<div class="meta">.\' + w.widgetClass + \' &middot; \' + (w.hasItems ? w.itemCount + \' item(s)\' : \'single element\') + \'</div>\'',
    '         + \'</button>\';',
    '  });',
    '  html += \'<div style="margin-top:12px"><button class="btn btn-clear" style="width:100%;flex:none" onclick="scanPage()">Refresh Scan</button></div>\';',
    '  content.innerHTML = html;',
    '}',
    '',
    'function selectWidget(idx) {',
    '  selectedWidget = widgetList[idx];',
    "  setStatus('Loading...');",
    '  chrome.tabs.sendMessage(currentTab.id, {',
    "    type: 'GET_WIDGET_DATA',",
    '    widgetClass: selectedWidget.widgetClass,',
    '    index: selectedWidget.index',
    '  }, response => {',
    '    if (chrome.runtime.lastError || !response || !response.data) {',
    "      showError('Could not load widget data.');",
    '      return;',
    '    }',
    '    renderEditor(selectedWidget, response.data);',
    '  });',
    '}',
    '',
    'function renderEditor(widget, data) {',
    renderRoutes,
    '  renderGenericEditor(widget, data);',
    '}',
    '',
    editorImpls,
    '',
    'function renderGenericEditor(widget, data) {',
    "  let html = getBackBtn() + '<div class=\"section-label\">' + widget.widgetName + '</div>';",
    '  Object.entries(data).forEach(([key, val]) => {',
    "    if (typeof val !== 'object') {",
    '      html += \'<div class="form-group"><label>\' + key + \'</label>\'',
    '           + \'<input type="text" data-field="\' + key + \'" value="\' + escHtml(String(val)) + \'"></div>\';',
    '    }',
    '  });',
    '  html += getBtnRow();',
    "  const content = document.getElementById('content');",
    '  content.innerHTML = html;',
    '  attachSave(() => collectFields(content), widget);',
    '}',
    '',
    'function getBackBtn() {',
    "  return '<button class=\"back-btn\" onclick=\"showList(widgetList)\">&#8592; Back</button>';",
    '}',
    'function getBtnRow() {',
    "  return '<div class=\"btn-row\">'",
    "    + '<button class=\"btn btn-apply\" id=\"applyBtn\">Apply Changes</button>'",
    "    + '<button class=\"btn btn-clear\" onclick=\"showList(widgetList)\">Cancel</button>'",
    "    + '</div>';",
    '}',
    '',
    'function attachSave(collectFn, widget) {',
    "  const btn = document.getElementById('applyBtn');",
    '  if (!btn) return;',
    "  btn.addEventListener('click', () => {",
    '    applyChanges(widget, collectFn());',
    '  });',
    '}',
    '',
    'function applyChanges(widget, data) {',
    '  chrome.tabs.sendMessage(currentTab.id, {',
    "    type: 'UPDATE_WIDGET_DATA',",
    '    widgetClass: widget.widgetClass,',
    '    index: widget.index,',
    '    data: data',
    '  }, response => {',
    '    if (chrome.runtime.lastError || !response || !response.success) {',
    "      showError('Failed to apply changes.');",
    '    } else {',
    "      showSuccess('Changes applied!');",
    '    }',
    '  });',
    '}',
    '',
    'function collectFields(container) {',
    '  const data = {};',
    "  container.querySelectorAll('[data-field]').forEach(input => {",
    '    data[input.dataset.field] = input.value;',
    '  });',
    '  return data;',
    '}',
    '',
    'function showSuccess(msg) {',
    "  const prev = document.querySelector('.success-msg, .error-msg');",
    '  if (prev) prev.remove();',
    '  const el = document.createElement(\'div\');',
    "  el.className = 'success-msg'; el.textContent = msg;",
    "  document.getElementById('content').prepend(el);",
    '  setTimeout(() => el.remove(), 3000);',
    "  setStatus('Saved');",
    '}',
    'function showError(msg) {',
    "  const prev = document.querySelector('.success-msg, .error-msg');",
    '  if (prev) prev.remove();',
    '  const el = document.createElement(\'div\');',
    "  el.className = 'error-msg'; el.textContent = msg;",
    "  document.getElementById('content').prepend(el);",
    "  setStatus('Error');",
    '}',
    'function setStatus(msg) {',
    "  document.getElementById('status').textContent = msg;",
    '}',
    'function escHtml(str) {',
    "  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;');",
    '}',
    '',
    "chrome.runtime.onMessage.addListener((message) => {",
    "  if (message.type === 'WIDGETS_UPDATED') {",
    '    widgetList = message.widgets || [];',
    '    if (!selectedWidget) showList(widgetList);',
    '  }',
    "  if (message.type === 'UPDATE_AVAILABLE') {",
    "    const banner = document.getElementById('updateBanner');",
    "    if (banner) {",
    "      banner.style.display = 'block';",
    "      banner.innerHTML = '&#9888; New version available (v' + message.remoteVersion + '). '",
    "        + '<a href="' + message.downloadUrl + '" target="_blank" style="color:#FFBE5F;font-weight:500">Download update &rarr;</a>';",
    "    }",
    '  }',
    '});',
  ].join('\n');
}

function buildEditorImpl(widget) {
  const Fn     = toPascal(widget.class);
  const fields = widget.fields;

  if (!widget.hasItems) {
    const inputLines = fields.map(f => {
      const key   = f.replace(/-/g, '_');
      const label = toDisplay(f);
      return '  html += \'<div class="form-group"><label>' + label + '</label>\''
           + ' + \'<input type="text" data-field="' + key + '" value="\' + escHtml(data.' + key + ' || \'\') + \'"></div>\';';
    }).join('\n');

    return [
      'function render' + Fn + 'Editor(widget, data) {',
      "  let html = getBackBtn() + '<div class=\"section-label\">' + widget.widgetName + '</div>';",
      inputLines,
      '  html += getBtnRow();',
      "  const content = document.getElementById('content');",
      '  content.innerHTML = html;',
      '  attachSave(() => collectFields(content), widget);',
      "  setStatus('Editing ' + widget.widgetName);",
      '}',
    ].join('\n');
  }

  // Items editor
  const inputLines = fields.map(f => {
    const key   = f.replace(/-/g, '_');
    const label = toDisplay(f);
    return '    html += \'<div class="form-group"><label>' + label + '</label>\''
         + ' + \'<input type="text" data-item-id="\' + item.id + \'" data-field="' + key + '" value="\' + escHtml(item.' + key + ' || \'\') + \'"></div>\';';
  }).join('\n');

  return [
    'function render' + Fn + 'Editor(widget, data) {',
    '  const items = (data && data.items) || [];',
    "  let html = getBackBtn() + '<div class=\"section-label\">' + widget.widgetName + ' &mdash; ' + items.length + ' item(s)</div>';",
    '  items.forEach((item, i) => {',
    '    html += \'<div class="item-card"><div class="item-card-header">Item \' + (i + 1) + \'</div>\';',
    inputLines,
    "    html += '</div>';",
    '  });',
    '  html += getBtnRow();',
    "  const content = document.getElementById('content');",
    '  content.innerHTML = html;',
    '  attachSave(() => {',
    '    const map = {};',
    "    content.querySelectorAll('[data-item-id][data-field]').forEach(input => {",
    '      const id = input.dataset.itemId;',
    '      if (!map[id]) map[id] = { id };',
    '      map[id][input.dataset.field] = input.value;',
    '    });',
    '    return { items: Object.values(map) };',
    '  }, widget);',
    "  setStatus('Editing ' + widget.widgetName);",
    '}',
  ].join('\n');
}

// ============================================================
// README
// ============================================================
function generateReadme(version, reg) {
  return 'Sitecore Widget Editor — v' + version + '\n' +
    'Generated: ' + new Date().toLocaleString() + '\n' +
    'Widgets: ' + reg.length + '\n\n' +
    reg.map(w => '  - ' + w.name + ' (.' + w.class + ') — ' + (w.hasItems ? w.fields.join(', ') : 'single element')).join('\n') + '\n\n' +
    'INSTALLATION\n' +
    '------------\n' +
    '1. Unzip this file\n' +
    '2. Open Chrome → chrome://extensions\n' +
    '3. Enable Developer mode (top right toggle)\n' +
    '4. Click Load unpacked\n' +
    '5. Select the sitecore-widget-editor folder\n\n' +
    'USAGE\n' +
    '-----\n' +
    '1. Navigate to a Sitecore page with your widgets\n' +
    '2. Click the extension icon in the toolbar\n' +
    '3. The sidebar scans and lists detected widgets\n' +
    '4. Select a widget → edit fields → Apply Changes\n\n' +
    'ADDING MORE WIDGETS\n' +
    '-------------------\n' +
    'Run the Code Generator again for each new widget.\n' +
    'Each generation includes ALL registry widgets in the ZIP.\n';
}

// ============================================================
// UTILITIES
// ============================================================
function formatHTML(html) {
  let out = html.replace(/></g, '>\n<');
  const lines = out.split('\n');
  let indent = 0;
  return lines.map(line => {
    const t = line.trim();
    if (!t) return '';
    if (t.startsWith('</')) indent = Math.max(0, indent - 2);
    const result = ' '.repeat(indent) + t;
    if (t.startsWith('<') && !t.startsWith('</') && !t.endsWith('/>') && !t.includes('</')) indent += 2;
    return result;
  }).filter(l => l.trim()).join('\n');
}

function toPascal(cls) {
  return cls.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
}
function toDisplay(str) {
  return str.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
}

// ============================================================
// INIT
// ============================================================
updateVersionBadge();
renderRegistry();
fetchRemoteRegistry();
</script>

</body>
</html>
