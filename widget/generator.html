<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Markup Generator - Sitecore Widget Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .container { 
      max-width: 1400px; 
      margin: 0 auto;
      padding: 80px 40px;
    }

    header { 
      margin-bottom: 100px;
    }

    .version {
      position: absolute;
      top: 0;
      right: 0;
      font-size: 10px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    h1 {
      font-size: 56px;
      font-weight: 600;
      letter-spacing: -1.5px;
      margin-bottom: 12px;
      color: #fff;
    }

    .subtitle {
      font-size: 18px;
      color: #999;
      font-weight: 400;
      margin-bottom: 32px;
    }

    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #333;
      margin-bottom: 32px;
    }

    .tab-nav-link {
      padding: 12px 20px;
      text-decoration: none;
      color: #666;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid transparent;
      transition: color 0.2s;
    }

    .tab-nav-link:hover { color: #999; }
    .tab-nav-link.active { color: #fff; border-bottom-color: #FFBE5F; }

    .main-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 20px;
      margin-top: 60px;
    }

    .panel {
      background: #242424;
      padding: 30px;
      border: 1px solid #333;
    }

    .panel-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #999;
    }

    .form-group { margin-bottom: 20px; }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #333;
      background: #1a1a1a;
      color: #e0e0e0;
      font-family: inherit;
      font-size: 14px;
      border-radius: 6px;
    }

    textarea {
      resize: vertical;
      font-family: 'Courier New', monospace;
      line-height: 1.5;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #FFBE5F;
    }

    .btn,
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: #FFBE5F;
      color: #1a1a1a;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn:hover,
    button:hover { 
      background: #FFD699;
    }
    
    .btn:disabled,
    button:disabled { 
      background: #444;
      color: #666;
      cursor: not-allowed;
    }

    .code-wrapper {
      position: relative;
      background: #1a1a1a;
      border: 1px solid #333;
      margin-top: 20px;
      border-radius: 6px;
    }

    .code-wrapper pre {
      margin: 0;
      padding: 20px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #e0e0e0;
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #333;
      color: #fff;
      border: 1px solid #444;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 6px;
    }

    .copy-btn svg {
      display: block;
    }

    .copy-btn:hover { background: #444; }

    .info-box {
      background: #2a2a2a;
      border: 1px solid #333;
      padding: 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #999;
      line-height: 1.6;
      border-radius: 6px;
    }

    .info-box strong {
      color: #fff;
    }

    .info-box code {
      background: #1a1a1a;
      padding: 2px 6px;
      border: 1px solid #333;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #FFBE5F;
      border-radius: 3px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 20px 0;
    }

    .stat {
      background: #2a2a2a;
      padding: 12px;
      text-align: center;
      border: 1px solid #333;
      border-radius: 6px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #FFBE5F;
    }

    .stat-label {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-top: 4px;
    }

    @media (max-width: 1024px) {
      .main-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <div class="version">v4.0</div>
    <h1>Markup Generator</h1>
    <p class="subtitle">Transform clean HTML into Sitecore-ready annotated markup</p>

    <nav class="tab-nav">
                <a href="overview.html" class="tab-nav-link">Extension Overview</a>
                <a href="workflow.html" class="tab-nav-link">Widget Workflow</a>
                <a href="generator.html" class="tab-nav-link active">Markup Generator</a>
            </nav>
  </header>

  <div class="main-grid">
    <!-- Input Panel -->
    <div class="panel">
      <div class="panel-title">Widget Configuration</div>

      <div class="info-box">
        <strong>How it works:</strong><br>
        1. Enter widget class name and metadata below<br>
        2. Paste your clean HTML (no annotations needed)<br>
        3. Add <code>dynamic-content</code> class to elements where data attributes should be managed<br>
        4. Generator auto-detects content elements (h1-h6, p, a, img, li)<br>
        5. Adds appropriate classes and data attributes based on element type<br>
        6. Use <code>.exclude</code> or <code>.exclude-*</code> to skip elements
      </div>

      <div class="form-group">
        <label>Widget Class Name</label>
        <input type="text" id="widgetClass" placeholder="hero-section" />
      </div>

      <div class="form-group">
        <label>Widget Display Name</label>
        <input type="text" id="widgetName" placeholder="Hero Section" />
      </div>

      <div class="form-group">
        <label>Widget Description (Optional)</label>
        <input type="text" id="widgetDescription" placeholder="Main hero content with heading and CTA" />
      </div>

      <div class="form-group">
        <label>Paste Your HTML</label>
        <textarea id="htmlInput" rows="15" placeholder='<div>
  <h1>Welcome</h1>
  <p>Description here</p>
  <a href="/link">Learn More</a>
</div>'></textarea>
      </div>

      <button class="btn" onclick="processHTML()">Generate Annotated HTML →</button>
    </div>

    <!-- Output Panel -->
    <div class="panel">
      <div class="panel-title">Annotated HTML</div>

      <div id="stats" style="display:none;">
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="statElements">0</div>
            <div class="stat-label">Elements Found</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="statAnnotated">0</div>
            <div class="stat-label">Annotated</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="statExcluded">0</div>
            <div class="stat-label">Excluded</div>
          </div>
        </div>
      </div>

      <div class="code-wrapper">
        <button class="copy-btn" onclick="copyOutput()" title="Copy">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
        </button>
        <pre id="htmlOutput">Processed HTML will appear here...</pre>
      </div>
    </div>
  </div>

</div>

<script>
// Content elements that should be editable
const CONTENT_ELEMENTS = ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'span', 'a', 'img', 'li'];

function processHTML() {
  const widgetClass = document.getElementById('widgetClass').value.trim();
  const widgetName = document.getElementById('widgetName').value.trim();
  const widgetDescription = document.getElementById('widgetDescription').value.trim();
  const input = document.getElementById('htmlInput').value.trim();
  
  if (!widgetClass) {
    alert('Please enter a widget class name');
    return;
  }
  
  // Validate widget class format (must be kebab-case, no spaces)
  if (/\s/.test(widgetClass)) {
    alert('Widget Class cannot contain spaces. Use kebab-case like "animated-cards" or "my-widget"');
    return;
  }
  
  if (!widgetName) {
    alert('Please enter a widget display name');
    return;
  }
  
  if (!input) {
    alert('Please paste HTML to process');
    return;
  }

  // Parse HTML
  const parser = new DOMParser();
  const doc = parser.parseFromString(input, 'text/html');
  
  // Get the root element (could be in body)
  const root = doc.body.children[0];
  
  if (!root) {
    alert('Could not parse HTML');
    return;
  }

  // Create wrapper div with widget metadata
  const wrapper = doc.createElement('div');
  
  // Preserve existing classes from root element
  if (root.classList && root.classList.length > 0) {
    Array.from(root.classList).forEach(cls => {
      wrapper.classList.add(cls);
    });
  }
  
  // Add editable-widget class and widget identifier class
  wrapper.classList.add('editable-widget');
  wrapper.classList.add(widgetClass);
  
  wrapper.setAttribute('data-widget-name', widgetName);
  if (widgetDescription) {
    wrapper.setAttribute('data-widget-description', widgetDescription);
  }
  
  // Move all children from root to wrapper
  while (root.firstChild) {
    wrapper.appendChild(root.firstChild);
  }

  // Process widget to add data attributes
  const stats = {
    total: 0,
    annotated: 0,
    excluded: 0
  };

  annotateWidget(wrapper, stats);

  // Output results
  const output = formatHTML(wrapper.outerHTML);
  document.getElementById('htmlOutput').textContent = output;
  
  // Show stats
  document.getElementById('stats').style.display = 'block';
  document.getElementById('statElements').textContent = stats.total;
  document.getElementById('statAnnotated').textContent = stats.annotated;
  document.getElementById('statExcluded').textContent = stats.excluded;
}

function annotateWidget(widget, stats) {
  const selector = CONTENT_ELEMENTS.join(', ');
  const contentElements = widget.querySelectorAll(selector);
  
  let counters = {};
  
  contentElements.forEach(element => {
    stats.total++;
    
    // Check for .exclude class - remove the class but keep the attribute
    if (element.classList.contains('exclude')) {
      element.classList.remove('exclude');
      stats.excluded++;
      return;
    }
    
    // Check if excluded by ancestor
    if (isExcluded(element, widget)) {
      stats.excluded++;
      return;
    }
    
    // Check if element is nested inside another editable element
    let parent = element.parentElement;
    while (parent && parent !== widget) {
      if (parent.classList.contains('dynamic-content') || 
          parent.classList.contains('data-content') ||
          parent.classList.contains('dynamic-link') ||
          parent.classList.contains('data-link') ||
          parent.classList.contains('dynamic-img') ||
          parent.classList.contains('data-img')) {
        stats.excluded++;
        return; // Skip this element, it's inside another editable element
      }
      parent = parent.parentElement;
    }
    
    const tagName = element.tagName.toLowerCase();
    
    // Check if element has ANY dynamic-* class
    const hasDynamicClass = Array.from(element.classList).some(cls => cls.startsWith('dynamic-'));
    
    // Initialize counter for this tag type
    if (!counters[tagName]) {
      counters[tagName] = 1;
    }
    
    if (hasDynamicClass) {
      // HAS dynamic-* class
      
      if (tagName === 'a') {
        // Link: REPLACE dynamic-* with dynamic-link class, add data-a-1 attribute
        Array.from(element.classList).forEach(cls => {
          if (cls.startsWith('dynamic-')) {
            element.classList.remove(cls);
          }
        });
        element.classList.add('dynamic-link');
        element.setAttribute(`data-a-${counters[tagName]}`, element.getAttribute('href') || '');
      } else if (tagName === 'img') {
        // Image: REPLACE dynamic-* with dynamic-img class, add data-img-1 attribute
        Array.from(element.classList).forEach(cls => {
          if (cls.startsWith('dynamic-')) {
            element.classList.remove(cls);
          }
        });
        element.classList.add('dynamic-img');
        element.setAttribute(`data-img-${counters[tagName]}`, element.getAttribute('src') || '');
      } else {
        // Text elements: KEEP dynamic-* class, add data-{tagname}-1 attribute
        // Get only direct text content, not from child elements
        let text = '';
        element.childNodes.forEach(node => {
          if (node.nodeType === 3) { // Text node
            text += node.textContent;
          }
        });
        text = text.trim();
        
        // Special case: span uses data-dynamic-X instead of data-span-X
        const attrTag = tagName === 'span' ? 'dynamic' : tagName;
        element.setAttribute(`data-${attrTag}-${counters[tagName]}`, text);
      }
      
    } else {
      // NO dynamic-* class
      
      if (tagName === 'a') {
        // Link: add data-link class only
        element.classList.add('data-link');
      } else if (tagName === 'img') {
        // Image: add data-img class only
        element.classList.add('data-img');
      } else {
        // Text elements: add data-content class only
        element.classList.add('data-content');
      }
    }
    
    counters[tagName]++;
    stats.annotated++;
  });
}

function isExcluded(element, widget) {
  // Check if element itself has .exclude class
  if (element.classList.contains('exclude')) {
    return true;
  }
  
  const tagName = element.tagName.toLowerCase();
  
  // Walk up ancestors to check for exclusion classes
  let ancestor = element.parentElement;
  while (ancestor && ancestor !== widget.parentElement) {
    // Check for .exclude-* (exclude all)
    if (ancestor.classList.contains('exclude-*')) {
      return true;
    }
    
    // Check for .exclude-{tagName}
    if (ancestor.classList.contains(`exclude-${tagName}`)) {
      return true;
    }
    
    ancestor = ancestor.parentElement;
  }
  
  return false;
}

function formatHTML(html) {
  // Basic HTML formatting
  let formatted = html;
  
  // Add newlines after opening tags
  formatted = formatted.replace(/></g, '>\n<');
  
  // Indent nested elements
  const lines = formatted.split('\n');
  let indent = 0;
  const indented = lines.map(line => {
    const trimmed = line.trim();
    if (!trimmed) return '';
    
    if (trimmed.startsWith('</')) {
      indent = Math.max(0, indent - 2);
    }
    
    const result = ' '.repeat(indent) + trimmed;
    
    if (trimmed.startsWith('<') && !trimmed.startsWith('</') && !trimmed.endsWith('/>') && !trimmed.includes('</')) {
      indent += 2;
    }
    
    return result;
  });
  
  return indented.filter(line => line.trim()).join('\n');
}

function copyOutput() {
  const output = document.getElementById('htmlOutput').textContent;
  navigator.clipboard.writeText(output).then(() => {
    const btn = document.querySelector('.copy-btn');
    const original = btn.innerHTML;
    btn.innerHTML = '✓';
    setTimeout(() => { btn.innerHTML = original; }, 2000);
  });
}
</script>

</body>
</html>
