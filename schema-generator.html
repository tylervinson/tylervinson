<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-LD Schema Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: #ffffff;
            padding: 2rem;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            font-size: 0.95rem;
        }

        .upload-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            margin-bottom: 2rem;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #999;
            background: #f5f5f5;
        }

        .upload-zone.dragover {
            border-color: #0066cc;
            background: #f0f7ff;
        }

        input[type="file"] {
            display: none;
        }

        button {
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        button:hover:not(:disabled) {
            background: #333;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            margin-bottom: 2rem;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            width: 0%;
            transition: width 0.3s;
        }

        .status {
            color: #666;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .results-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .result-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-url {
            font-size: 0.9rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .download-all {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e0e0e0;
        }

        .info-box {
            background: #f9f9f9;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
            border-left: 3px solid #1a1a1a;
        }

        .warning-box {
            background: #fff3cd;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #856404;
            border-left: 3px solid #ffc107;
        }

        pre {
            background: #f5f5f5;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.85rem;
            border: 1px solid #e0e0e0;
            max-width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .schema-preview {
            display: none;
            margin-top: 1rem;
            width: 100%;
            overflow: hidden;
        }

        .html-preview {
            display: none;
            margin-top: 1rem;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 1.5rem;
            width: 100%;
            overflow: auto;
            max-height: 600px;
        }

        .cors-note {
            background: #e3f2fd;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #1565c0;
            border-left: 3px solid #2196f3;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>JSON-LD Schema Generator</h1>
            <p class="subtitle">Upload URLs and automatically scrape page content to generate comprehensive schemas</p>
        </div>
    </header>

    <div class="container">
        <div class="upload-section">
            <h2 style="margin-bottom: 1rem; font-weight: 400;">Upload Spreadsheet</h2>
            <div class="info-box">
                <strong>Supported formats:</strong> CSV, XLSX, XLS<br>
                <strong>Required:</strong> Just a "URL" column - everything else is automatically extracted!<br>
                <strong>Extracted automatically:</strong> Page title, meta description, organization name, phone numbers, breadcrumbs, and more
            </div>
            
            <div class="upload-zone" id="uploadZone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" style="margin-bottom: 1rem;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p style="color: #666; margin-bottom: 0.5rem;">Drop your spreadsheet here or click to browse</p>
                <p style="color: #999; font-size: 0.85rem;">CSV, XLSX, or XLS files</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div style="margin-top: 1.5rem;">
                <button id="generateBtn" disabled>Generate Schemas</button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <h2 style="margin-bottom: 1rem; font-weight: 400;">Scraping Pages & Generating Schemas...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status" id="statusText">Preparing...</div>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="margin-bottom: 1.5rem; font-weight: 400;">Generated Schemas</h2>
            <div id="resultsList"></div>
            <div class="download-all">
                <button id="downloadAllBtn">Download All Schemas (ZIP)</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        let uploadedData = [];
        let generatedSchemas = [];
        let siteConfig = null; // Will be extracted from first page

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const generateBtn = document.getElementById('generateBtn');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('The spreadsheet appears to be empty');
                        return;
                    }

                    const firstRow = jsonData[0];
                    const urlKey = Object.keys(firstRow).find(key => 
                        key.toLowerCase() === 'url' || key.toLowerCase() === 'urls'
                    );

                    if (!urlKey) {
                        alert('Could not find a "URL" column in your spreadsheet.');
                        return;
                    }

                    uploadedData = jsonData.map(row => ({
                        url: row[urlKey]
                    })).filter(row => row.url);

                    generateBtn.disabled = false;
                    uploadZone.querySelector('p').textContent = `✓ Loaded ${uploadedData.length} URLs`;
                    uploadZone.querySelector('p').style.color = '#2e7d32';
                } catch (error) {
                    console.error('Error parsing file:', error);
                    alert('Error parsing file. Please ensure it\'s a valid CSV or Excel file.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        generateBtn.addEventListener('click', async () => {
            if (uploadedData.length === 0) return;

            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            generateBtn.disabled = true;

            generatedSchemas = [];
            const total = uploadedData.length;

            for (let i = 0; i < uploadedData.length; i++) {
                const item = uploadedData[i];
                updateProgress(i + 1, total, `Scraping ${item.url}`);

                try {
                    // Scrape the page
                    const pageData = await scrapePage(item.url);
                    
                    // Extract site config from first page
                    if (i === 0) {
                        siteConfig = extractSiteConfig(pageData);
                    }
                    
                    // Generate schema
                    const schema = generateSchemaFromPageData(pageData, siteConfig);
                    generatedSchemas.push({
                        url: item.url,
                        schema: JSON.stringify(schema, null, 2),
                        success: true
                    });
                } catch (error) {
                    console.error(`Error processing ${item.url}:`, error);
                    generatedSchemas.push({
                        url: item.url,
                        error: error.message,
                        success: false
                    });
                }

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            displayResults();
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
            generateBtn.disabled = false;
        });

        async function scrapePage(url) {
            // Use CORS proxy to fetch the page
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                return {
                    url: url,
                    doc: doc,
                    html: html
                };
            } catch (error) {
                throw new Error(`Failed to fetch: ${error.message}`);
            }
        }

        function extractSiteConfig(pageData) {
            const doc = pageData.doc;
            const url = new URL(pageData.url);
            
            // Extract organization info from page
            const config = {
                websiteUrl: url.origin,
                orgName: null,
                orgShortName: null,
                logoUrl: null,
                phones: {
                    sales: null,
                    service: null,
                    tty: null
                },
                areaServed: 'US'
            };

            // Try to find organization name from meta tags or content
            const ogSiteName = doc.querySelector('meta[property="og:site_name"]');
            if (ogSiteName) {
                config.orgShortName = ogSiteName.content;
            }

            // Try to find from title
            const title = doc.querySelector('title');
            if (title && title.textContent.includes('|')) {
                const parts = title.textContent.split('|');
                config.orgShortName = parts[parts.length - 1].trim();
            }

            // Find logo
            const logo = doc.querySelector('meta[property="og:image"]') || 
                        doc.querySelector('link[rel="icon"]') ||
                        doc.querySelector('img[class*="logo"]');
            if (logo) {
                config.logoUrl = logo.content || logo.href || logo.src;
                if (config.logoUrl && !config.logoUrl.startsWith('http')) {
                    config.logoUrl = url.origin + config.logoUrl;
                }
            }

            // Find phone numbers in page content
            const bodyText = doc.body.textContent;
            const phoneRegex = /(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/g;
            const phones = bodyText.match(phoneRegex);
            if (phones && phones.length > 0) {
                config.phones.service = phones[0].replace(/\s+/g, '-');
            }

            // Check for TTY
            if (bodyText.includes('TTY') || bodyText.includes('711')) {
                config.phones.tty = '711';
            }

            return config;
        }

        function generateSchemaFromPageData(pageData, siteConfig) {
            const doc = pageData.doc;
            const url = new URL(pageData.url);
            const path = url.pathname;
            const segments = path.split('/').filter(s => s);

            // Extract page metadata
            const title = doc.querySelector('title')?.textContent || 
                         doc.querySelector('meta[property="og:title"]')?.content ||
                         doc.querySelector('h1')?.textContent;
            
            const description = doc.querySelector('meta[name="description"]')?.content ||
                               doc.querySelector('meta[property="og:description"]')?.content;

            const pageType = determinePageType(path, doc);

            // Build schema using the EXACT template structure
            const schema = {
                "@context": "https://schema.org",
                "@type": "WebPage",
                "@id": `${pageData.url}#webpage`,
                "url": pageData.url,
                "name": title || '',
                "description": description || '',
                "isPartOf": {
                    "@type": "WebSite",
                    "name": siteConfig.orgShortName || extractDomainName(url.hostname),
                    "url": siteConfig.websiteUrl + "/"
                },
                "primaryImageOfPage": {
                    "@type": "ImageObject",
                    "url": siteConfig.logoUrl || ''
                },
                "inLanguage": "en",
                "breadcrumb": {
                    "@type": "BreadcrumbList",
                    "itemListElement": []
                },
                "publisher": {
                    "@type": "Organization",
                    "@id": `${siteConfig.websiteUrl}/#organization`,
                    "name": siteConfig.orgName || siteConfig.orgShortName || extractDomainName(url.hostname),
                    "url": siteConfig.websiteUrl + "/",
                    "logo": {
                        "@type": "ImageObject",
                        "url": siteConfig.logoUrl || ''
                    },
                    "contactPoint": []
                },
                "about": {
                    "@type": "Service",
                    "name": '',
                    "provider": {
                        "@type": "Organization",
                        "@id": `${siteConfig.websiteUrl}/#organization`
                    },
                    "areaServed": [],
                    "audience": {
                        "@type": "PeopleAudience",
                        "name": ''
                    },
                    "serviceType": '',
                    "description": '',
                    "hasOfferCatalog": {
                        "@type": "OfferCatalog",
                        "name": '',
                        "itemListElement": {
                            "@type": "ItemList",
                            "itemListOrder": "http://schema.org/ItemListOrderAscending",
                            "numberOfItems": 0,
                            "itemListElement": []
                        }
                    }
                },
                "mainEntity": {
                    "@type": "ItemList",
                    "name": '',
                    "itemListElement": []
                },
                "potentialAction": [
                    {
                        "@type": "SearchAction",
                        "target": {
                            "@type": "EntryPoint",
                            "urlTemplate": pageData.url
                        },
                        "query-input": "required name=search_term_string"
                    }
                ]
            };

            // Build breadcrumbs from URL path
            if (segments.length > 0) {
                let currentPath = '';
                segments.forEach((segment, index) => {
                    currentPath += '/' + segment;
                    schema.breadcrumb.itemListElement.push({
                        "@type": "ListItem",
                        "position": index + 1,
                        "name": segment.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        "item": `${url.origin}${currentPath}`
                    });
                });
            }

            // Add contact points
            if (siteConfig.phones.sales) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.sales,
                    "contactType": "sales",
                    "areaServed": [siteConfig.areaServed],
                    "availableLanguage": ["en"]
                });
            }
            if (siteConfig.phones.service) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.service,
                    "contactType": "customer service",
                    "areaServed": [siteConfig.areaServed],
                    "availableLanguage": ["en"]
                });
            }
            if (siteConfig.phones.tty) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.tty,
                    "contactType": "TTY",
                    "areaServed": [siteConfig.areaServed],
                    "availableLanguage": ["en"]
                });
            }

            // Extract service/product information from page content
            const mainHeading = doc.querySelector('h1')?.textContent;
            const bodyText = doc.body.textContent.toLowerCase();
            
            // Look for service indicators (plans, products, services mentioned)
            const hasServices = bodyText.includes('plan') || bodyText.includes('service') || 
                               bodyText.includes('product') || bodyText.includes('coverage') ||
                               bodyText.includes('benefit');
            
            if (hasServices && (path.includes('medicare') || path.includes('insurance') || 
                path.includes('plan') || path.includes('service'))) {
                
                // Fill in About section
                schema.about.name = mainHeading || title;
                schema.about.serviceType = extractServiceType(mainHeading, bodyText);
                schema.about.description = description || '';

                // Try to find target audience
                const audienceMatch = bodyText.match(/(medicare[- ]eligible|seniors|individuals|families|businesses)/i);
                if (audienceMatch) {
                    schema.about.audience.name = audienceMatch[0].charAt(0).toUpperCase() + audienceMatch[0].slice(1);
                }

                // Try to extract area served from content
                const countyMatch = bodyText.match(/([A-Z][a-z]+\s+County,?\s*[A-Z]{2})/g);
                if (countyMatch && countyMatch.length > 0) {
                    schema.about.areaServed = countyMatch.slice(0, 3).map(county => ({
                        "@type": "AdministrativeArea",
                        "name": county
                    }));
                }

                // Look for specific plan/product mentions
                const planNames = extractPlanNames(doc);
                if (planNames.length > 0) {
                    schema.about.hasOfferCatalog.name = `${mainHeading || title} Plans`;
                    schema.about.hasOfferCatalog.itemListElement.numberOfItems = planNames.length;
                    schema.about.hasOfferCatalog.itemListElement.itemListElement = planNames.map((planName, idx) => ({
                        "@type": "Service",
                        "name": planName,
                        "areaServed": countyMatch ? countyMatch.slice(0, 3) : [],
                        "description": `${planName} coverage option`
                    }));

                    // Create mainEntity
                    schema.mainEntity.name = `Featured ${mainHeading || 'Plans'}`;
                    schema.mainEntity.itemListElement = planNames.map((planName, idx) => ({
                        "@type": "ListItem",
                        "position": idx + 1,
                        "item": {
                            "@type": "Service",
                            "name": planName,
                            "url": pageData.url,
                            "provider": { "@id": `${siteConfig.websiteUrl}/#organization` }
                        }
                    }));
                }
            }

            // Add additional action if CTA buttons found
            const ctaButtons = doc.querySelectorAll('a[href*="shop"], a[href*="enroll"], button');
            if (ctaButtons.length > 0) {
                const ctaText = Array.from(ctaButtons).find(btn => 
                    btn.textContent.toLowerCase().includes('shop') || 
                    btn.textContent.toLowerCase().includes('enroll') ||
                    btn.textContent.toLowerCase().includes('compare')
                );
                if (ctaText) {
                    schema.potentialAction.push({
                        "@type": "Action",
                        "name": ctaText.textContent.trim(),
                        "target": pageData.url
                    });
                }
            }

            return schema;
        }

        function extractServiceType(heading, bodyText) {
            if (bodyText.includes('medicare advantage') || bodyText.includes('hmo')) {
                return 'Medicare Advantage (Part C) HMO';
            }
            if (bodyText.includes('medicare')) {
                return 'Medicare Insurance';
            }
            if (bodyText.includes('health insurance')) {
                return 'Health Insurance';
            }
            return heading || 'Insurance Services';
        }

        function extractPlanNames(doc) {
            const planNames = [];
            
            // Look for common plan name patterns
            const headings = doc.querySelectorAll('h2, h3, h4');
            headings.forEach(h => {
                const text = h.textContent.trim();
                // Match patterns like "Blue Best Life", "Plan Name (HMO)", etc.
                if (text.match(/(Plan|Plus|Classic|Premium|Basic|Standard|Elite|Select)/i) ||
                    text.match(/\(HMO\)|\(PPO\)|\(EPO\)/)) {
                    planNames.push(text);
                }
            });

            // Look in lists
            const listItems = doc.querySelectorAll('li');
            listItems.forEach(li => {
                const text = li.textContent.trim();
                if (text.length < 100 && text.match(/(Plan|Plus|Classic|Premium|HMO|PPO)/i)) {
                    planNames.push(text);
                }
            });

            // Deduplicate and limit
            return [...new Set(planNames)].slice(0, 5);
        }

        function determinePageType(path, doc) {
            if (path.includes('/blog/') || path.includes('/article/') || path.includes('/news/')) {
                return 'Article';
            }
            if (path.includes('/product/') || path.includes('/shop/')) {
                return 'Product';
            }
            if (path.includes('/faq')) {
                return 'FAQPage';
            }
            if (path.includes('/contact')) {
                return 'ContactPage';
            }
            if (path.includes('/about')) {
                return 'AboutPage';
            }
            return 'WebPage';
        }

        function extractDomainName(hostname) {
            const parts = hostname.replace('www.', '').split('.');
            return parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
        }

        function updateProgress(current, total, status) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('statusText').textContent = `${status} (${current}/${total})`;
        }

        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            generatedSchemas.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                
                // Create header row with URL and buttons
                const headerRow = document.createElement('div');
                headerRow.className = 'result-header';
                
                const urlDiv = document.createElement('div');
                urlDiv.innerHTML = `
                    <div class="result-url">${result.url}</div>
                    ${result.success ? '<span style="color: #2e7d32; font-size: 0.85rem;">✓ Generated</span>' : '<span style="color: #d32f2f; font-size: 0.85rem;">✗ ' + result.error + '</span>'}
                `;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'result-actions';

                if (result.success) {
                    const viewBtn = document.createElement('button');
                    viewBtn.textContent = 'View JSON';
                    viewBtn.className = 'btn-small';
                    viewBtn.onclick = () => togglePreview(index);

                    const viewHtmlBtn = document.createElement('button');
                    viewHtmlBtn.textContent = 'View HTML';
                    viewHtmlBtn.className = 'btn-small';
                    viewHtmlBtn.onclick = () => toggleHtmlPreview(index);

                    const copyBtn = document.createElement('button');
                    copyBtn.textContent = 'Copy';
                    copyBtn.className = 'btn-small';
                    copyBtn.onclick = () => {
                        const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                        navigator.clipboard.writeText(wrappedSchema);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = 'Copy', 2000);
                    };

                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Download';
                    downloadBtn.className = 'btn-small';
                    downloadBtn.onclick = () => downloadSchema(result, index);

                    actionsDiv.appendChild(viewBtn);
                    actionsDiv.appendChild(viewHtmlBtn);
                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(downloadBtn);
                }

                headerRow.appendChild(urlDiv);
                headerRow.appendChild(actionsDiv);
                item.appendChild(headerRow);
                
                resultsList.appendChild(item);

                if (result.success) {
                    const preview = document.createElement('div');
                    preview.className = 'schema-preview';
                    preview.id = `preview-${index}`;
                    
                    // Wrap JSON in script tags - escape the closing script tag to prevent breaking
                    const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                    preview.innerHTML = `<pre>${escapeHtml(wrappedSchema)}</pre>`;
                    item.appendChild(preview);

                    const htmlPreview = document.createElement('div');
                    htmlPreview.className = 'html-preview';
                    htmlPreview.id = `html-preview-${index}`;
                    item.appendChild(htmlPreview);
                }
            });
        }

        function togglePreview(index) {
            const preview = document.getElementById(`preview-${index}`);
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            
            // Close HTML preview if open
            if (htmlPreview.style.display === 'block') {
                htmlPreview.style.display = 'none';
            }
            
            // Toggle JSON preview
            preview.style.display = preview.style.display === 'none' || !preview.style.display ? 'block' : 'none';
        }

        function toggleHtmlPreview(index) {
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            
            // Close JSON preview if open
            if (preview.style.display === 'block') {
                preview.style.display = 'none';
            }
            
            const isVisible = htmlPreview.style.display === 'block';
            
            if (!isVisible) {
                const schema = generatedSchemas[index].schema;
                const htmlContent = generateHTMLFromSchema(schema);
                htmlPreview.innerHTML = htmlContent;
                htmlPreview.style.display = 'block';
            } else {
                htmlPreview.style.display = 'none';
            }
        }

        function generateHTMLFromSchema(schemaJson) {
            const schema = JSON.parse(schemaJson);
            
            let html = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif;">';
            html += '<h3 style="margin: 0 0 1.5rem 0; font-weight: 400; border-bottom: 2px solid #1a1a1a; padding-bottom: 0.5rem;">' + escapeHtml(schema.name) + '</h3>';
            
            // Basic Info Section
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">';
            
            html += '<div style="background: #f9f9f9; padding: 1rem; border-left: 3px solid #1a1a1a;">';
            html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Type</div>';
            html += '<div style="font-weight: 500;">' + escapeHtml(schema['@type']) + '</div>';
            html += '</div>';
            
            html += '<div style="background: #f9f9f9; padding: 1rem; border-left: 3px solid #1a1a1a;">';
            html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Language</div>';
            html += '<div style="font-weight: 500;">' + escapeHtml(schema.inLanguage) + '</div>';
            html += '</div>';
            
            html += '</div>';

            // Description
            if (schema.description) {
                html += '<div style="background: #fafafa; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; font-weight: 500;">Description</div>';
                html += '<div style="color: #333;">' + escapeHtml(schema.description) + '</div>';
                html += '</div>';
            }

            // URL & ID
            html += '<div style="background: #fafafa; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
            html += '<div style="margin-bottom: 0.5rem;"><strong>URL:</strong> <a href="' + escapeHtml(schema.url) + '" target="_blank" style="color: #0066cc; word-break: break-all;">' + escapeHtml(schema.url) + '</a></div>';
            html += '<div><strong>ID:</strong> <code style="background: #f5f5f5; padding: 0.25rem 0.5rem;">' + escapeHtml(schema['@id']) + '</code></div>';
            html += '</div>';

            // IsPartOf
            if (schema.isPartOf) {
                html += '<div style="background: #f0f7ff; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #2196f3;">';
                html += '<div style="font-weight: 500; margin-bottom: 0.5rem;">Part Of Website</div>';
                html += '<div><strong>Name:</strong> ' + escapeHtml(schema.isPartOf.name) + '</div>';
                html += '<div><strong>URL:</strong> <a href="' + escapeHtml(schema.isPartOf.url) + '" target="_blank" style="color: #0066cc;">' + escapeHtml(schema.isPartOf.url) + '</a></div>';
                html += '</div>';
            }

            // Primary Image
            if (schema.primaryImageOfPage && schema.primaryImageOfPage.url) {
                html += '<div style="background: #fafafa; padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 500; margin-bottom: 0.5rem;">Primary Image</div>';
                html += '<div style="word-break: break-all;"><a href="' + escapeHtml(schema.primaryImageOfPage.url) + '" target="_blank" style="color: #0066cc;">' + escapeHtml(schema.primaryImageOfPage.url) + '</a></div>';
                html += '</div>';
            }

            // Breadcrumbs
            if (schema.breadcrumb && schema.breadcrumb.itemListElement && schema.breadcrumb.itemListElement.length > 0) {
                html += '<div style="background: #fff3e0; padding: 1rem; margin-bottom: 1.5rem; border-left: 3px solid #ff9800;">';
                html += '<div style="font-weight: 500; margin-bottom: 0.75rem;">Breadcrumbs</div>';
                html += '<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">';
                schema.breadcrumb.itemListElement.forEach((item, idx) => {
                    if (idx > 0) html += '<span style="color: #999;">›</span>';
                    html += '<span style="background: #fff; padding: 0.25rem 0.75rem; border-radius: 2px; font-size: 0.9rem; border: 1px solid #e0e0e0;">';
                    html += escapeHtml(item.name);
                    html += '</span>';
                });
                html += '</div></div>';
            }

            // Publisher
            if (schema.publisher) {
                html += '<div style="background: #e8f5e9; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 3px solid #4caf50;">';
                html += '<div style="font-weight: 500; margin-bottom: 1rem; font-size: 1.05rem;">Publisher / Organization</div>';
                html += '<div style="margin-bottom: 0.5rem;"><strong>Name:</strong> ' + escapeHtml(schema.publisher.name) + '</div>';
                html += '<div style="margin-bottom: 0.5rem;"><strong>URL:</strong> <a href="' + escapeHtml(schema.publisher.url) + '" target="_blank" style="color: #0066cc;">' + escapeHtml(schema.publisher.url) + '</a></div>';
                html += '<div style="margin-bottom: 0.5rem;"><strong>ID:</strong> <code style="background: #fff; padding: 0.25rem 0.5rem;">' + escapeHtml(schema.publisher['@id']) + '</code></div>';
                
                if (schema.publisher.logo) {
                    html += '<div style="margin-bottom: 0.5rem;"><strong>Logo:</strong> <a href="' + escapeHtml(schema.publisher.logo.url) + '" target="_blank" style="color: #0066cc; font-size: 0.9rem; word-break: break-all;">' + escapeHtml(schema.publisher.logo.url) + '</a></div>';
                }
                
                if (schema.publisher.contactPoint && schema.publisher.contactPoint.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #c8e6c9;">';
                    html += '<div style="font-weight: 500; margin-bottom: 0.5rem;">Contact Points</div>';
                    schema.publisher.contactPoint.forEach(cp => {
                        html += '<div style="margin: 0.5rem 0; padding: 0.75rem; background: #fff; border-left: 2px solid #4caf50;">';
                        html += '<div><strong>Type:</strong> ' + escapeHtml(cp.contactType) + '</div>';
                        html += '<div><strong>Phone:</strong> ' + escapeHtml(cp.telephone) + '</div>';
                        html += '<div><strong>Area:</strong> ' + escapeHtml(cp.areaServed.join(', ')) + '</div>';
                        html += '<div><strong>Languages:</strong> ' + escapeHtml(cp.availableLanguage.join(', ')) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            // About (Service)
            if (schema.about && schema.about.name) {
                html += '<div style="background: #f3e5f5; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 3px solid #9c27b0;">';
                html += '<div style="font-weight: 500; margin-bottom: 1rem; font-size: 1.05rem;">About (Service)</div>';
                html += '<div style="margin-bottom: 0.5rem;"><strong>Name:</strong> ' + escapeHtml(schema.about.name) + '</div>';
                
                if (schema.about.serviceType) {
                    html += '<div style="margin-bottom: 0.5rem;"><strong>Service Type:</strong> ' + escapeHtml(schema.about.serviceType) + '</div>';
                }
                
                if (schema.about.description) {
                    html += '<div style="margin-bottom: 0.5rem;"><strong>Description:</strong> ' + escapeHtml(schema.about.description) + '</div>';
                }
                
                if (schema.about.audience && schema.about.audience.name) {
                    html += '<div style="margin-bottom: 0.5rem;"><strong>Target Audience:</strong> ' + escapeHtml(schema.about.audience.name) + '</div>';
                }
                
                if (schema.about.areaServed && schema.about.areaServed.length > 0) {
                    html += '<div style="margin-top: 1rem;"><strong>Areas Served:</strong></div>';
                    html += '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">';
                    schema.about.areaServed.forEach(area => {
                        html += '<span style="background: #fff; padding: 0.5rem 1rem; border-radius: 2px; border: 1px solid #e0e0e0;">' + escapeHtml(area.name) + '</span>';
                    });
                    html += '</div>';
                }
                
                // Offer Catalog
                if (schema.about.hasOfferCatalog && schema.about.hasOfferCatalog.itemListElement.itemListElement.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e1bee7;">';
                    html += '<div style="font-weight: 500; margin-bottom: 0.75rem;">Offer Catalog: ' + escapeHtml(schema.about.hasOfferCatalog.name) + '</div>';
                    html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">Number of Items: ' + schema.about.hasOfferCatalog.itemListElement.numberOfItems + '</div>';
                    
                    schema.about.hasOfferCatalog.itemListElement.itemListElement.forEach(item => {
                        html += '<div style="margin: 0.75rem 0; padding: 1rem; background: #fff; border-left: 2px solid #9c27b0;">';
                        html += '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + escapeHtml(item.name) + '</div>';
                        if (item.description) {
                            html += '<div style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">' + escapeHtml(item.description) + '</div>';
                        }
                        if (item.areaServed && item.areaServed.length > 0) {
                            html += '<div style="font-size: 0.85rem; color: #666;">Areas: ' + escapeHtml(item.areaServed.join(', ')) + '</div>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            // Main Entity
            if (schema.mainEntity && schema.mainEntity.itemListElement && schema.mainEntity.itemListElement.length > 0) {
                html += '<div style="background: #e3f2fd; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 3px solid #2196f3;">';
                html += '<div style="font-weight: 500; margin-bottom: 1rem; font-size: 1.05rem;">Main Entity: ' + escapeHtml(schema.mainEntity.name) + '</div>';
                
                schema.mainEntity.itemListElement.forEach(item => {
                    html += '<div style="margin: 0.75rem 0; padding: 1rem; background: #fff; border-left: 2px solid #2196f3;">';
                    html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Position: ' + item.position + '</div>';
                    html += '<div style="font-weight: 500; margin-bottom: 0.25rem;">' + escapeHtml(item.item.name) + '</div>';
                    html += '<div style="font-size: 0.85rem;"><strong>Type:</strong> ' + escapeHtml(item.item['@type']) + '</div>';
                    html += '<div style="font-size: 0.85rem;"><strong>URL:</strong> <a href="' + escapeHtml(item.item.url) + '" target="_blank" style="color: #0066cc;">' + escapeHtml(item.item.url) + '</a></div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Potential Actions
            if (schema.potentialAction && schema.potentialAction.length > 0) {
                html += '<div style="background: #fff3e0; padding: 1.5rem; margin-bottom: 1.5rem; border-left: 3px solid #ff9800;">';
                html += '<div style="font-weight: 500; margin-bottom: 1rem; font-size: 1.05rem;">Potential Actions</div>';
                
                schema.potentialAction.forEach((action, idx) => {
                    html += '<div style="margin: 0.75rem 0; padding: 1rem; background: #fff; border-left: 2px solid #ff9800;">';
                    html += '<div style="font-weight: 500; margin-bottom: 0.5rem;">' + escapeHtml(action['@type']) + '</div>';
                    if (action.name) {
                        html += '<div><strong>Name:</strong> ' + escapeHtml(action.name) + '</div>';
                    }
                    if (action.target) {
                        if (typeof action.target === 'string') {
                            html += '<div><strong>Target:</strong> ' + escapeHtml(action.target) + '</div>';
                        } else if (action.target.urlTemplate) {
                            html += '<div><strong>URL Template:</strong> ' + escapeHtml(action.target.urlTemplate) + '</div>';
                        }
                    }
                    if (action['query-input']) {
                        html += '<div style="font-size: 0.85rem; color: #666;"><strong>Query Input:</strong> ' + escapeHtml(action['query-input']) + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function downloadSchema(result, index) {
            const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
            const blob = new Blob([wrappedSchema], { type: 'text/html' });
            const filename = `schema-${index + 1}.html`;
            saveAs(blob, filename);
        }

        document.getElementById('downloadAllBtn').addEventListener('click', async () => {
            const zip = new JSZip();
            
            generatedSchemas.forEach((result, index) => {
                if (result.success) {
                    const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                    zip.file(`schema-${index + 1}.html`, wrappedSchema);
                }
            });

            const content = await zip.generateAsync({ type: 'blob' });
            saveAs(content, 'schemas.zip');
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>