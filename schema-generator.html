<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON-LD Schema Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: #ffffff;
            padding: 2rem;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #666;
            font-size: 0.95rem;
        }

        .upload-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            margin-bottom: 2rem;
            transition: all 0.35s cubic-bezier(0.1, 0.1, 0.1, 1);
            overflow: hidden;
            max-height: 1000px;
        }

        .upload-section.collapsed {
            max-height: 80px;
            padding: 1rem 2rem;
        }

        .upload-content {
            transition: opacity 0.15s ease, transform 0.15s ease;
        }

        .upload-section.collapsed .upload-content {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .upload-header.clickable {
            cursor: pointer;
        }

        .upload-header.clickable:hover h2 {
            color: #333;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
            position: relative;
            border-bottom: 1px solid #e0e0e0;
        }

        .tabs::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 0;
            height: 2px;
            background: #1a1a1a;
            transition: all 0.3s ease;
        }

        .tabs[data-active="0"]::after {
            left: 0;
            width: 120px;
        }

        .tabs[data-active="1"]::after {
            left: 150px;
            width: 96px;
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95rem;
            color: #666;
            transition: color 0.2s ease;
        }

        .tab-btn:hover {
            color: #1a1a1a;
            background: transparent;
        }

        .tab-btn.active {
            color: #1a1a1a;
            background: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .github-settings-btn {
            padding: 0.75rem 1.5rem;
            background: #1a1a1a;
            color: white;
            border: none;
            cursor: pointer;
            font-family: inherit;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .github-settings-btn.hidden {
            display: none !important;
        }

        .upload-zone {
            border: 2px dashed #ccc;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-zone:hover {
            border-color: #999;
            background: #f5f5f5;
        }

        .upload-zone.dragover {
            border-color: #0066cc;
            background: #f0f7ff;
        }

        input[type="file"] {
            display: none;
        }

        button {
            background: #1a1a1a;
            color: #ffffff;
            border: none;
            padding: 0.75rem 2rem;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .progress-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            margin-bottom: 2rem;
            display: none;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.1, 0.1, 0.1, 1);
            transform-origin: top;
        }

        .progress-section.show {
            animation: slideDown 0.35s cubic-bezier(0.1, 0.1, 0.1, 1);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
                max-height: 0;
            }
            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 500px;
            }
        }

        @keyframes clockTick {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #progressClock {
            animation: clockTick 2s linear infinite;
            display: inline-block;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e0e0e0;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            width: 0%;
            transition: width 0.3s;
        }

        .status {
            color: #666;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .results-section {
            background: #ffffff;
            padding: 2rem;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .result-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .result-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-url {
            font-size: 0.9rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .icon-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s ease;
            font-size: 1.25rem;
            color: #1a1a1a;
        }

        .icon-btn:last-child {
            margin-right: 0;
        }

        .icon-btn:hover {
            opacity: 0.6;
        }

        .download-all {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e0e0e0;
        }

        .info-box {
            background: #f9f9f9;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
            border-left: 3px solid #1a1a1a;
        }

        .warning-box {
            background: #fff3cd;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #856404;
            border-left: 3px solid #ffc107;
        }

        pre {
            background: #f5f5f5;
            padding: 1rem;
            overflow-x: auto;
            font-size: 0.85rem;
            border: 1px solid #e0e0e0;
            max-width: 100%;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .schema-preview {
            display: none;
            margin-top: 1rem;
            width: 100%;
            overflow: hidden;
        }

        .html-preview {
            display: none;
            margin-top: 1rem;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 1.5rem;
            width: 100%;
            overflow: auto;
            max-height: 600px;
        }

        .cors-note {
            background: #e3f2fd;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #1565c0;
            border-left: 3px solid #2196f3;
        }
    </style>
</head>
<body>
    <header>
        <div class="container" style="display: flex; justify-content: space-between; align-items: center; gap: 2rem;">
            <div>
                <h1>JSON-LD Schema Generator</h1>
                <p class="subtitle">Upload URLs and automatically scrape page content to generate comprehensive schemas</p>
            </div>
            <div style="display: flex; gap: 1.5rem; align-items: center;">
                <button id="browseSchemasbtn" onclick="showBrowseSchemas()" style="background: transparent; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #1a1a1a;" title="Browse Schemas">
                    <i class="fa-regular fa-folder-open"></i>
                </button>
                <button id="githubSettingsBtn" onclick="showGitHubConfigModal()" style="background: transparent; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #1a1a1a;" title="GitHub Settings">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="tabs" data-active="0">
            <button class="tab-btn active" onclick="switchTab('spreadsheet', 0)">Spreadsheet</button>
            <button class="tab-btn" onclick="switchTab('single', 1)">Single URL</button>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-header" id="uploadHeader">
                <h2 style="margin-bottom: 0; font-weight: 400; padding-bottom: 20px;">Upload Spreadsheet</h2>
            </div>
            
            <div class="upload-content">
                <div id="spreadsheetTab" class="tab-content active">
                    <div class="upload-zone" id="uploadZone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="1.5" style="margin-bottom: 1rem;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p style="color: #666; margin-bottom: 0.5rem;">Drop your spreadsheet here or click to browse</p>
                <p style="color: #999; font-size: 0.85rem;">CSV, XLSX, or XLS files</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            </div>

            <div style="margin-top: 1.5rem;">
                <button id="generateBtn" disabled>Generate Schemas</button>
            </div>
                </div>

                <div id="singleTab" class="tab-content">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 400;">Enter URL</label>
                        <input type="text" id="singleUrlInput" placeholder="https://example.com/page" style="width: 100%; padding: 0.75rem; border: 1px solid #e0e0e0; font-family: inherit; font-size: 1rem;">
                    </div>
                    <div>
                        <button id="generateSingleBtn" disabled>Generate Schema</button>
                    </div>
                </div>
            </div>
            </div>

        <div class="progress-section" id="progressSection">
            <h2 style="margin-bottom: 1rem; font-weight: 400;">Scraping Pages & Generating Schemas...</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="status" id="statusText">
                <i class="fa-regular fa-clock" id="progressClock" style="display: none; margin-right: 0.5rem;"></i>
                <span id="statusTextContent">Preparing...</span>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; font-weight: 400;">Generated Schemas</h2>
                <button onclick="closeResults()" style="background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; line-height: 1;" title="Close">×</button>
            </div>
            <div id="resultsList"></div>
            <div class="download-all">
                <button id="downloadAllBtn">Download All Schemas (ZIP)</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        let uploadedData = [];
        let generatedSchemas = [];
        let siteConfig = null; // Will be extracted from first page

        // Public read-only GitHub configuration (everyone can view schemas)
        const publicGitHubConfig = {
            owner: 'tylervinson',
            repo: 'tylervinson',
            branch: 'main'
        };

        // Private GitHub Configuration (required for saving/deleting)
        let githubConfig = {
            token: localStorage.getItem('github_token') || '',
            owner: localStorage.getItem('github_owner') || '',
            repo: localStorage.getItem('github_repo') || '',
            branch: localStorage.getItem('github_branch') || 'main'
        };

        // Check if user has write access (token configured)
        function hasWriteAccess() {
            return githubConfig.token && githubConfig.owner && githubConfig.repo;
        }

        // Check if GitHub is configured (legacy function, now checks write access)
        function isGitHubConfigured() {
            return hasWriteAccess();
        }

        // Get config for reading (uses public config if user hasn't configured their own)
        function getReadConfig() {
            if (hasWriteAccess()) {
                return githubConfig;
            }
            return publicGitHubConfig;
        }

        // Show GitHub config modal on first use
        function showGitHubConfigModal() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 600px; width: 100%; padding: 2rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';
            
            modalContent.innerHTML = `
                <h2 style="margin: 0 0 1rem 0; font-weight: 300;">GitHub Configuration</h2>
                <p style="color: #666; margin-bottom: 1.5rem;">Configure GitHub storage to persist schemas for all visitors.</p>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 400;">GitHub Personal Access Token *</label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; font-family: inherit;">
                    <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                        <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" style="color: #1a1a1a;">Create token</a> with 'repo' scope
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 400;">Repository Owner *</label>
                    <input type="text" id="githubOwner" placeholder="username or organization" value="${githubConfig.owner}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; font-family: inherit;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 400;">Repository Name *</label>
                    <input type="text" id="githubRepo" placeholder="my-repo" value="${githubConfig.repo}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; font-family: inherit;">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 400;">Branch</label>
                    <input type="text" id="githubBranch" placeholder="main" value="${githubConfig.branch}" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; font-family: inherit;">
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button onclick="saveGitHubConfig()" style="flex: 1; background: #1a1a1a; color: white; border: none; padding: 0.75rem; cursor: pointer; font-family: inherit;">Save Configuration</button>
                    <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; background: #e0e0e0; color: #1a1a1a; border: none; padding: 0.75rem; cursor: pointer; font-family: inherit;">Cancel</button>
                </div>
            `;
            
            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function saveGitHubConfig() {
            const token = document.getElementById('githubToken').value.trim();
            const owner = document.getElementById('githubOwner').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            const branch = document.getElementById('githubBranch').value.trim() || 'main';
            
            if (!token || !owner || !repo) {
                alert('Please fill in all required fields');
                return;
            }
            
            githubConfig = { token, owner, repo, branch };
            localStorage.setItem('github_token', token);
            localStorage.setItem('github_owner', owner);
            localStorage.setItem('github_repo', repo);
            localStorage.setItem('github_branch', branch);
            
            document.querySelector('.modal-overlay').remove();
            updateSettingsButtonVisibility();
            alert('GitHub configuration saved!');
        }

        function updateSettingsButtonVisibility() {
            const settingsBtn = document.getElementById('githubSettingsBtn');
            if (hasWriteAccess()) {
                // User has configured GitHub - hide the settings button
                settingsBtn.classList.add('hidden');
            } else {
                // User hasn't configured - show settings button so they can add their own schemas
                settingsBtn.classList.remove('hidden');
                settingsBtn.title = 'Configure GitHub to save your own schemas';
            }
        }

        // Check and hide button on page load
        window.addEventListener('DOMContentLoaded', () => {
            updateSettingsButtonVisibility();
            disableAccordion(); // Start with accordion disabled
        });

        async function showBrowseSchemas() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 900px; width: 100%; max-height: 90vh; overflow: auto; padding: 2rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;';
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e0e0e0;">
                    <h2 style="margin: 0; font-weight: 300; font-size: 1.5rem;">Stored Schemas</h2>
                    <button onclick="this.closest('.modal-overlay').remove()" style="background: transparent; border: none; cursor: pointer; padding: 0; font-size: 1.5rem; color: #1a1a1a; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s ease;" title="Close" onmouseover="this.style.opacity='0.6'" onmouseout="this.style.opacity='1'">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <div id="schemasList" style="padding: 1rem; text-align: center; color: #666;">Loading schemas...</div>
            `;
            
            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Load schemas
            const files = await listAllSchemas();
            const schemasList = document.getElementById('schemasList');
            
            if (files.length === 0) {
                schemasList.innerHTML = '<div style="padding: 2rem; color: #666;">No schemas found. Generate some schemas to get started!</div>';
                return;
            }
            
            schemasList.innerHTML = '';
            
            for (const file of files) {
                const schemaData = await getSchemaFromGitHub(null, file.name);
                if (!schemaData) continue;
                
                const schemaItem = document.createElement('div');
                schemaItem.style.cssText = 'margin-bottom: 1rem; padding: 1.5rem; border: 1px solid #e0e0e0;';
                
                const lastUpdated = new Date(schemaData.lastUpdated).toLocaleString();
                const versionCount = schemaData.history?.length || 0;
                
                const deleteButtonHtml = hasWriteAccess() ? `
                            <button onclick='deleteStoredSchema(${JSON.stringify(schemaData.url)}, this)' style="background: transparent; border: none; cursor: pointer; padding: 0; font-size: 1.25rem; color: #d32f2f; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s ease;" title="Delete Schema" onmouseover="this.style.opacity='0.6'" onmouseout="this.style.opacity='1'">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                ` : '';
                
                schemaItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 400; margin-bottom: 0.5rem; word-break: break-all;">${escapeHtml(schemaData.url)}</div>
                            <div style="font-size: 0.85rem; color: #666;">
                                <span>Last updated: ${lastUpdated}</span>
                                <span style="margin-left: 1rem;">Versions: ${versionCount}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-shrink: 0;">
                            <button onclick='viewStoredSchema(${JSON.stringify(schemaData.url)})' style="background: transparent; border: none; cursor: pointer; padding: 0; font-size: 1.25rem; color: #1a1a1a; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s ease;" title="View Schema" onmouseover="this.style.opacity='0.6'" onmouseout="this.style.opacity='1'">
                                <i class="fa-regular fa-eye"></i>
                            </button>
                            ${deleteButtonHtml}
                        </div>
                    </div>
                `;
                
                schemasList.appendChild(schemaItem);
            }
        }

        async function getSchemaFromGitHub(url, filename = null) {
            const config = getReadConfig();

            try {
                const file = filename || urlToFilename(url);
                const path = `schemas/${file}`;
                
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Only add auth if user has write access
                if (hasWriteAccess()) {
                    headers['Authorization'] = `token ${githubConfig.token}`;
                }
                
                const response = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${path}?ref=${config.branch}`,
                    { headers }
                );
                
                if (!response.ok) {
                    return null;
                }
                
                const data = await response.json();
                return JSON.parse(base64ToUtf8(data.content));
            } catch (error) {
                console.error('Error loading from GitHub:', error);
                return null;
            }
        }

        async function viewStoredSchema(url) {
            const schemaData = await getSchemaFromGitHub(url);
            if (!schemaData) {
                alert('Failed to load schema');
                return;
            }
            
            // Create a temporary result to display
            generatedSchemas = [{
                url: url,
                schema: schemaData.currentSchema,
                success: true
            }];
            
            // Close browse modal
            document.querySelector('.modal-overlay').remove();
            
            // Display the schema
            displayResults();
            document.getElementById('resultsSection').style.display = 'block';
            enableAccordion(); // Enable accordion when viewing stored schemas
        }

        async function deleteStoredSchema(url, buttonElement) {
            const success = await deleteSchemaFromGitHub(url);
            if (success) {
                // Remove the item from the list
                buttonElement.closest('div[style*="margin-bottom: 1rem"]').remove();
                
                // Check if list is now empty
                const schemasList = document.getElementById('schemasList');
                if (schemasList.children.length === 0) {
                    schemasList.innerHTML = '<div style="padding: 2rem; color: #666;">No schemas found. Generate some schemas to get started!</div>';
                }
            }
        }

        // GitHub API Functions
        async function saveSchemaToGitHub(url, schema) {
            if (!isGitHubConfigured()) {
                console.warn('GitHub not configured, skipping save');
                return;
            }

            const maxRetries = 3;
            let lastError = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const filename = urlToFilename(url);
                    const timestamp = new Date().toISOString();
                    const path = `schemas/${filename}`;
                    
                    // Always fetch fresh data before each attempt
                    let existingContent = null;
                    let existingSha = null;
                    
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}?ref=${githubConfig.branch}&t=${Date.now()}`, // Cache bust
                        {
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        existingSha = data.sha;
                        try {
                            existingContent = JSON.parse(base64ToUtf8(data.content));
                        } catch (e) {
                            console.warn('Failed to parse existing content, starting fresh');
                        }
                    }
                    
                    // Build version history
                    const history = existingContent?.history || [];
                    history.push({
                        schema: schema,
                        timestamp: timestamp,
                        version: history.length + 1
                    });
                    
                    // Keep only last 10 versions
                    if (history.length > 10) {
                        history.shift();
                    }
                    
                    const fileContent = {
                        url: url,
                        currentSchema: schema,
                        history: history,
                        lastUpdated: timestamp
                    };
                    
                    // Save to GitHub
                    const content = utf8ToBase64(JSON.stringify(fileContent, null, 2));
                    const commitMessage = `Update schema for ${url} - Version ${history.length}`;
                    
                    const putResponse = await fetch(
                        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${githubConfig.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                message: commitMessage,
                                content: content,
                                branch: githubConfig.branch,
                                ...(existingSha && { sha: existingSha })
                            })
                        }
                    );
                    
                    if (putResponse.ok) {
                        console.log(`✓ Schema saved to GitHub: ${path}`);
                        return; // Success!
                    }
                    
                    const error = await putResponse.json();
                    lastError = error;
                    
                    // If SHA mismatch and we have retries left, wait and try again
                    if (error.message && error.message.includes('does not match') && attempt < maxRetries - 1) {
                        console.log(`⚠ SHA mismatch on attempt ${attempt + 1}/${maxRetries}, retrying in ${(attempt + 1)}s...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                        continue;
                    }
                    
                    // Other error or final attempt
                    throw new Error(error.message);
                    
                } catch (error) {
                    lastError = error;
                    if (attempt < maxRetries - 1) {
                        console.log(`⚠ Error on attempt ${attempt + 1}/${maxRetries}: ${error.message}`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (attempt + 1)));
                    }
                }
            }
            
            // All retries failed
            console.error(`✗ Failed to save ${url} to GitHub after ${maxRetries} attempts:`, lastError);
            console.warn(`Skipping GitHub save for ${url} - schema will still be generated locally`);
        }

        function urlToFilename(url) {
            // Convert URL to safe filename
            return url
                .replace(/^https?:\/\//, '')
                .replace(/[^a-z0-9]/gi, '_')
                .toLowerCase()
                .substring(0, 200) + '.json';
        }

        // UTF-8 safe base64 encoding/decoding
        function utf8ToBase64(str) {
            return btoa(unescape(encodeURIComponent(str)));
        }

        function base64ToUtf8(str) {
            return decodeURIComponent(escape(atob(str)));
        }

        async function getVersionHistory(url) {
            const data = await getSchemaFromGitHub(url);
            return data?.history || [];
        }

        async function deleteSchemaFromGitHub(url) {
            if (!isGitHubConfigured()) {
                alert('GitHub not configured');
                return false;
            }

            if (!confirm(`Are you sure you want to delete the schema for:\n${url}\n\nThis will remove all version history.`)) {
                return false;
            }

            try {
                const filename = urlToFilename(url);
                const path = `schemas/${filename}`;
                
                // Get current file SHA
                const getResponse = await fetch(
                    `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}?ref=${githubConfig.branch}`,
                    {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!getResponse.ok) {
                    throw new Error('Schema not found in GitHub');
                }
                
                const data = await getResponse.json();
                
                // Delete the file
                const deleteResponse = await fetch(
                    `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Delete schema for ${url}`,
                            sha: data.sha,
                            branch: githubConfig.branch
                        })
                    }
                );
                
                if (!deleteResponse.ok) {
                    const error = await deleteResponse.json();
                    throw new Error(`Failed to delete: ${error.message}`);
                }
                
                alert('Schema deleted successfully');
                return true;
            } catch (error) {
                console.error('Error deleting schema:', error);
                alert('Failed to delete schema: ' + error.message);
                return false;
            }
        }

        async function listAllSchemas() {
            const config = getReadConfig();

            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Only add auth header if user has write access
                if (hasWriteAccess()) {
                    headers['Authorization'] = `token ${githubConfig.token}`;
                }

                const response = await fetch(
                    `https://api.github.com/repos/${config.owner}/${config.repo}/contents/schemas?ref=${config.branch}`,
                    { headers }
                );
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return []; // No schemas folder yet
                    }
                    throw new Error('Failed to list schemas');
                }
                
                const files = await response.json();
                return files.filter(file => file.name.endsWith('.json'));
            } catch (error) {
                console.error('Error listing schemas:', error);
                alert('Failed to list schemas: ' + error.message);
                return [];
            }
        }
        
        function compareSchemas(schema1, schema2) {
            const changes = {
                added: [],
                removed: [],
                modified: []
            };
            
            const obj1 = JSON.parse(schema1);
            const obj2 = JSON.parse(schema2);
            
            findDifferences(obj1, obj2, '', changes);
            
            return changes;
        }
        
        function findDifferences(obj1, obj2, path, changes) {
            const allKeys = new Set([...Object.keys(obj1), ...Object.keys(obj2)]);
            
            for (const key of allKeys) {
                const currentPath = path ? `${path}.${key}` : key;
                const val1 = obj1[key];
                const val2 = obj2[key];
                
                if (!(key in obj2)) {
                    changes.removed.push({ path: currentPath, value: val1 });
                } else if (!(key in obj1)) {
                    changes.added.push({ path: currentPath, value: val2 });
                } else if (typeof val1 !== typeof val2) {
                    changes.modified.push({ path: currentPath, oldValue: val1, newValue: val2 });
                } else if (typeof val1 === 'object' && val1 !== null && val2 !== null) {
                    if (Array.isArray(val1) && Array.isArray(val2)) {
                        if (JSON.stringify(val1) !== JSON.stringify(val2)) {
                            changes.modified.push({ path: currentPath, oldValue: val1, newValue: val2 });
                        }
                    } else {
                        findDifferences(val1, val2, currentPath, changes);
                    }
                } else if (val1 !== val2) {
                    changes.modified.push({ path: currentPath, oldValue: val1, newValue: val2 });
                }
            }
        }

        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const generateBtn = document.getElementById('generateBtn');
        const uploadSection = document.getElementById('uploadSection');
        const progressSection = document.getElementById('progressSection');
        const uploadHeader = document.getElementById('uploadHeader');

        function enableAccordion() {
            uploadHeader.classList.add('clickable');
            uploadHeader.onclick = toggleUploadSection;
        }

        function disableAccordion() {
            uploadHeader.classList.remove('clickable');
            uploadHeader.onclick = null;
            uploadSection.classList.remove('collapsed');
        }

        function switchTab(tabName, tabIndex) {
            // Update data-active attribute for sliding border
            document.querySelector('.tabs').setAttribute('data-active', tabIndex);

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Update header text and show appropriate tab
            const uploadHeader = document.querySelector('.upload-header h2');
            if (tabName === 'spreadsheet') {
                uploadHeader.textContent = 'Upload Spreadsheet';
                document.getElementById('spreadsheetTab').classList.add('active');
            } else {
                uploadHeader.textContent = 'Generate from URL';
                document.getElementById('singleTab').classList.add('active');
            }
        }

        function toggleUploadSection() {
            uploadSection.classList.toggle('collapsed');
        }

        function closeResults() {
            document.getElementById('resultsSection').style.display = 'none';
            // Expand upload section and disable accordion
            uploadSection.classList.remove('collapsed');
            disableAccordion();
        }

        // Single URL input handler
        const singleUrlInput = document.getElementById('singleUrlInput');
        const generateSingleBtn = document.getElementById('generateSingleBtn');

        singleUrlInput.addEventListener('input', (e) => {
            const url = e.target.value.trim();
            generateSingleBtn.disabled = !url;
        });

        // Single URL generate handler
        generateSingleBtn.addEventListener('click', async () => {
            const url = singleUrlInput.value.trim();
            
            if (!url) {
                alert('Please enter a URL');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('Please enter a valid URL starting with http:// or https://');
                return;
            }

            // Set up data and use the same batch logic
            uploadedData = [{ url: url }];
            
            // Disable single URL button and enable main generate button temporarily
            generateSingleBtn.disabled = true;
            generateBtn.disabled = false;
            
            // Trigger the main generate button (uses same logic for both)
            generateBtn.click();
            
            // Clean up - clear input after generation starts
            setTimeout(() => {
                singleUrlInput.value = '';
                generateSingleBtn.disabled = false;
            }, 500);
        });

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });

        function handleFile(file) {
            const reader = new FileReader();
            
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        alert('The spreadsheet appears to be empty');
                        return;
                    }

                    const firstRow = jsonData[0];
                    const urlKey = Object.keys(firstRow).find(key => 
                        key.toLowerCase() === 'url' || key.toLowerCase() === 'urls'
                    );

                    if (!urlKey) {
                        alert('Could not find a "URL" column in your spreadsheet.');
                        return;
                    }

                    uploadedData = jsonData.map(row => ({
                        url: row[urlKey]
                    })).filter(row => row.url);

                    generateBtn.disabled = false;
                    uploadZone.querySelector('p').textContent = `✓ Loaded ${uploadedData.length} URLs`;
                    uploadZone.querySelector('p').style.color = '#2e7d32';
                } catch (error) {
                    console.error('Error parsing file:', error);
                    alert('Error parsing file. Please ensure it\'s a valid CSV or Excel file.');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        generateBtn.addEventListener('click', async () => {
            if (uploadedData.length === 0) return;

            // Collapse upload section
            uploadSection.classList.add('collapsed');
            
            // Show and animate progress section
            progressSection.style.display = 'block';
            setTimeout(() => progressSection.classList.add('show'), 10);
            
            document.getElementById('resultsSection').style.display = 'none';
            generateBtn.disabled = true;

            generatedSchemas = [];
            const total = uploadedData.length;

            for (let i = 0; i < uploadedData.length; i++) {
                const item = uploadedData[i];
                updateProgress(i + 1, total, `Scraping ${item.url}`);

                try {
                    // Scrape the page
                    const pageData = await scrapePage(item.url);
                    
                    // Extract site config from first page
                    if (i === 0) {
                        siteConfig = extractSiteConfig(pageData);
                    }
                    
                    // Generate schema
                    const schema = generateSchemaFromPageData(pageData, siteConfig);
                    const schemaJson = JSON.stringify(schema, null, 2);
                    
                    // Save to GitHub
                    await saveSchemaToGitHub(item.url, schemaJson);
                    
                    generatedSchemas.push({
                        url: item.url,
                        schema: schemaJson,
                        success: true
                    });
                } catch (error) {
                    console.error(`Error processing ${item.url}:`, error);
                    generatedSchemas.push({
                        url: item.url,
                        error: error.message,
                        success: false
                    });
                }

                await new Promise(resolve => setTimeout(resolve, 100));
            }

            displayResults();
            progressSection.classList.remove('show');
            setTimeout(() => progressSection.style.display = 'none', 400);
            document.getElementById('resultsSection').style.display = 'block';
            enableAccordion(); // Enable accordion when results are shown
            generateBtn.disabled = false;
        });

        async function scrapePage(url) {
            // List of CORS proxies to try - Cloudflare Worker first (most reliable)
            const proxies = [
                { name: 'CloudflareWorker', url: `https://schema-cors-proxy.bcbs-of-az.workers.dev/?url=${encodeURIComponent(url)}` },
                { name: 'Direct', url: url }, // Try direct in case CORS is allowed
                { name: 'AllOrigins', url: `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, parseResponse: (data) => JSON.parse(data).contents },
                { name: 'CorsAnywhere', url: `https://cors-anywhere.herokuapp.com/${url}` },
                { name: 'ThingProxy', url: `https://thingproxy.freeboard.io/fetch/${url}` },
                { name: 'CorsProxy', url: `https://corsproxy.io/?${encodeURIComponent(url)}` },
                { name: 'ProxyThis', url: `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}` }
            ];
            
            let lastError = null;
            
            // Try each proxy
            for (let i = 0; i < proxies.length; i++) {
                const proxy = proxies[i];
                try {
                    console.log(`Attempting to fetch via: ${proxy.name}`);
                    
                    // Show clock icon and update text when trying proxies
                    const progressClock = document.getElementById('progressClock');
                    const statusTextContent = document.getElementById('statusTextContent');
                    if (statusTextContent && i > 0) {
                        // Only show clock on retry attempts
                        if (progressClock) progressClock.style.display = 'inline-block';
                        statusTextContent.textContent = `Fetching ${url}...`;
                    }
                    
                    const response = await fetch(proxy.url, {
                        method: 'GET',
                        headers: proxy.name === 'Direct' ? {
                            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                        } : {}
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    let html = await response.text();
                    
                    // Use custom parser if provided (e.g., for AllOrigins JSON response)
                    if (proxy.parseResponse) {
                        try {
                            html = proxy.parseResponse(html);
                        } catch (parseError) {
                            throw new Error(`Failed to parse proxy response: ${parseError.message}`);
                        }
                    }
                    
                    // Validate that we got actual HTML
                    if (!html || html.trim().length < 100) {
                        throw new Error('Response too short or empty');
                    }
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Check if parsing was successful
                    if (!doc || !doc.body) {
                        throw new Error('Failed to parse HTML');
                    }
                    
                    console.log(`✓ Successfully fetched via: ${proxy.name}`);
                    
                    // Hide clock on success
                    if (progressClock) progressClock.style.display = 'none';
                    
                    return {
                        url: url,
                        doc: doc,
                        html: html
                    };
                } catch (error) {
                    console.warn(`✗ Failed with ${proxy.name}: ${error.message}`);
                    lastError = error;
                    // Continue to next proxy
                    
                    // Add small delay between proxy attempts to avoid hammering
                    if (i < proxies.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }
            }
            
            // All proxies failed - provide helpful error message
            const errorMsg = `Unable to fetch ${url}. All fetch methods failed. This may be due to:\n` +
                           `• Site blocking automated requests\n` +
                           `• CORS proxy rate limits or downtime\n` +
                           `• Network connectivity issues\n\n` +
                           `Suggestion: Try again in a few minutes or use a different URL.\n\n` +
                           `Last error: ${lastError.message}`;
            throw new Error(errorMsg);
        }

        function extractSiteConfig(pageData) {
            const doc = pageData.doc;
            const url = new URL(pageData.url);
            
            // Extract organization info from page
            const config = {
                websiteUrl: url.origin,
                orgName: null,
                orgShortName: null,
                logoUrl: null,
                phones: {
                    sales: null,
                    service: null,
                    tty: null
                },
                areaServed: 'US'
            };

            // Try to find organization name from meta tags or content
            const ogSiteName = doc.querySelector('meta[property="og:site_name"]');
            if (ogSiteName) {
                config.orgShortName = ogSiteName.content;
            }

            // Try to find from title
            const title = doc.querySelector('title');
            if (title && title.textContent.includes('|')) {
                const parts = title.textContent.split('|');
                config.orgShortName = parts[parts.length - 1].trim();
            }

            // Find logo
            const logo = doc.querySelector('meta[property="og:image"]') || 
                        doc.querySelector('link[rel="icon"]') ||
                        doc.querySelector('img[class*="logo"]');
            if (logo) {
                config.logoUrl = logo.content || logo.href || logo.src;
                if (config.logoUrl && !config.logoUrl.startsWith('http')) {
                    config.logoUrl = url.origin + config.logoUrl;
                }
            }

            // Find phone numbers in page content
            const bodyText = doc.body.textContent;
            const phoneRegex = /(\+?1[-.\s]?)?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/g;
            const phones = bodyText.match(phoneRegex);
            if (phones && phones.length > 0) {
                config.phones.service = phones[0].replace(/\s+/g, '-');
            }

            // Check for TTY
            if (bodyText.includes('TTY') || bodyText.includes('711')) {
                config.phones.tty = '711';
            }

            return config;
        }

        function generateSchemaFromPageData(pageData, siteConfig) {
            const doc = pageData.doc;
            const url = new URL(pageData.url);
            const path = url.pathname;
            const segments = path.split('/').filter(s => s);

            // Extract page metadata
            const title = doc.querySelector('title')?.textContent || 
                         doc.querySelector('meta[property="og:title"]')?.content ||
                         doc.querySelector('h1')?.textContent;
            
            const description = doc.querySelector('meta[name="description"]')?.content ||
                               doc.querySelector('meta[property="og:description"]')?.content;

            // Extract image information
            const ogImage = doc.querySelector('meta[property="og:image"]')?.content || 
                           doc.querySelector('meta[name="twitter:image"]')?.content ||
                           siteConfig.logoUrl;
            
            const ogImageWidth = doc.querySelector('meta[property="og:image:width"]')?.content || 1200;
            const ogImageHeight = doc.querySelector('meta[property="og:image:height"]')?.content || 630;

            // Get publish/modified dates if available
            const datePublished = doc.querySelector('meta[property="article:published_time"]')?.content ||
                                 doc.querySelector('meta[name="date"]')?.content ||
                                 doc.querySelector('time[datetime]')?.getAttribute('datetime');
            
            const dateModified = doc.querySelector('meta[property="article:modified_time"]')?.content ||
                                doc.querySelector('meta[property="og:updated_time"]')?.content;

            const pageType = determinePageType(path, doc);

            // Build enhanced schema with all SEO-beneficial properties
            const schema = {
                "@context": "https://schema.org",
                "@type": "WebPage",
                "@id": `${pageData.url}#webpage`,
                "url": pageData.url,
                "name": title || '',
                "description": description || '',
                "inLanguage": "en-US",
                "isPartOf": {
                    "@type": "WebSite",
                    "@id": `${siteConfig.websiteUrl}/#website`,
                    "url": siteConfig.websiteUrl,
                    "name": siteConfig.orgName || siteConfig.orgShortName || extractDomainName(url.hostname),
                    "inLanguage": "en-US"
                },
                "primaryImageOfPage": {
                    "@type": "ImageObject",
                    "@id": `${pageData.url}#primaryimage`,
                    "url": ogImage || '',
                    "width": parseInt(ogImageWidth) || 1200,
                    "height": parseInt(ogImageHeight) || 630
                },
                "breadcrumb": {
                    "@type": "BreadcrumbList",
                    "@id": `${pageData.url}#breadcrumb`,
                    "itemListElement": []
                },
                "publisher": {
                    "@type": "Organization",
                    "@id": `${siteConfig.websiteUrl}/#organization`,
                    "name": siteConfig.orgName || siteConfig.orgShortName || extractDomainName(url.hostname),
                    "url": siteConfig.websiteUrl,
                    "logo": {
                        "@type": "ImageObject",
                        "@id": `${siteConfig.websiteUrl}/#logo`,
                        "url": siteConfig.logoUrl || '',
                        "width": 300,
                        "height": 60
                    },
                    "contactPoint": []
                },
                "about": {
                    "@type": "Service",
                    "name": '',
                    "provider": {
                        "@type": "Organization",
                        "@id": `${siteConfig.websiteUrl}/#organization`
                    },
                    "areaServed": {
                        "@type": "Country",
                        "name": "United States"
                    },
                    "audience": {
                        "@type": "PeopleAudience",
                        "name": ''
                    },
                    "serviceType": '',
                    "description": '',
                    "hasOfferCatalog": {
                        "@type": "OfferCatalog",
                        "name": '',
                        "itemListElement": [
                            {
                                "@type": "ItemList",
                                "itemListOrder": "http://schema.org/ItemListOrderAscending",
                                "numberOfItems": 0,
                                "itemListElement": []
                            }
                        ]
                    }
                },
                "mainEntity": {
                    "@type": "ItemList",
                    "name": '',
                    "itemListElement": []
                },
                "potentialAction": [
                    {
                        "@type": "SearchAction",
                        "target": {
                            "@type": "EntryPoint",
                            "urlTemplate": `${siteConfig.websiteUrl}/search?q={search_term_string}`
                        },
                        "query-input": "required name=search_term_string"
                    }
                ]
            };

            // Add dates if available (SEO benefit)
            if (datePublished) {
                schema.datePublished = datePublished;
            }
            if (dateModified) {
                schema.dateModified = dateModified;
            }

            // Build breadcrumbs with full item objects (better for rich results)
            if (segments.length > 0) {
                // Always include Home as first breadcrumb
                schema.breadcrumb.itemListElement.push({
                    "@type": "ListItem",
                    "position": 1,
                    "item": {
                        "@id": siteConfig.websiteUrl,
                        "name": "Home"
                    }
                });

                let currentPath = '';
                segments.forEach((segment, index) => {
                    currentPath += '/' + segment;
                    schema.breadcrumb.itemListElement.push({
                        "@type": "ListItem",
                        "position": index + 2,
                        "item": {
                            "@id": `${url.origin}${currentPath}`,
                            "name": segment.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                        }
                    });
                });
            }

            // Add enhanced contact points with more details
            if (siteConfig.phones.sales) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.sales,
                    "contactType": "Sales",
                    "areaServed": "US",
                    "availableLanguage": ["en", "es"]
                });
            }
            if (siteConfig.phones.service) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.service,
                    "contactType": "Customer Service",
                    "areaServed": "US",
                    "availableLanguage": ["en", "es"]
                });
            }
            if (siteConfig.phones.tty) {
                schema.publisher.contactPoint.push({
                    "@type": "ContactPoint",
                    "telephone": siteConfig.phones.tty,
                    "contactType": "TTY",
                    "areaServed": "US",
                    "availableLanguage": ["en"]
                });
            }

            // Extract service/product information from page content
            const mainHeading = doc.querySelector('h1')?.textContent;
            const bodyText = doc.body.textContent.toLowerCase();
            
            // Always fill in basic About section info
            schema.about.name = mainHeading || title || 'Content';
            schema.about.description = description || `Information about ${mainHeading || title}`;
            schema.about.serviceType = "Information";
            
            // Look for service indicators (plans, products, services mentioned)
            const hasServices = bodyText.includes('plan') || bodyText.includes('service') || 
                               bodyText.includes('product') || bodyText.includes('coverage') ||
                               bodyText.includes('benefit');
            
            if (hasServices && (path.includes('medicare') || path.includes('insurance') || 
                path.includes('plan') || path.includes('service'))) {
                
                // Override with comprehensive service details
                schema.about.serviceType = extractServiceType(mainHeading, bodyText);
                schema.about.description = description || `Comprehensive ${mainHeading || title} services and coverage options.`;

                // Try to find target audience
                const audienceMatch = bodyText.match(/(medicare[- ]eligible|seniors|individuals|families|businesses)/i);
                if (audienceMatch) {
                    schema.about.audience.name = audienceMatch[0].charAt(0).toUpperCase() + audienceMatch[0].slice(1);
                } else {
                    // Default audience for healthcare
                    schema.about.audience.name = "Medicare-eligible individuals";
                }

                // Try to extract specific area served from content (counties, states, etc.)
                const countyMatch = bodyText.match(/([A-Z][a-z]+\s+County,?\s*[A-Z]{2})/g);
                if (countyMatch && countyMatch.length > 0) {
                    // Add specific service areas as additional property
                    schema.about.additionalProperty = {
                        "@type": "PropertyValue",
                        "name": "Service Areas",
                        "value": countyMatch.slice(0, 5).map(county => ({
                            "@type": "AdministrativeArea",
                            "name": county
                        }))
                    };
                }

                // Look for specific plan/product mentions
                const planNames = extractPlanNames(doc);
                if (planNames.length > 0) {
                    schema.about.hasOfferCatalog.name = `${mainHeading || title} Plans`;
                    schema.about.hasOfferCatalog.itemListElement[0].numberOfItems = planNames.length;
                    schema.about.hasOfferCatalog.itemListElement[0].itemListElement = planNames.map((planName, idx) => ({
                        "@type": "Offer",
                        "name": planName,
                        "description": `${planName} - comprehensive coverage option`,
                        "url": pageData.url,
                        "availability": "https://schema.org/InStock",
                        "areaServed": "US"
                    }));

                    // Create mainEntity with full structure
                    schema.mainEntity.name = `Featured ${mainHeading || 'Plans'}`;
                    schema.mainEntity.itemListElement = planNames.map((planName, idx) => ({
                        "@type": "ListItem",
                        "position": idx + 1,
                        "item": {
                            "@type": "Service",
                            "name": planName,
                            "url": pageData.url,
                            "provider": { 
                                "@type": "Organization",
                                "@id": `${siteConfig.websiteUrl}/#organization` 
                            },
                            "areaServed": "US",
                            "serviceType": schema.about.serviceType
                        }
                    }));
                }
            }

            // Add additional action if CTA buttons found
            const ctaButtons = doc.querySelectorAll('a[href*="shop"], a[href*="enroll"], button');
            if (ctaButtons.length > 0) {
                const ctaText = Array.from(ctaButtons).find(btn => 
                    btn.textContent.toLowerCase().includes('shop') || 
                    btn.textContent.toLowerCase().includes('enroll') ||
                    btn.textContent.toLowerCase().includes('compare')
                );
                if (ctaText) {
                    schema.potentialAction.push({
                        "@type": "Action",
                        "name": ctaText.textContent.trim(),
                        "target": pageData.url
                    });
                }
            }

            // Clean up empty arrays and objects to improve validation scores
            cleanupEmptyFields(schema);

            return schema;
        }

        function cleanupEmptyFields(obj) {
            // Remove empty arrays, empty strings, and empty nested objects
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    
                    // Handle arrays
                    if (Array.isArray(value)) {
                        if (value.length === 0) {
                            delete obj[key];
                        } else {
                            // Recursively clean nested objects in arrays
                            value.forEach(item => {
                                if (typeof item === 'object' && item !== null) {
                                    cleanupEmptyFields(item);
                                }
                            });
                        }
                    }
                    // Handle objects
                    else if (typeof value === 'object' && value !== null) {
                        // Recursively clean nested objects
                        cleanupEmptyFields(value);
                        
                        // Remove object if it's empty after cleaning
                        if (Object.keys(value).length === 0) {
                            delete obj[key];
                        }
                        
                        // Special handling for specific empty patterns
                        if (key === 'hasOfferCatalog' && value.itemListElement) {
                            // Remove hasOfferCatalog if it has no actual offers
                            if (Array.isArray(value.itemListElement) && 
                                value.itemListElement.length > 0 &&
                                value.itemListElement[0].itemListElement &&
                                value.itemListElement[0].itemListElement.length === 0) {
                                delete obj[key];
                            }
                        }
                        
                        if (key === 'mainEntity' && value.itemListElement) {
                            // Remove mainEntity if it has no items
                            if (Array.isArray(value.itemListElement) && value.itemListElement.length === 0) {
                                delete obj[key];
                            }
                        }
                        
                        if (key === 'breadcrumb' && value.itemListElement) {
                            // Remove breadcrumb if it has no items
                            if (Array.isArray(value.itemListElement) && value.itemListElement.length === 0) {
                                delete obj[key];
                            }
                        }
                    }
                    // Handle empty strings (but keep explicitly set values like empty audience name)
                    else if (value === '' && !['name', 'description', 'serviceType'].includes(key)) {
                        delete obj[key];
                    }
                }
            }
        }

        function extractServiceType(heading, bodyText) {
            if (bodyText.includes('medicare advantage') || bodyText.includes('hmo')) {
                return 'Medicare Advantage (Part C) HMO';
            }
            if (bodyText.includes('medicare')) {
                return 'Medicare Insurance';
            }
            if (bodyText.includes('health insurance')) {
                return 'Health Insurance';
            }
            return heading || 'Insurance Services';
        }

        function extractPlanNames(doc) {
            const planNames = [];
            
            // Look for common plan name patterns
            const headings = doc.querySelectorAll('h2, h3, h4');
            headings.forEach(h => {
                const text = h.textContent.trim();
                // Match patterns like "Blue Best Life", "Plan Name (HMO)", etc.
                if (text.match(/(Plan|Plus|Classic|Premium|Basic|Standard|Elite|Select)/i) ||
                    text.match(/\(HMO\)|\(PPO\)|\(EPO\)/)) {
                    planNames.push(text);
                }
            });

            // Look in lists
            const listItems = doc.querySelectorAll('li');
            listItems.forEach(li => {
                const text = li.textContent.trim();
                if (text.length < 100 && text.match(/(Plan|Plus|Classic|Premium|HMO|PPO)/i)) {
                    planNames.push(text);
                }
            });

            // Deduplicate and limit
            return [...new Set(planNames)].slice(0, 5);
        }

        function determinePageType(path, doc) {
            if (path.includes('/blog/') || path.includes('/article/') || path.includes('/news/')) {
                return 'Article';
            }
            if (path.includes('/product/') || path.includes('/shop/')) {
                return 'Product';
            }
            if (path.includes('/faq')) {
                return 'FAQPage';
            }
            if (path.includes('/contact')) {
                return 'ContactPage';
            }
            if (path.includes('/about')) {
                return 'AboutPage';
            }
            return 'WebPage';
        }

        function extractDomainName(hostname) {
            const parts = hostname.replace('www.', '').split('.');
            return parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
        }

        function updateProgress(current, total, status) {
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('statusTextContent').textContent = `${status} (${current}/${total})`;
            
            // Hide clock when not retrying proxies
            document.getElementById('progressClock').style.display = 'none';
        }

        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            generatedSchemas.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                
                // Create header row with URL and buttons
                const headerRow = document.createElement('div');
                headerRow.className = 'result-header';
                
                const urlDiv = document.createElement('div');
                urlDiv.innerHTML = `
                    <div class="result-url">${result.url}</div>
                    ${result.success ? '<span style="color: #2e7d32; font-size: 0.85rem;">✓ Generated</span>' : '<span style="color: #d32f2f; font-size: 0.85rem;">✗ ' + result.error + '</span>'}
                `;

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'result-actions';

                if (result.success) {
                    const viewBtn = document.createElement('button');
                    viewBtn.innerHTML = '<i class="fa-regular fa-file-code"></i>';
                    viewBtn.className = 'icon-btn';
                    viewBtn.title = 'View JSON';
                    viewBtn.onclick = () => togglePreview(index);

                    const viewHtmlBtn = document.createElement('button');
                    viewHtmlBtn.innerHTML = '<i class="fa-regular fa-eye"></i>';
                    viewHtmlBtn.className = 'icon-btn';
                    viewHtmlBtn.title = 'View HTML';
                    viewHtmlBtn.onclick = () => toggleHtmlPreview(index);

                    const validateBtn = document.createElement('button');
                    validateBtn.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
                    validateBtn.className = 'icon-btn';
                    validateBtn.title = 'Validate Schema';
                    validateBtn.onclick = () => validateSchema(index);

                    const historyBtn = document.createElement('button');
                    historyBtn.innerHTML = '<i class="fa-regular fa-clock"></i>';
                    historyBtn.className = 'icon-btn';
                    historyBtn.title = 'View History';
                    historyBtn.onclick = async () => {
                        const urlHistory = await getVersionHistory(result.url);
                        if (urlHistory.length === 0) {
                            alert('No history found for this URL yet.');
                        } else {
                            await showHistory(index, result.url);
                        }
                    };

                    const copyBtn = document.createElement('button');
                    copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
                    copyBtn.className = 'icon-btn';
                    copyBtn.title = 'Copy to Clipboard';
                    copyBtn.onclick = () => {
                        const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                        navigator.clipboard.writeText(wrappedSchema);
                        const originalHTML = copyBtn.innerHTML;
                        copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        setTimeout(() => copyBtn.innerHTML = originalHTML, 2000);
                    };

                    const downloadBtn = document.createElement('button');
                    downloadBtn.innerHTML = '<i class="fa-solid fa-download"></i>';
                    downloadBtn.className = 'icon-btn';
                    downloadBtn.title = 'Download Schema';
                    downloadBtn.onclick = () => downloadSchema(result, index);

                    actionsDiv.appendChild(viewBtn);
                    actionsDiv.appendChild(viewHtmlBtn);
                    actionsDiv.appendChild(validateBtn);
                    actionsDiv.appendChild(historyBtn);
                    actionsDiv.appendChild(copyBtn);
                    actionsDiv.appendChild(downloadBtn);
                }

                headerRow.appendChild(urlDiv);
                headerRow.appendChild(actionsDiv);
                item.appendChild(headerRow);
                
                resultsList.appendChild(item);

                if (result.success) {
                    const preview = document.createElement('div');
                    preview.className = 'schema-preview';
                    preview.id = `preview-${index}`;
                    
                    // Wrap JSON in script tags - escape the closing script tag to prevent breaking
                    const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                    preview.innerHTML = `<pre>${escapeHtml(wrappedSchema)}</pre>`;
                    item.appendChild(preview);

                    const htmlPreview = document.createElement('div');
                    htmlPreview.className = 'html-preview';
                    htmlPreview.id = `html-preview-${index}`;
                    item.appendChild(htmlPreview);

                    const validationPreview = document.createElement('div');
                    validationPreview.className = 'html-preview';
                    validationPreview.id = `validation-preview-${index}`;
                    item.appendChild(validationPreview);

                    const historyPreview = document.createElement('div');
                    historyPreview.className = 'html-preview';
                    historyPreview.id = `history-preview-${index}`;
                    item.appendChild(historyPreview);
                }
            });
        }

        function togglePreview(index) {
            const preview = document.getElementById(`preview-${index}`);
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            
            // Close HTML preview if open
            if (htmlPreview.style.display === 'block') {
                htmlPreview.style.display = 'none';
            }
            
            // Toggle JSON preview
            preview.style.display = preview.style.display === 'none' || !preview.style.display ? 'block' : 'none';
        }

        function toggleHtmlPreview(index) {
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const historyPreview = document.getElementById(`history-preview-${index}`);
            const validationPreview = document.getElementById(`validation-preview-${index}`);
            
            if (!htmlPreview) {
                console.error('HTML preview element not found for index:', index);
                return;
            }
            
            // Close other previews if open
            if (preview && preview.style.display === 'block') {
                preview.style.display = 'none';
            }
            if (historyPreview && historyPreview.style.display === 'block') {
                historyPreview.style.display = 'none';
            }
            if (validationPreview && validationPreview.style.display === 'block') {
                validationPreview.style.display = 'none';
            }
            
            const isVisible = htmlPreview.style.display === 'block';
            
            if (!isVisible) {
                try {
                    const schema = generatedSchemas[index].schema;
                    const htmlContent = generateHTMLFromSchema(schema);
                    htmlPreview.innerHTML = htmlContent;
                    htmlPreview.style.display = 'block';
                } catch (error) {
                    console.error('Error generating HTML preview:', error);
                    htmlPreview.innerHTML = '<div style="padding: 2rem; color: #d32f2f;">Error generating preview: ' + error.message + '</div>';
                    htmlPreview.style.display = 'block';
                }
            } else {
                htmlPreview.style.display = 'none';
            }
        }

        async function showHistory(index, url) {
            const historyPreview = document.getElementById(`history-preview-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            const validationPreview = document.getElementById(`validation-preview-${index}`);
            
            // Close other previews if open
            if (preview.style.display === 'block') {
                preview.style.display = 'none';
            }
            if (htmlPreview.style.display === 'block') {
                htmlPreview.style.display = 'none';
            }
            if (validationPreview.style.display === 'block') {
                validationPreview.style.display = 'none';
            }
            
            const isVisible = historyPreview.style.display === 'block';
            
            if (!isVisible) {
                historyPreview.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">Loading history...</div>';
                historyPreview.style.display = 'block';
                
                const history = await getVersionHistory(url);
                const currentSchema = generatedSchemas[index].schema;
                const htmlContent = generateHistoryView(url, history, currentSchema);
                historyPreview.innerHTML = htmlContent;
            } else {
                historyPreview.style.display = 'none';
            }
        }

        function validateSchema(index) {
            const validationPreview = document.getElementById(`validation-preview-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const htmlPreview = document.getElementById(`html-preview-${index}`);
            const historyPreview = document.getElementById(`history-preview-${index}`);
            
            // Close other previews if open
            if (preview.style.display === 'block') {
                preview.style.display = 'none';
            }
            if (htmlPreview.style.display === 'block') {
                htmlPreview.style.display = 'none';
            }
            if (historyPreview.style.display === 'block') {
                historyPreview.style.display = 'none';
            }
            
            const isVisible = validationPreview.style.display === 'block';
            
            if (!isVisible) {
                const schema = generatedSchemas[index].schema;
                const validationResults = performValidation(schema);
                const htmlContent = generateValidationView(validationResults);
                validationPreview.innerHTML = htmlContent;
                validationPreview.style.display = 'block';
            } else {
                validationPreview.style.display = 'none';
            }
        }

        function performValidation(schemaJson) {
            const results = {
                score: 100,
                errors: [],
                warnings: [],
                suggestions: [],
                passed: []
            };

            try {
                const schema = JSON.parse(schemaJson);
                
                // Required fields check
                if (!schema['@context']) {
                    results.errors.push({ field: '@context', message: 'Missing required @context field' });
                    results.score -= 20;
                } else {
                    results.passed.push({ field: '@context', message: 'Context defined correctly' });
                }

                if (!schema['@type']) {
                    results.errors.push({ field: '@type', message: 'Missing required @type field' });
                    results.score -= 20;
                } else {
                    results.passed.push({ field: '@type', message: 'Type defined: ' + schema['@type'] });
                }

                if (!schema.name || schema.name === '') {
                    results.warnings.push({ field: 'name', message: 'Name field is empty or missing' });
                    results.score -= 10;
                } else {
                    results.passed.push({ field: 'name', message: 'Name present' });
                }

                if (!schema.description || schema.description === '') {
                    results.warnings.push({ field: 'description', message: 'Description is recommended for better SEO' });
                    results.score -= 5;
                } else {
                    results.passed.push({ field: 'description', message: 'Description present' });
                }

                // URL validation
                if (!schema.url) {
                    results.warnings.push({ field: 'url', message: 'URL field is missing' });
                    results.score -= 5;
                } else if (!schema.url.startsWith('http')) {
                    results.errors.push({ field: 'url', message: 'URL must start with http:// or https://' });
                    results.score -= 10;
                } else {
                    results.passed.push({ field: 'url', message: 'Valid URL format' });
                }

                // Breadcrumb validation
                if (schema.breadcrumb) {
                    if (!schema.breadcrumb.itemListElement || schema.breadcrumb.itemListElement.length === 0) {
                        results.warnings.push({ field: 'breadcrumb', message: 'Breadcrumb exists but has no items' });
                        results.score -= 5;
                    } else {
                        results.passed.push({ field: 'breadcrumb', message: schema.breadcrumb.itemListElement.length + ' breadcrumb items' });
                    }
                }

                // Publisher validation
                if (schema.publisher) {
                    if (!schema.publisher.name || schema.publisher.name === '') {
                        results.warnings.push({ field: 'publisher.name', message: 'Publisher name is empty' });
                        results.score -= 5;
                    } else {
                        results.passed.push({ field: 'publisher', message: 'Publisher information complete' });
                    }

                    if (schema.publisher.contactPoint && schema.publisher.contactPoint.length === 0) {
                        results.suggestions.push({ field: 'publisher.contactPoint', message: 'Consider adding contact points for better discoverability' });
                    } else if (schema.publisher.contactPoint && schema.publisher.contactPoint.length > 0) {
                        results.passed.push({ field: 'contactPoint', message: schema.publisher.contactPoint.length + ' contact point(s)' });
                    }
                } else {
                    results.warnings.push({ field: 'publisher', message: 'Publisher information is recommended' });
                    results.score -= 5;
                }

                // Image validation
                if (schema.primaryImageOfPage) {
                    if (!schema.primaryImageOfPage.url || schema.primaryImageOfPage.url === '') {
                        results.warnings.push({ field: 'primaryImageOfPage.url', message: 'Image URL is empty' });
                        results.score -= 3;
                    } else {
                        results.passed.push({ field: 'primaryImageOfPage', message: 'Primary image defined' });
                    }
                }

                // About section validation
                if (schema.about) {
                    if (!schema.about.name || schema.about.name === '') {
                        results.warnings.push({ field: 'about.name', message: 'About section exists but name is empty' });
                        results.score -= 3;
                    } else {
                        results.passed.push({ field: 'about', message: 'About section complete' });
                    }
                } else {
                    results.suggestions.push({ field: 'about', message: 'Consider adding "about" section for richer context' });
                }

                // MainEntity validation
                if (schema.mainEntity) {
                    if (!schema.mainEntity.itemListElement || schema.mainEntity.itemListElement.length === 0) {
                        results.warnings.push({ field: 'mainEntity', message: 'MainEntity exists but has no items' });
                        results.score -= 3;
                    } else {
                        results.passed.push({ field: 'mainEntity', message: schema.mainEntity.itemListElement.length + ' main entities' });
                    }
                }

                // Ensure score doesn't go below 0
                results.score = Math.max(0, results.score);

            } catch (error) {
                results.errors.push({ field: 'JSON', message: 'Invalid JSON: ' + error.message });
                results.score = 0;
            }

            return results;
        }

        function generateValidationView(results) {
            let html = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif;">';
            
            // Score header
            const scoreColor = results.score >= 80 ? '#2e7d32' : results.score >= 60 ? '#ed6c02' : '#d32f2f';
            html += '<div style="text-align: center; padding: 2rem; border: 1px solid #e0e0e0; margin-bottom: 1.5rem;">';
            html += '<div style="font-size: 3rem; font-weight: 300; color: ' + scoreColor + ';">' + results.score + '</div>';
            html += '<div style="font-size: 0.9rem; color: #666; text-transform: uppercase; letter-spacing: 0.1em;">Validation Score</div>';
            html += '</div>';

            // Summary
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">';
            html += '<div style="text-align: center; padding: 1rem; border: 1px solid #e0e0e0;">';
            html += '<div style="font-size: 1.5rem; color: #d32f2f;">' + results.errors.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Errors</div>';
            html += '</div>';
            html += '<div style="text-align: center; padding: 1rem; border: 1px solid #e0e0e0;">';
            html += '<div style="font-size: 1.5rem; color: #ed6c02;">' + results.warnings.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Warnings</div>';
            html += '</div>';
            html += '<div style="text-align: center; padding: 1rem; border: 1px solid #e0e0e0;">';
            html += '<div style="font-size: 1.5rem; color: #2e7d32;">' + results.passed.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Passed</div>';
            html += '</div>';
            html += '</div>';

            // Errors
            if (results.errors.length > 0) {
                html += '<div style="margin-bottom: 1.5rem;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; color: #d32f2f; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Errors</h3>';
                results.errors.forEach(error => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 1rem; border: 1px solid #d32f2f; background: #ffebee;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.25rem;">' + escapeHtml(error.field) + '</div>';
                    html += '<div style="font-size: 0.9rem; color: #666;">' + escapeHtml(error.message) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Warnings
            if (results.warnings.length > 0) {
                html += '<div style="margin-bottom: 1.5rem;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; color: #ed6c02; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Warnings</h3>';
                results.warnings.forEach(warning => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 1rem; border: 1px solid #ed6c02; background: #fff3e0;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.25rem;">' + escapeHtml(warning.field) + '</div>';
                    html += '<div style="font-size: 0.9rem; color: #666;">' + escapeHtml(warning.message) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Suggestions
            if (results.suggestions.length > 0) {
                html += '<div style="margin-bottom: 1.5rem;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; color: #1976d2; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Suggestions</h3>';
                results.suggestions.forEach(suggestion => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 1rem; border: 1px solid #1976d2; background: #e3f2fd;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.25rem;">' + escapeHtml(suggestion.field) + '</div>';
                    html += '<div style="font-size: 0.9rem; color: #666;">' + escapeHtml(suggestion.message) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Passed checks
            if (results.passed.length > 0) {
                html += '<div>';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; color: #2e7d32; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Passed Checks</h3>';
                results.passed.forEach(pass => {
                    html += '<div style="margin-bottom: 0.5rem; padding: 0.75rem; border: 1px solid #e0e0e0; background: #f9f9f9;">';
                    html += '<div style="font-size: 0.9rem;"><strong>' + escapeHtml(pass.field) + ':</strong> ' + escapeHtml(pass.message) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function generateHistoryView(url, history, currentSchema) {
            let html = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif;">';
            html += '<h3 style="margin: 0 0 1.5rem 0; font-weight: 300; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.75rem;">Version History</h3>';
            
            html += '<div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e0e0e0; background: #fafafa;">';
            html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">URL</div>';
            html += '<div style="word-break: break-all; font-size: 0.9rem;">' + escapeHtml(url) + '</div>';
            html += '</div>';

            html += '<div style="margin-bottom: 1rem;">';
            html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">Total Versions: ' + history.length + '</div>';
            html += '</div>';

            // Show each version
            history.forEach((version, idx) => {
                const versionDate = new Date(version.timestamp);
                const isLatest = idx === history.length - 1;
                
                html += '<div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #e0e0e0; ' + (isLatest ? 'background: #f9f9f9;' : '') + '">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #e0e0e0;">';
                html += '<div>';
                html += '<div style="font-weight: 400; margin-bottom: 0.25rem;">Version ' + version.version + (isLatest ? ' (Latest)' : '') + '</div>';
                html += '<div style="font-size: 0.85rem; color: #666;">' + versionDate.toLocaleString() + '</div>';
                html += '</div>';
                html += '<button onclick="compareVersion(\'' + url + '\', ' + idx + ')" style="padding: 0.5rem 1rem; background: #1a1a1a; color: white; border: none; cursor: pointer; font-size: 0.85rem;">Compare to Current</button>';
                html += '</div>';
                
                // Show a preview of key fields
                try {
                    const schema = JSON.parse(version.schema);
                    html += '<div style="font-size: 0.9rem;">';
                    html += '<div style="margin-bottom: 0.25rem;"><span style="color: #666;">Name:</span> ' + escapeHtml(schema.name || 'N/A') + '</div>';
                    html += '<div style="margin-bottom: 0.25rem;"><span style="color: #666;">Type:</span> ' + escapeHtml(schema['@type'] || 'N/A') + '</div>';
                    if (schema.description) {
                        html += '<div style="margin-bottom: 0.25rem;"><span style="color: #666;">Description:</span> ' + escapeHtml(schema.description.substring(0, 100)) + (schema.description.length > 100 ? '...' : '') + '</div>';
                    }
                    html += '</div>';
                } catch (e) {
                    html += '<div style="color: #999; font-size: 0.85rem;">Unable to parse schema</div>';
                }
                
                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        async function compareVersion(url, versionIndex) {
            const history = await getVersionHistory(url);
            const oldVersion = history[versionIndex];
            const currentSchema = generatedSchemas.find(s => s.url === url)?.schema;
            
            if (!currentSchema) return;
            
            const changes = compareSchemas(oldVersion.schema, currentSchema);
            showComparisonModal(url, oldVersion, currentSchema, changes);
        }

        function showComparisonModal(url, oldVersion, currentSchema, changes) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 2rem;';
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = 'background: white; max-width: 1200px; width: 100%; max-height: 90vh; overflow: auto; padding: 2rem; position: relative;';
            
            const versionDate = new Date(oldVersion.timestamp);
            
            let html = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif;">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e0e0e0;">';
            html += '<h2 style="margin: 0; font-weight: 300; font-size: 1.5rem;">Schema Comparison</h2>';
            html += '<button onclick="this.closest(\'.modal-overlay\').remove()" style="background: #1a1a1a; color: white; border: none; padding: 0.5rem 1.5rem; cursor: pointer;">Close</button>';
            html += '</div>';
            
            html += '<div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e0e0e0; background: #fafafa;">';
            html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">Comparing</div>';
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
            html += '<div><strong>Version ' + oldVersion.version + '</strong><br><span style="font-size: 0.85rem; color: #666;">' + versionDate.toLocaleString() + '</span></div>';
            html += '<div><strong>Current Version</strong><br><span style="font-size: 0.85rem; color: #666;">' + new Date().toLocaleString() + '</span></div>';
            html += '</div></div>';

            // Summary
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">';
            html += '<div style="padding: 1rem; border: 1px solid #e0e0e0; text-align: center;">';
            html += '<div style="font-size: 1.5rem; font-weight: 300; color: #2e7d32;">' + changes.added.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Added</div>';
            html += '</div>';
            html += '<div style="padding: 1rem; border: 1px solid #e0e0e0; text-align: center;">';
            html += '<div style="font-size: 1.5rem; font-weight: 300; color: #ed6c02;">' + changes.modified.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Modified</div>';
            html += '</div>';
            html += '<div style="padding: 1rem; border: 1px solid #e0e0e0; text-align: center;">';
            html += '<div style="font-size: 1.5rem; font-weight: 300; color: #d32f2f;">' + changes.removed.length + '</div>';
            html += '<div style="font-size: 0.85rem; color: #666;">Removed</div>';
            html += '</div>';
            html += '</div>';

            // Changes details
            if (changes.added.length > 0) {
                html += '<div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #2e7d32; background: #f1f8f4;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; font-size: 1.1rem; color: #2e7d32;">Added Fields</h3>';
                changes.added.forEach(change => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: white; border-left: 3px solid #2e7d32;">';
                    html += '<div style="font-family: monospace; font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">' + escapeHtml(change.path) + '</div>';
                    html += '<div style="font-size: 0.9rem;">' + escapeHtml(JSON.stringify(change.value)) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            if (changes.modified.length > 0) {
                html += '<div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #ed6c02; background: #fff4e6;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; font-size: 1.1rem; color: #ed6c02;">Modified Fields</h3>';
                changes.modified.forEach(change => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: white; border-left: 3px solid #ed6c02;">';
                    html += '<div style="font-family: monospace; font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">' + escapeHtml(change.path) + '</div>';
                    html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">';
                    html += '<div><div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">OLD</div><div style="font-size: 0.9rem; color: #d32f2f;">' + escapeHtml(JSON.stringify(change.oldValue)) + '</div></div>';
                    html += '<div><div style="font-size: 0.75rem; color: #666; margin-bottom: 0.25rem;">NEW</div><div style="font-size: 0.9rem; color: #2e7d32;">' + escapeHtml(JSON.stringify(change.newValue)) + '</div></div>';
                    html += '</div></div>';
                });
                html += '</div>';
            }

            if (changes.removed.length > 0) {
                html += '<div style="margin-bottom: 1.5rem; padding: 1.5rem; border: 1px solid #d32f2f; background: #ffebee;">';
                html += '<h3 style="margin: 0 0 1rem 0; font-weight: 400; font-size: 1.1rem; color: #d32f2f;">Removed Fields</h3>';
                changes.removed.forEach(change => {
                    html += '<div style="margin-bottom: 0.75rem; padding: 0.75rem; background: white; border-left: 3px solid #d32f2f;">';
                    html += '<div style="font-family: monospace; font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">' + escapeHtml(change.path) + '</div>';
                    html += '<div style="font-size: 0.9rem;">' + escapeHtml(JSON.stringify(change.value)) + '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            if (changes.added.length === 0 && changes.modified.length === 0 && changes.removed.length === 0) {
                html += '<div style="padding: 2rem; text-align: center; color: #666; border: 1px solid #e0e0e0;">';
                html += 'No changes detected between versions';
                html += '</div>';
            }

            html += '</div>';
            
            modalContent.innerHTML = html;
            modal.className = 'modal-overlay';
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function generateHTMLFromSchema(schemaJson) {
            const schema = JSON.parse(schemaJson);
            
            let html = '<div style="font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', sans-serif; color: #1a1a1a;">';
            html += '<h3 style="margin: 0 0 1.5rem 0; font-weight: 300; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.75rem; font-size: 1.5rem;">' + escapeHtml(schema.name) + '</h3>';
            
            // Basic Info Section
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">';
            
            html += '<div style="padding: 1rem; border: 1px solid #e0e0e0;">';
            html += '<div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 0.25rem;">Type</div>';
            html += '<div style="font-weight: 400;">' + escapeHtml(schema['@type']) + '</div>';
            html += '</div>';
            
            html += '<div style="padding: 1rem; border: 1px solid #e0e0e0;">';
            html += '<div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 0.25rem;">Language</div>';
            html += '<div style="font-weight: 400;">' + escapeHtml(schema.inLanguage) + '</div>';
            html += '</div>';
            
            html += '</div>';

            // Description
            if (schema.description) {
                html += '<div style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 0.5rem;">Description</div>';
                html += '<div style="color: #333; line-height: 1.6;">' + escapeHtml(schema.description) + '</div>';
                html += '</div>';
            }

            // URL & ID
            html += '<div style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
            html += '<div style="margin-bottom: 0.75rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">URL:</span> <a href="' + escapeHtml(schema.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline; word-break: break-all;">' + escapeHtml(schema.url) + '</a></div>';
            html += '<div><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">ID:</span> <code style="background: #f5f5f5; padding: 0.25rem 0.5rem; font-size: 0.9rem;">' + escapeHtml(schema['@id']) + '</code></div>';
            html += '</div>';

            // IsPartOf
            if (schema.isPartOf) {
                html += '<div style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 0.75rem; font-size: 0.95rem;">Part Of Website</div>';
                html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Name:</span> ' + escapeHtml(schema.isPartOf.name) + '</div>';
                html += '<div><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">URL:</span> <a href="' + escapeHtml(schema.isPartOf.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline;">' + escapeHtml(schema.isPartOf.url) + '</a></div>';
                html += '</div>';
            }

            // Primary Image
            if (schema.primaryImageOfPage && schema.primaryImageOfPage.url) {
                html += '<div style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 0.5rem; font-size: 0.95rem;">Primary Image</div>';
                html += '<div style="word-break: break-all;"><a href="' + escapeHtml(schema.primaryImageOfPage.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline; font-size: 0.9rem;">' + escapeHtml(schema.primaryImageOfPage.url) + '</a></div>';
                html += '</div>';
            }

            // Breadcrumbs
            if (schema.breadcrumb && schema.breadcrumb.itemListElement && schema.breadcrumb.itemListElement.length > 0) {
                html += '<div style="padding: 1rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 0.75rem; font-size: 0.95rem;">Breadcrumbs</div>';
                html += '<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">';
                schema.breadcrumb.itemListElement.forEach((item, idx) => {
                    if (idx > 0) html += '<span style="color: #ccc;">›</span>';
                    html += '<span style="padding: 0.25rem 0.75rem; font-size: 0.9rem; border: 1px solid #e0e0e0;">';
                    html += escapeHtml(item.name);
                    html += '</span>';
                });
                html += '</div></div>';
            }

            // Publisher
            if (schema.publisher) {
                html += '<div style="padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 1rem; font-size: 1.05rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Publisher / Organization</div>';
                html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Name:</span> ' + escapeHtml(schema.publisher.name) + '</div>';
                html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">URL:</span> <a href="' + escapeHtml(schema.publisher.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline;">' + escapeHtml(schema.publisher.url) + '</a></div>';
                html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">ID:</span> <code style="background: #f5f5f5; padding: 0.25rem 0.5rem; font-size: 0.9rem;">' + escapeHtml(schema.publisher['@id']) + '</code></div>';
                
                if (schema.publisher.logo) {
                    html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Logo:</span> <a href="' + escapeHtml(schema.publisher.logo.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline; font-size: 0.9rem; word-break: break-all;">' + escapeHtml(schema.publisher.logo.url) + '</a></div>';
                }
                
                if (schema.publisher.contactPoint && schema.publisher.contactPoint.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.75rem; font-size: 0.95rem;">Contact Points</div>';
                    schema.publisher.contactPoint.forEach(cp => {
                        html += '<div style="margin: 0.75rem 0; padding: 0.75rem; border: 1px solid #e0e0e0;">';
                        html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Type:</span> ' + escapeHtml(cp.contactType) + '</div>';
                        html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Phone:</span> ' + escapeHtml(cp.telephone) + '</div>';
                        html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Area:</span> ' + escapeHtml(Array.isArray(cp.areaServed) ? cp.areaServed.join(', ') : cp.areaServed) + '</div>';
                        html += '<div><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Languages:</span> ' + escapeHtml(cp.availableLanguage.join(', ')) + '</div>';
                        html += '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            // About (Service)
            if (schema.about && schema.about.name) {
                html += '<div style="padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 1rem; font-size: 1.05rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">About (Service)</div>';
                html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Name:</span> ' + escapeHtml(schema.about.name) + '</div>';
                
                if (schema.about.serviceType) {
                    html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Service Type:</span> ' + escapeHtml(schema.about.serviceType) + '</div>';
                }
                
                if (schema.about.description) {
                    html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Description:</span> ' + escapeHtml(schema.about.description) + '</div>';
                }
                
                if (schema.about.audience && schema.about.audience.name) {
                    html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Target Audience:</span> ' + escapeHtml(schema.about.audience.name) + '</div>';
                }
                
                if (schema.about.areaServed) {
                    html += '<div style="margin-bottom: 0.5rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Area Served:</span> ';
                    if (schema.about.areaServed.name) {
                        html += escapeHtml(schema.about.areaServed.name);
                    } else if (typeof schema.about.areaServed === 'string') {
                        html += escapeHtml(schema.about.areaServed);
                    }
                    html += '</div>';
                }
                
                // Additional service areas (counties)
                if (schema.about.additionalProperty && schema.about.additionalProperty.value) {
                    html += '<div style="margin-top: 1rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Specific Service Areas:</span></div>';
                    html += '<div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">';
                    schema.about.additionalProperty.value.forEach(area => {
                        html += '<span style="padding: 0.5rem 1rem; border: 1px solid #e0e0e0; font-size: 0.9rem;">' + escapeHtml(area.name) + '</span>';
                    });
                    html += '</div>';
                }
                
                // Offer Catalog
                if (schema.about.hasOfferCatalog && schema.about.hasOfferCatalog.itemListElement && 
                    schema.about.hasOfferCatalog.itemListElement.length > 0 &&
                    schema.about.hasOfferCatalog.itemListElement[0].itemListElement &&
                    schema.about.hasOfferCatalog.itemListElement[0].itemListElement.length > 0) {
                    html += '<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.75rem; font-size: 0.95rem;">Offer Catalog: ' + escapeHtml(schema.about.hasOfferCatalog.name) + '</div>';
                    html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">Number of Items: ' + schema.about.hasOfferCatalog.itemListElement[0].numberOfItems + '</div>';
                    
                    schema.about.hasOfferCatalog.itemListElement[0].itemListElement.forEach(item => {
                        html += '<div style="margin: 0.75rem 0; padding: 1rem; border: 1px solid #e0e0e0;">';
                        html += '<div style="font-weight: 400; margin-bottom: 0.5rem;">' + escapeHtml(item.name) + '</div>';
                        if (item.description) {
                            html += '<div style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">' + escapeHtml(item.description) + '</div>';
                        }
                        if (item.areaServed) {
                            const areaText = Array.isArray(item.areaServed) ? item.areaServed.join(', ') : item.areaServed;
                            html += '<div style="font-size: 0.85rem; color: #666;">Areas: ' + escapeHtml(areaText) + '</div>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            }

            // Main Entity
            if (schema.mainEntity && schema.mainEntity.itemListElement && schema.mainEntity.itemListElement.length > 0) {
                html += '<div style="padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 1rem; font-size: 1.05rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Main Entity: ' + escapeHtml(schema.mainEntity.name) + '</div>';
                
                schema.mainEntity.itemListElement.forEach(item => {
                    html += '<div style="margin: 0.75rem 0; padding: 1rem; border: 1px solid #e0e0e0;">';
                    html += '<div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Position: ' + item.position + '</div>';
                    html += '<div style="font-weight: 400; margin-bottom: 0.25rem;">' + escapeHtml(item.item.name) + '</div>';
                    html += '<div style="font-size: 0.85rem; margin-bottom: 0.25rem;"><span style="color: #666;">Type:</span> ' + escapeHtml(item.item['@type']) + '</div>';
                    html += '<div style="font-size: 0.85rem;"><span style="color: #666;">URL:</span> <a href="' + escapeHtml(item.item.url) + '" target="_blank" style="color: #1a1a1a; text-decoration: underline;">' + escapeHtml(item.item.url) + '</a></div>';
                    html += '</div>';
                });
                html += '</div>';
            }

            // Potential Actions
            if (schema.potentialAction && schema.potentialAction.length > 0) {
                html += '<div style="padding: 1.5rem; margin-bottom: 1.5rem; border: 1px solid #e0e0e0;">';
                html += '<div style="font-weight: 400; margin-bottom: 1rem; font-size: 1.05rem; border-bottom: 1px solid #e0e0e0; padding-bottom: 0.5rem;">Potential Actions</div>';
                
                schema.potentialAction.forEach((action, idx) => {
                    html += '<div style="margin: 0.75rem 0; padding: 1rem; border: 1px solid #e0e0e0;">';
                    html += '<div style="font-weight: 400; margin-bottom: 0.5rem;">' + escapeHtml(action['@type']) + '</div>';
                    if (action.name) {
                        html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Name:</span> ' + escapeHtml(action.name) + '</div>';
                    }
                    if (action.target) {
                        if (typeof action.target === 'string') {
                            html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">Target:</span> ' + escapeHtml(action.target) + '</div>';
                        } else if (action.target.urlTemplate) {
                            html += '<div style="margin-bottom: 0.25rem;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666;">URL Template:</span> ' + escapeHtml(action.target.urlTemplate) + '</div>';
                        }
                    }
                    if (action['query-input']) {
                        html += '<div style="font-size: 0.85rem; color: #666;"><span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Query Input:</span> ' + escapeHtml(action['query-input']) + '</div>';
                    }
                    html += '</div>';
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function downloadSchema(result, index) {
            const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
            const blob = new Blob([wrappedSchema], { type: 'text/html' });
            const filename = `schema-${index + 1}.html`;
            saveAs(blob, filename);
        }

        document.getElementById('downloadAllBtn').addEventListener('click', async () => {
            const zip = new JSZip();
            
            generatedSchemas.forEach((result, index) => {
                if (result.success) {
                    const wrappedSchema = `<script type="application/ld+json">\n${result.schema}\n<\/script>`;
                    zip.file(`schema-${index + 1}.html`, wrappedSchema);
                }
            });

            const content = await zip.generateAsync({ type: 'blob' });
            saveAs(content, 'schemas.zip');
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>