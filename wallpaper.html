<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bauhaus Grid</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    canvas {
      display: block;
      width: 100vw;
      background: #f0f0f0;
    }

    #downloadBtn, #refreshBtn, #randomPaletteBtn, #christmasBtn {
      max-width: 200px;
      box-shadow: 1px 1px 1px #0000003b;
      opacity: 1;
      color: #333;
      font-weight: 400;
      text-transform: uppercase;
      font-size: 13px;
       font-family: "Noto Sans", sans-serif;
      display: inline-flex;
      align-items: center;
    }

    #downloadBtn:hover, #refreshBtn:hover, #randomPaletteBtn:hover, #christmasBtn:hover {
      opacity: 1;
    }

    .buttons {
      position: absolute;
      left: 2%;
      bottom: 0px;
      height: 60px;
    }

    button {
       font-family: "Noto Sans", sans-serif;
    background-color: #fff;
    display: inline-block;
    padding: 8px 20px 8px 16px;
    /* margin-right: 5px; */
    cursor: pointer;
    margin: 0px;
    border: 1px solid aliceblue;
    border-right-color: #cdcdcd;
    margin-left: -4px;
    }
    #downloadBtn:hover, #refreshBtn:hover, #randomPaletteBtn:hover, #christmasBtn:hover{
     background-color: aliceblue;
    }

    .fa {
      margin-right: 8px;
    }
  </style>
  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body>
  <div class="buttons">
    <button id="downloadBtn"><i class="fa fa-download"></i>Download</button>
    <button onclick="refreshPage()" id="refreshBtn"><i class="fa fa-sync-alt"></i>AZ Blue</button>
    <button onclick="christmasMode()" id="christmasBtn"><i class="fa fa-tree"></i>AZ Blue Christmas</button>
    <button onclick="randomPalette()" id="randomPaletteBtn"><i class="fa fa-palette"></i>Random</button>
  </div>
  <canvas id="gridCanvas" width="1440" height="960"></canvas>

  <script>
    const canvas = document.getElementById('gridCanvas');
    const ctx = canvas.getContext('2d');
    
    // Store grid state for exact SVG export
    let currentGridState = [];

    let minCellsAcross = 8;
    let isChristmasMode = true;
    let selectedSvgDesign = 3; // Always use design 3 (snowflakes with varied sizes)
    // Commented out random selection - uncomment to enable multiple SVG designs:
    // let selectedSvgDesign = Math.floor(Math.random() * 4);

    // Christmas color palette for SVG
    const christmasColors = ['#FBB24C', '#E7EAF1', '#F58220', '#0099D8', '#FFFFFF', '#F1F9FD'];

    const colorPalettes = [
      ['#F58220', '#FBB24C', '#0099D8', '#FFFFFF', '#E7EAF1'], // AZ Blue
      ['#F1AA00', '#F525BC', '#ED2992', '#C11DB3', '#45A5F2', '#94EAA4', '#ffffff'], // Pow!
      ['#FEC028', '#EE5A31', '#1F2A39', '#F8A4BC', '#7B9AAB', '#A89E32', '#0B806B', '#ffffff'], // Tropics
      ['#444343', '#2d2c2c', '#312f2f', '#3b3a3a', '#1a1a1a'], //Carbon
      ['#ccc5b9', '#252422', '#403d39', '#eb5e28', '#fffcf2'], //Terracotta
      ['#026173', '#fa8a57', '#dda850', '#e9bg9c', '#db5659', '#b5d5ca'], //Terra
      ['#D23031', '#F54337', '#B71B1C', '#FF9C00', '#FF6100'], // Ember
      ['#9E50BE', '#D680D9', '#300EA1', '#6D28C3', '#F2C2F4'], // Orchid
      ['#4E8098', '#A2C3DB', '#E7D4C9', '#FB9F89', '#EF6F6C'], // Dream
      ['#0F4C81', '#2A7B9B', '#F18F01', '#F06000', '#D9C8B4'], // Punch
      ['#88CCF1', '#F76C5E', '#F9A620', '#2A2E32', '#E4E4E4'], //Tucan
      ['#1A535C', '#4ECDC4', '#FF6B6B', '#FFE66D', '#F7FFF7'], // Exotica
      ['#03060D', '#011C26', '#014040', '#185941', '#F2F2F2'], // Swampthing
      ['#001542', '#085454', '#7A7A7A', '#FFFFFF', '#FFB30D'], // Swampthing
      ['#0597F2', '#05AFF2', '#05C7F2', '#F2D479', '#D96523'], // Swampthing
      ['#025159', '#038C5A', '#04D976', '#03A65A', '#04D960'], // Swampthing
      ['#593C23', '#BFAE9F', '#A65C41', '#401B13', '#8C2920'], // Swampthing
      ['#3D5A73', '#2F3D40', '#455559', '#28403D', '#182625'], // Swampthing
      ['#8A74B2', '#BB738A', '#E87264', '#F98162', '#FFAE82'], // Swampthing
    ];

    let colors = colorPalettes[0]; // Start with AZ Blue palette (Christmas mode)

    function setCanvasSize() {
      canvas.width = window.innerWidth;
      const cellSize = canvas.width / minCellsAcross;
      const rows = Math.ceil(window.innerHeight / cellSize);
      canvas.height = rows * cellSize;
    }

    function calculateGrid() {
      const cellSize = canvas.width / minCellsAcross;
      const cols = Math.floor(canvas.width / cellSize);
      const rows = Math.floor(canvas.height / cellSize);
      return { cellSize, rows, cols };
    }

    function drawGrid() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const { cellSize, rows, cols } = calculateGrid();
      
      // Reset grid state
      currentGridState = [];

      for (let row = 0; row < rows; row++) {
        currentGridState[row] = [];
        for (let col = 0; col < cols; col++) {
          ctx.fillStyle = 'transparent';
          ctx.strokeStyle = 'transparent';

          const bgColor = colors[Math.floor(Math.random() * colors.length)];
          ctx.fillStyle = getFillStyle(bgColor, col * cellSize, row * cellSize, cellSize);
          ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);

          const shapeColors = colors.filter(c => c !== bgColor);
          const shapeColor = shapeColors[Math.floor(Math.random() * shapeColors.length)];

          // Store state for SVG export
          const cellState = {
            bgColor: bgColor,
            shapeColor: shapeColor
          };

          if (isChristmasMode) {
            const colorSet = getRandomColors();
            const rotations = [0, 90, 180, 270];
            const rotation = rotations[Math.floor(Math.random() * rotations.length)];
            const bgOptions = ['#FFFFFF', '#E7EAF1', '#F1F9FD'];
            const availableBgs = bgOptions.filter(bg => bg !== colorSet.cls2);
            const lightBg = availableBgs.length === bgOptions.length 
              ? bgOptions[Math.floor(Math.random() * bgOptions.length)]
              : availableBgs[Math.floor(Math.random() * availableBgs.length)];
            
            cellState.isChristmas = true;
            cellState.colorSet = colorSet;
            cellState.rotation = rotation;
            cellState.lightBg = lightBg;
            
            drawSvgShape(ctx, col * cellSize, row * cellSize, cellSize, bgColor, colorSet, rotation, lightBg);
          } else {
            const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
            const corner = corners[Math.floor(Math.random() * corners.length)];
            cellState.isChristmas = false;
            cellState.corner = corner;
            
            drawQuarterCircle(ctx, col * cellSize, row * cellSize, cellSize, shapeColor, corner);
          }
          
          currentGridState[row][col] = cellState;
        }
      }
    }

    function getFillStyle(color, x, y, size) {
      return color;
    }

    function drawQuarterCircle(context, x, y, size, color, corner) {
      context.fillStyle = color;

      context.beginPath();
      switch (corner) {
        case 'top-left':
          context.moveTo(x, y);
          context.arc(x, y, size, 0, Math.PI / 2);
          break;
        case 'top-right':
          context.moveTo(x + size, y);
          context.arc(x + size, y, size, Math.PI / 2, Math.PI);
          break;
        case 'bottom-left':
          context.moveTo(x, y + size);
          context.arc(x, y + size, size, 1.5 * Math.PI, 0);
          break;
        case 'bottom-right':
          context.moveTo(x + size, y + size);
          context.arc(x + size, y + size, size, Math.PI, 1.5 * Math.PI);
          break;
      }
      context.closePath();
      context.fill();
    }

    function getRandomColors() {
      // Shuffle the colors array and pick first 3
      const availableColors = [...christmasColors];
      const shuffled = availableColors.sort(() => Math.random() - 0.5);
      return {
        cls2: shuffled[0],
        cls3: shuffled[1],
        cls4: shuffled[2]
      };
    }

    function drawSvgShape(context, x, y, size, bgColor, colorSet, rotation, lightBg) {
      const svgString = `<?xml version="1.0" encoding="UTF-8"?>
<svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" viewBox="82.66 1.24 80 80">
  <defs>
    <style>.cls-1,.cls-2,.cls-3{fill:none;}.cls-4{fill:${colorSet.cls2};}.cls-5{fill:${colorSet.cls3};}.cls-2{stroke-width:.5px;}.cls-2,.cls-3{stroke:${colorSet.cls4};stroke-linecap:round;stroke-linejoin:round;}.cls-3{stroke-width:.25px;}.cls-6{fill:${colorSet.cls4};}.cls-8{clip-path:url(#clippath);}.cls-9{fill:${colorSet.cls2};}</style>
    <clipPath id="clippath"><rect class="cls-1" x="82.66" y="1.24" width="80" height="80"/></clipPath>
  </defs>
  <g class="cls-8" transform="rotate(${rotation} 122.66 41.24)">
    <rect fill="${lightBg}" x="82.66" y="1.24" width="80" height="80"/>
    <path class="cls-4" d="M82.66,1.24h0v80h80C162.66,37.05,126.85,1.24,82.66,1.24Z"/>
    <path class="cls-6" d="M97.79,44.52h-4.62l3.27-3.27c.13-.13.13-.35,0-.48-.13-.13-.35-.13-.48,0l-3.27,3.27v-4.62c0-.19-.15-.34-.34-.34s-.34.15-.34.34v4.62l-3.27-3.27c-.13-.13-.35-.13-.48,0-.13.13-.13.35,0,.48l3.27,3.27h-4.62c-.19,0-.34.15-.34.34s.15.34.34.34h4.62l-3.27,3.27c-.13.13-.13.35,0,.48.07.07.15.1.24.1s.17-.03.24-.1l3.27-3.27v4.62c0,.19.15.34.34.34s.34-.15.34-.34v-4.62l3.27,3.27c.07.07.15.1.24.1s.17-.03.24-.1c.13-.13.13-.35,0-.48l-3.27-3.27h4.62c.19,0,.34-.15.34-.34s-.15-.34-.34-.34Z"/>
    <path class="cls-6" d="M91.88,64.89c.12.12.57,1.44.66,1.69.51.22,1.09.43,1.62.62-.5.19-1.12.42-1.61.63-.13.31-.56,1.68-.68,1.83-.21-.54-.41-1.32-.65-1.83-.55-.2-1.1-.4-1.64-.63.55-.2,1.10-.42,1.64-.63.23-.54.42-1.14.66-1.69Z"/>
    <path class="cls-5" d="M55.67,37.01h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
    <path class="cls-9" d="M36.85,80.19h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31-.36-.36-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0-.36.36-.36.94,0,1.31l8.92,8.92H7.16c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
    <path class="cls-9" d="M97.8,134.09h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
    <path class="cls-5" d="M54.72,118.32h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
    <path class="cls-5" d="M142.04,122.36h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
    <circle class="cls-5" cx="62.53" cy="57.53" r="4.27"/>
    <circle class="cls-5" cx="110.43" cy="15.72" r="4.19"/>
    <circle class="cls-5" cx="99.01" cy="108.66" r="4.16"/>
    <circle class="cls-9" cx="106.21" cy="147.27" r="4.71"/>
    <circle class="cls-5" cx="150.11" cy="104.5" r="4.25"/>
    <circle class="cls-6" cx="150.11" cy="52.39" r="4.71"/>
    <circle class="cls-9" cx="58.25" cy="13.24" r="4.71"/>
    <circle class="cls-5" cx="17.69" cy="54.09" r="4.32"/>
    <circle class="cls-9" cx="56.6" cy="91.54" r="4.71"/>
    <circle class="cls-5" cx="54.08" cy="144.92" r="4.17"/>
    <circle class="cls-5" cx="94" cy="24.58" r="2.82"/>
    <circle class="cls-5" cx="101.65" cy="49.47" r="1.51"/>
    <circle class="cls-5" cx="132.96" cy="28.16" r="1.51"/>
    <line class="cls-2" x1="123.57" y1="24.29" x2="123.57" y2="60.38"/>
    <line class="cls-2" x1="123.57" y1="38.48" x2="126.94" y2="35.01"/>
    <line class="cls-2" x1="120.21" y1="35.01" x2="123.57" y2="38.48"/>
    <line class="cls-2" x1="123.57" y1="34.17" x2="126.94" y2="30.7"/>
    <line class="cls-2" x1="120.21" y1="30.7" x2="123.57" y2="34.17"/>
    <line class="cls-2" x1="123.57" y1="29.86" x2="126.94" y2="26.39"/>
    <line class="cls-2" x1="120.21" y1="26.39" x2="123.57" y2="29.86"/>
    <line class="cls-2" x1="123.57" y1="46.19" x2="120.21" y2="49.66"/>
    <line class="cls-2" x1="126.94" y1="49.66" x2="123.57" y2="46.19"/>
    <line class="cls-2" x1="123.57" y1="50.5" x2="120.21" y2="53.97"/>
    <line class="cls-2" x1="126.94" y1="53.97" x2="123.57" y2="50.5"/>
    <line class="cls-2" x1="123.57" y1="54.8" x2="120.21" y2="58.28"/>
    <line class="cls-2" x1="126.94" y1="58.28" x2="123.57" y2="54.8"/>
    <line class="cls-2" x1="107.94" y1="33.31" x2="139.2" y2="51.36"/>
    <line class="cls-2" x1="120.23" y1="40.41" x2="118.91" y2="35.76"/>
    <line class="cls-2" x1="115.54" y1="41.59" x2="120.23" y2="40.41"/>
    <line class="cls-2" x1="116.5" y1="38.25" x2="115.18" y2="33.6"/>
    <line class="cls-2" x1="111.81" y1="39.43" x2="116.5" y2="38.25"/>
    <line class="cls-2" x1="112.77" y1="36.1" x2="111.45" y2="31.45"/>
    <line class="cls-2" x1="108.08" y1="37.28" x2="112.77" y2="36.1"/>
    <line class="cls-2" x1="126.91" y1="44.26" x2="128.23" y2="48.91"/>
    <line class="cls-2" x1="131.6" y1="43.08" x2="126.91" y2="44.26"/>
    <line class="cls-2" x1="130.64" y1="46.42" x2="131.96" y2="51.07"/>
    <line class="cls-2" x1="135.33" y1="45.24" x2="130.64" y2="46.41"/>
    <line class="cls-2" x1="134.37" y1="48.57" x2="135.69" y2="53.22"/>
    <line class="cls-2" x1="139.06" y1="47.39" x2="134.37" y2="48.57"/>
    <line class="cls-2" x1="139.2" y1="33.31" x2="107.94" y2="51.36"/>
    <line class="cls-2" x1="126.91" y1="40.41" x2="131.6" y2="41.59"/>
    <line class="cls-2" x1="128.23" y1="35.76" x2="126.91" y2="40.41"/>
    <line class="cls-2" x1="130.64" y1="38.25" x2="135.33" y2="39.43"/>
    <line class="cls-2" x1="131.96" y1="33.6" x2="130.64" y2="38.25"/>
    <line class="cls-2" x1="134.37" y1="36.1" x2="139.06" y2="37.28"/>
    <line class="cls-2" x1="135.69" y1="31.45" x2="134.37" y2="36.1"/>
    <line class="cls-2" x1="120.23" y1="44.26" x2="115.54" y2="43.08"/>
    <line class="cls-2" x1="118.91" y1="48.91" x2="120.23" y2="44.26"/>
    <line class="cls-2" x1="116.5" y1="46.41" x2="111.81" y2="45.24"/>
    <line class="cls-2" x1="115.18" y1="51.07" x2="116.5" y2="46.42"/>
    <line class="cls-2" x1="112.77" y1="48.57" x2="108.08" y2="47.39"/>
    <line class="cls-2" x1="111.45" y1="53.22" x2="112.77" y2="48.57"/>
    <path class="cls-6" d="M145.84,67.5h-6.28l4.44-4.44c.18-.18.18-.47,0-.65-.18-.18-.47-.18-.65,0l-4.44,4.44v-6.28c0-.25-.21-.46-.46-.46s-.46.21-.46.46v6.28l-4.44-4.44c-.18-.18-.47-.18-.65,0-.18.18-.18.47,0,.65l4.44,4.44h-6.28c-.25,0-.46.21-.46.46s.21.46.46.46h6.28l-4.44,4.44c-.18.18-.18.47,0,.65.09.09.21.13.33.13s.24-.04.33-.13l4.44-4.44v6.28c0,.25.21.46.46.46s.46-.21.46-.46v-6.28l4.44,4.44c.09.09.21.13.33.13s.24-.04.33-.13c.18-.18.18-.47,0-.65l-4.44-4.44h6.28c.25,0,.46-.21.46-.46s-.21-.46-.46-.46Z"/>
    <path class="cls-6" d="M98.28,11.38h-2.45l1.73-1.73c.07-.07.07-.18,0-.25-.07-.07-.18-.07-.25,0l-1.73,1.73v-2.45c0-.1-.08-.18-.18-.18s-.18.08-.18.18v2.45l-1.73-1.73c-.07-.07-.18-.07-.25,0-.07.07-.07.18,0,.25l1.73,1.73h-2.45c-.1,0-.18.08-.18.18s.08.18.18.18h2.45l-1.73,1.73c-.07.07-.07.18,0,.25.03.03.08.05.13.05s.09-.02.13-.05l1.73-1.73v2.45c0,.1.08.18.18.18s.18-.08.18-.18v-2.45l1.73,1.73s.08.05.13.05.09-.02.13-.05c.07-.07.07-.18,0-.25l-1.73-1.73h2.45c.1,0,.18-.08.18-.18s-.08-.18-.18-.18Z"/>
    <path class="cls-6" d="M124.59,73.09c.03.17-.41,1.49-.49,1.75.27.48.62,1,.92,1.47-.52-.15-1.14-.33-1.67-.46-.29.17-1.45,1.01-1.64,1.06.15-.56.46-1.30.58-1.85-.33-.49-.64-.98-.94-1.49.56.17,1.13.32,1.69.48.51-.30,1.02-.66,1.54-.96Z"/>
    <path class="cls-6" d="M107.28,27.78c-.1.14-1.32.8-1.56.93-.13.54-.24,1.15-.34,1.7-.27-.47-.60-1.03-.89-1.48-.33-.07-1.75-.27-1.92-.36.49-.30,1.23-.62,1.69-.94.10-.58.22-1.15.35-1.73.29.51.59,1.01.90,1.51.58.14,1.20.22,1.78.37Z"/>
    <polyline class="cls-3" points="105.9 66.61 105.31 66.71 103.22 67.08"/>
    <polyline class="cls-3" points="109.81 65.93 110.4 65.83 112.49 65.47"/>
    <line class="cls-3" x1="110.4" y1="65.83" x2="112.18" y2="66.86"/>
    <line class="cls-3" x1="110.4" y1="65.83" x2="111.73" y2="64.26"/>
    <line class="cls-3" x1="105.31" y1="66.71" x2="103.53" y2="65.68"/>
    <line class="cls-3" x1="105.31" y1="66.71" x2="103.98" y2="68.29"/>
    <polyline class="cls-3" points="106.23 65.13 105.75 64.79 104.01 63.57"/>
    <polyline class="cls-3" points="109.48 67.42 109.96 67.76 111.7 68.98"/>
    <line class="cls-3" x1="109.96" y1="67.76" x2="110.5" y2="69.75"/>
    <line class="cls-3" x1="109.96" y1="67.76" x2="112.02" y2="67.58"/>
    <line class="cls-3" x1="105.75" y1="64.79" x2="105.21" y2="62.79"/>
    <line class="cls-3" x1="105.75" y1="64.79" x2="103.69" y2="64.96"/>
    <polyline class="cls-3" points="106.71 67.9 106.71 67.9 106.37 68.38 106.37 68.38 105.15 70.12"/>
    <polyline class="cls-3" points="109 64.65 109 64.64 109.34 64.16 109.34 64.16 110.56 62.43"/>
    <line class="cls-3" x1="109.34" y1="64.16" x2="109.17" y2="62.11"/>
    <line class="cls-3" x1="109.34" y1="64.16" x2="111.33" y2="63.63"/>
    <line class="cls-3" x1="106.37" y1="68.38" x2="106.54" y2="70.44"/>
    <line class="cls-3" x1="106.37" y1="68.38" x2="104.38" y2="68.91"/>
    <polyline class="cls-3" points="107.51 64.31 107.41 63.73 107.05 61.64"/>
    <polyline class="cls-3" points="108.2 68.23 108.3 68.81 108.66 70.90"/>
    <line class="cls-3" x1="108.3" y1="68.81" x2="107.27" y2="70.6"/>
    <line class="cls-3" x1="108.3" y1="68.81" x2="109.87" y2="70.14"/>
    <line class="cls-3" x1="107.41" y1="63.73" x2="108.44" y2="61.94"/>
    <line class="cls-3" x1="107.41" y1="63.73" x2="105.84" y2="62.4"/>
    <polygon class="cls-3" points="109.81 65.93 108.83 66.49 109.48 67.42 108.39 67.11 108.2 68.23 107.64 67.24 106.71 67.9 107.02 66.8 105.9 66.61 106.88 66.05 106.23 65.13 107.32 65.43 107.51 64.31 108.07 65.3 109 64.64 108.69 65.74 109.81 65.93"/>
    <circle class="cls-5" cx="123.3" cy="64.85" r="1.97"/>
    <circle class="cls-5" cx="155.74" cy="72.41" r="1.41"/>
    <circle class="cls-5" cx="86.8" cy="19.05" r="1.13"/>
    <circle class="cls-5" cx="101.96" cy="77.22" r="1.13"/>
  </g>
</svg>`;
      
      const img = new Image();
      const svg = new Blob([svgString], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(svg);
      
      img.onload = function() {
        context.drawImage(img, x, y, size, size);
        URL.revokeObjectURL(url);
      };
      
      img.src = url;
    }

    function downloadCanvasAsImage() {
      // Use stored grid state
      const { cellSize, rows, cols } = calculateGrid();
      
      let svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">
`;

      for (let row = 0; row < rows; row++) {
        for (let col = 0; col < cols; col++) {
          const x = col * cellSize;
          const y = row * cellSize;
          const cellState = currentGridState[row][col];
          
          svgContent += `  <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" fill="${cellState.bgColor}"/>\n`;
          
          if (cellState.isChristmas) {
            const cs = cellState.colorSet;
            const rot = cellState.rotation;
            const lb = cellState.lightBg;
            const clipId = `clip${row}_${col}`;
            
            svgContent += `  <svg x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" viewBox="82.66 1.24 80 80">
    <defs>
      <style>.s${row}_${col}{stroke:${cs.cls4};stroke-linecap:round;stroke-linejoin:round;}</style>
      <clipPath id="${clipId}"><rect x="82.66" y="1.24" width="80" height="80"/></clipPath>
    </defs>
    <g clip-path="url(#${clipId})" transform="rotate(${rot} 122.66 41.24)">
      <rect fill="${lb}" x="82.66" y="1.24" width="80" height="80"/>
      <path fill="${cs.cls2}" d="M82.66,1.24h0v80h80C162.66,37.05,126.85,1.24,82.66,1.24Z"/>
      <path fill="${cs.cls4}" d="M97.79,44.52h-4.62l3.27-3.27c.13-.13.13-.35,0-.48-.13-.13-.35-.13-.48,0l-3.27,3.27v-4.62c0-.19-.15-.34-.34-.34s-.34.15-.34.34v4.62l-3.27-3.27c-.13-.13-.35-.13-.48,0-.13.13-.13.35,0,.48l3.27,3.27h-4.62c-.19,0-.34.15-.34.34s.15.34.34.34h4.62l-3.27,3.27c-.13.13-.13.35,0,.48.07.07.15.1.24.1s.17-.03.24-.1l3.27-3.27v4.62c0,.19.15.34.34.34s.34-.15.34-.34v-4.62l3.27,3.27c.07.07.15.1.24.1s.17-.03.24-.1c.13-.13.13-.35,0-.48l-3.27-3.27h4.62c.19,0,.34-.15.34-.34s-.15-.34-.34-.34Z"/>
      <path fill="${cs.cls4}" d="M91.88,64.89c.12.12.57,1.44.66,1.69.51.22,1.09.43,1.62.62-.5.19-1.12.42-1.61.63-.13.31-.56,1.68-.68,1.83-.21-.54-.41-1.32-.65-1.83-.55-.2-1.10-.40-1.64-.63.55-.2,1.10-.42,1.64-.63.23-.54.42-1.14.66-1.69Z"/>
      <path fill="${cs.cls3}" d="M55.67,37.01h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
      <path fill="${cs.cls2}" d="M36.85,80.19h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31-.36-.36-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0-.36.36-.36.94,0,1.31l8.92,8.92H7.16c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
      <path fill="${cs.cls2}" d="M97.8,134.09h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
      <path fill="${cs.cls3}" d="M54.72,118.32h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
      <path fill="${cs.cls3}" d="M142.04,122.36h-12.62l8.92-8.92c.36-.36.36-.94,0-1.31s-.94-.36-1.31,0l-8.92,8.92v-12.62c0-.51-.41-.92-.92-.92s-.92.41-.92.92v12.62l-8.92-8.92c-.36-.36-.94-.36-1.31,0s-.36.94,0,1.31l8.92,8.92h-12.62c-.51,0-.92.41-.92.92s.41.92.92.92h12.62l-8.92,8.92c-.36.36-.36.94,0,1.31.18.18.42.27.65.27s.47-.09.65-.27l8.92-8.92v12.62c0,.51.41.92.92.92s.92-.41.92-.92v-12.62l8.92,8.92c.18.18.42.27.65.27s.47-.09.65-.27c.36-.36.36-.94,0-1.31l-8.92-8.92h12.62c.51,0,.92-.41.92-.92s-.41-.92-.92-.92Z"/>
      <circle fill="${cs.cls3}" cx="62.53" cy="57.53" r="4.27"/>
      <circle fill="${cs.cls3}" cx="110.43" cy="15.72" r="4.19"/>
      <circle fill="${cs.cls3}" cx="99.01" cy="108.66" r="4.16"/>
      <circle fill="${cs.cls2}" cx="106.21" cy="147.27" r="4.71"/>
      <circle fill="${cs.cls3}" cx="150.11" cy="104.5" r="4.25"/>
      <circle fill="${cs.cls4}" cx="150.11" cy="52.39" r="4.71"/>
      <circle fill="${cs.cls2}" cx="58.25" cy="13.24" r="4.71"/>
      <circle fill="${cs.cls3}" cx="17.69" cy="54.09" r="4.32"/>
      <circle fill="${cs.cls2}" cx="56.6" cy="91.54" r="4.71"/>
      <circle fill="${cs.cls3}" cx="54.08" cy="144.92" r="4.17"/>
      <circle fill="${cs.cls3}" cx="94" cy="24.58" r="2.82"/>
      <circle fill="${cs.cls3}" cx="101.65" cy="49.47" r="1.51"/>
      <circle fill="${cs.cls3}" cx="132.96" cy="28.16" r="1.51"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="24.29" x2="123.57" y2="60.38"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="38.48" x2="126.94" y2="35.01"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="120.21" y1="35.01" x2="123.57" y2="38.48"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="34.17" x2="126.94" y2="30.7"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="120.21" y1="30.7" x2="123.57" y2="34.17"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="29.86" x2="126.94" y2="26.39"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="120.21" y1="26.39" x2="123.57" y2="29.86"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="46.19" x2="120.21" y2="49.66"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="126.94" y1="49.66" x2="123.57" y2="46.19"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="50.5" x2="120.21" y2="53.97"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="126.94" y1="53.97" x2="123.57" y2="50.5"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="123.57" y1="54.8" x2="120.21" y2="58.28"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="126.94" y1="58.28" x2="123.57" y2="54.8"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="107.94" y1="33.31" x2="139.2" y2="51.36"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="120.23" y1="40.41" x2="118.91" y2="35.76"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="115.54" y1="41.59" x2="120.23" y2="40.41"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="116.5" y1="38.25" x2="115.18" y2="33.6"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="111.81" y1="39.43" x2="116.5" y2="38.25"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="112.77" y1="36.1" x2="111.45" y2="31.45"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="108.08" y1="37.28" x2="112.77" y2="36.1"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="126.91" y1="44.26" x2="128.23" y2="48.91"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="131.6" y1="43.08" x2="126.91" y2="44.26"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="130.64" y1="46.42" x2="131.96" y2="51.07"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="135.33" y1="45.24" x2="130.64" y2="46.41"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="134.37" y1="48.57" x2="135.69" y2="53.22"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="139.06" y1="47.39" x2="134.37" y2="48.57"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="139.2" y1="33.31" x2="107.94" y2="51.36"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="126.91" y1="40.41" x2="131.6" y2="41.59"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="128.23" y1="35.76" x2="126.91" y2="40.41"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="130.64" y1="38.25" x2="135.33" y2="39.43"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="131.96" y1="33.6" x2="130.64" y2="38.25"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="134.37" y1="36.1" x2="139.06" y2="37.28"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="135.69" y1="31.45" x2="134.37" y2="36.1"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="120.23" y1="44.26" x2="115.54" y2="43.08"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="118.91" y1="48.91" x2="120.23" y2="44.26"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="116.5" y1="46.41" x2="111.81" y2="45.24"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="115.18" y1="51.07" x2="116.5" y2="46.42"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="112.77" y1="48.57" x2="108.08" y2="47.39"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".5" x1="111.45" y1="53.22" x2="112.77" y2="48.57"/>
      <path fill="${cs.cls4}" d="M145.84,67.5h-6.28l4.44-4.44c.18-.18.18-.47,0-.65-.18-.18-.47-.18-.65,0l-4.44,4.44v-6.28c0-.25-.21-.46-.46-.46s-.46.21-.46.46v6.28l-4.44-4.44c-.18-.18-.47-.18-.65,0-.18.18-.18.47,0,.65l4.44,4.44h-6.28c-.25,0-.46.21-.46.46s.21.46.46.46h6.28l-4.44,4.44c-.18.18-.18.47,0,.65.09.09.21.13.33.13s.24-.04.33-.13l4.44-4.44v6.28c0,.25.21.46.46.46s.46-.21.46-.46v-6.28l4.44,4.44c.09.09.21.13.33.13s.24-.04.33-.13c.18-.18.18-.47,0-.65l-4.44-4.44h6.28c.25,0,.46-.21.46-.46s-.21-.46-.46-.46Z"/>
      <path fill="${cs.cls4}" d="M98.28,11.38h-2.45l1.73-1.73c.07-.07.07-.18,0-.25-.07-.07-.18-.07-.25,0l-1.73,1.73v-2.45c0-.1-.08-.18-.18-.18s-.18.08-.18.18v2.45l-1.73-1.73c-.07-.07-.18-.07-.25,0-.07.07-.07.18,0,.25l1.73,1.73h-2.45c-.1,0-.18.08-.18.18s.08.18.18.18h2.45l-1.73,1.73c-.07.07-.07.18,0,.25.03.03.08.05.13.05s.09-.02.13-.05l1.73-1.73v2.45c0,.1.08.18.18.18s.18-.08.18-.18v-2.45l1.73,1.73s.08.05.13.05.09-.02.13-.05c.07-.07.07-.18,0-.25l-1.73-1.73h2.45c.1,0,.18-.08.18-.18s-.08-.18-.18-.18Z"/>
      <path fill="${cs.cls4}" d="M124.59,73.09c.03.17-.41,1.49-.49,1.75.27.48.62,1,.92,1.47-.52-.15-1.14-.33-1.67-.46-.29.17-1.45,1.01-1.64,1.06.15-.56.46-1.30.58-1.85-.33-.49-.64-.98-.94-1.49.56.17,1.13.32,1.69.48.51-.30,1.02-.66,1.54-.96Z"/>
      <path fill="${cs.cls4}" d="M107.28,27.78c-.10.14-1.32.8-1.56.93-.13.54-.24,1.15-.34,1.70-.27-.47-.60-1.03-.89-1.48-.33-.07-1.75-.27-1.92-.36.49-.30,1.23-.62,1.69-.94.10-.58.22-1.15.35-1.73.29.51.59,1.01.90,1.51.58.14,1.20.22,1.78.37Z"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="105.9 66.61 105.31 66.71 103.22 67.08"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="109.81 65.93 110.4 65.83 112.49 65.47"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="110.4" y1="65.83" x2="112.18" y2="66.86"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="110.4" y1="65.83" x2="111.73" y2="64.26"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="105.31" y1="66.71" x2="103.53" y2="65.68"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="105.31" y1="66.71" x2="103.98" y2="68.29"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="106.23 65.13 105.75 64.79 104.01 63.57"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="109.48 67.42 109.96 67.76 111.7 68.98"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="109.96" y1="67.76" x2="110.5" y2="69.75"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="109.96" y1="67.76" x2="112.02" y2="67.58"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="105.75" y1="64.79" x2="105.21" y2="62.79"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="105.75" y1="64.79" x2="103.69" y2="64.96"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="106.71 67.9 106.71 67.9 106.37 68.38 106.37 68.38 105.15 70.12"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="109 64.65 109 64.64 109.34 64.16 109.34 64.16 110.56 62.43"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="109.34" y1="64.16" x2="109.17" y2="62.11"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="109.34" y1="64.16" x2="111.33" y2="63.63"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="106.37" y1="68.38" x2="106.54" y2="70.44"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="106.37" y1="68.38" x2="104.38" y2="68.91"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="107.51 64.31 107.41 63.73 107.05 61.64"/>
      <polyline class="s${row}_${col}" fill="none" stroke-width=".25" points="108.2 68.23 108.3 68.81 108.66 70.90"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="108.3" y1="68.81" x2="107.27" y2="70.6"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="108.3" y1="68.81" x2="109.87" y2="70.14"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="107.41" y1="63.73" x2="108.44" y2="61.94"/>
      <line class="s${row}_${col}" fill="none" stroke-width=".25" x1="107.41" y1="63.73" x2="105.84" y2="62.40"/>
      <polygon class="s${row}_${col}" fill="none" stroke-width=".25" points="109.81 65.93 108.83 66.49 109.48 67.42 108.39 67.11 108.2 68.23 107.64 67.24 106.71 67.9 107.02 66.8 105.9 66.61 106.88 66.05 106.23 65.13 107.32 65.43 107.51 64.31 108.07 65.3 109 64.64 108.69 65.74 109.81 65.93"/>
      <circle fill="${cs.cls3}" cx="123.3" cy="64.85" r="1.97"/>
      <circle fill="${cs.cls3}" cx="155.74" cy="72.41" r="1.41"/>
      <circle fill="${cs.cls3}" cx="86.8" cy="19.05" r="1.13"/>
      <circle fill="${cs.cls3}" cx="101.96" cy="77.22" r="1.13"/>
    </g>
  </svg>\n`;
          } else {
            const corner = cellState.corner;
            let path = '';
            switch (corner) {
              case 'top-left':
                path = `M ${x} ${y} A ${cellSize} ${cellSize} 0 0 1 ${x + cellSize} ${y + cellSize} L ${x} ${y + cellSize} Z`;
                break;
              case 'top-right':
                path = `M ${x + cellSize} ${y} A ${cellSize} ${cellSize} 0 0 1 ${x} ${y + cellSize} L ${x + cellSize} ${y + cellSize} Z`;
                break;
              case 'bottom-left':
                path = `M ${x} ${y + cellSize} A ${cellSize} ${cellSize} 0 0 1 ${x + cellSize} ${y} L ${x} ${y} Z`;
                break;
              case 'bottom-right':
                path = `M ${x + cellSize} ${y + cellSize} A ${cellSize} ${cellSize} 0 0 1 ${x} ${y} L ${x + cellSize} ${y} Z`;
                break;
            }
            svgContent += `  <path fill="${cellState.shapeColor}" d="${path}"/>\n`;
          }
        }
      }
      
      svgContent += `</svg>`;
      
      // Convert SVG to PNG at high resolution
      const scale = 4; // 4x resolution for high quality
      const img = new Image();
      const svgBlob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
      const url = URL.createObjectURL(svgBlob);
      
      img.onload = function() {
        // Create high-res canvas
        const pngCanvas = document.createElement('canvas');
        pngCanvas.width = canvas.width * scale;
        pngCanvas.height = canvas.height * scale;
        const pngCtx = pngCanvas.getContext('2d');
        
        // Draw SVG to canvas at high resolution
        pngCtx.drawImage(img, 0, 0, pngCanvas.width, pngCanvas.height);
        
        // Convert to PNG and download
        pngCanvas.toBlob(function(blob) {
          const pngUrl = URL.createObjectURL(blob);
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().slice(0,10);
          link.download = `bauhaus-grid-${pngCanvas.width}x${pngCanvas.height}-${timestamp}.png`;
          link.href = pngUrl;
          link.click();
          
          // Cleanup
          URL.revokeObjectURL(url);
          URL.revokeObjectURL(pngUrl);
        }, 'image/png');
      };
      
      img.src = url;
    }

    function christmasMode() {
      colors = colorPalettes[0]; // AZ Blue palette
      isChristmasMode = true;
      selectedSvgDesign = 3; // Always use design 3 (snowflakes with varied sizes)
      // Commented out random selection - uncomment to enable multiple SVG designs:
      // selectedSvgDesign = Math.floor(Math.random() * 4);
      drawGrid();
    }

    window.addEventListener('resize', () => {
      setCanvasSize();
      drawGrid();
    });

    document.getElementById('downloadBtn').addEventListener('click', downloadCanvasAsImage);

    function refreshPage() {
      colors = colorPalettes[0]; // AZ Blue palette
      isChristmasMode = false;
      drawGrid();
    }

    function randomPalette() {
      const randomIndex = Math.floor(Math.random() * (colorPalettes.length - 1)) + 1;
      colors = colorPalettes[randomIndex];
      isChristmasMode = false;
      drawGrid();
    }

    function refreshPage() {
      colors = colorPalettes[0]; // AZ Blue palette
      isChristmasMode = false;
      drawGrid();
    }

    setCanvasSize();
    drawGrid();
  </script>
</body>
</html>