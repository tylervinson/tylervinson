<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sitecore Widget Editor - Code Generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #fafafa;
      color: #1a1a1a;
      line-height: 1.5;
      padding: 40px 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      margin-bottom: 40px;
    }

    h1 {
      font-size: 32px;
      font-weight: 400;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: #666;
      font-size: 15px;
      font-weight: 400;
      margin-bottom: 24px;
    }

    .tab-nav {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #e0e0e0;
      margin-top: 24px;
    }

    .tab-nav-link {
      padding: 12px 20px;
      text-decoration: none;
      color: #999;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid transparent;
      transition: color 0.2s;
    }

    .tab-nav-link:hover {
      color: #666;
    }

    .tab-nav-link.active {
      color: #1a1a1a;
      border-bottom-color: #1a1a1a;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .input-section, .output-section {
      background: #fff;
      padding: 30px;
      border: 1px solid #e0e0e0;
    }

    .section-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 24px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #666;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #d0d0d0;
      background: #fff;
      font-family: inherit;
      font-size: 14px;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: #1a1a1a;
    }

    textarea {
      font-family: 'Courier New', monospace;
      resize: vertical;
      min-height: 200px;
    }

    .info-box {
      background: #f5f5f5;
      border-left: 2px solid #1a1a1a;
      padding: 12px;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }

    button {
      background: #1a1a1a;
      color: #fff;
      border: none;
      padding: 12px 24px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      font-family: inherit;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    button:hover {
      background: #333;
    }

    .analysis-section {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      padding: 16px;
      margin: 20px 0;
    }

    .analysis-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .field-list {
      list-style: none;
    }

    .field-item {
      padding: 8px 12px;
      background: #fff;
      border: 1px solid #e0e0e0;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .field-name {
      font-family: 'Courier New', monospace;
      color: #1a1a1a;
    }

    .field-type {
      color: #999;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .error-message {
      background: #fff;
      border-left: 2px solid #d00;
      padding: 12px;
      margin: 20px 0;
      font-size: 13px;
      color: #d00;
    }

    .download-btn {
      width: 100%;
      padding: 16px;
      background: #1a1a1a;
      color: #fff;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .download-btn:hover {
      background: #333;
    }

    .download-info {
      font-size: 12px;
      color: #666;
      text-align: center;
      margin-bottom: 24px;
    }

    .code-wrapper {
      position: relative;
    }

    pre {
      background: #1a1a1a;
      color: #e0e0e0;
      padding: 20px;
      padding-top: 50px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #000;
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #333;
      color: #fff;
      padding: 8px;
      font-size: 20px;
      border: 1px solid #444;
      cursor: pointer;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .copy-btn:hover {
      background: #444;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Widget Code Generator</h1>
      <p class="subtitle">Automatically generate extension code from your widget HTML</p>
      
      <nav class="tab-nav">
        <a href="sitecore-widget-editor-overview.html" class="tab-nav-link">Extension Overview</a>
        <a href="widget-code-generator.html" class="tab-nav-link active">Code Generator</a>
        <a href="widget-markup-specifications.html" class="tab-nav-link">Markup Specs</a>
      </nav>
    </header>

    <div class="main-grid">
      <!-- Input Section -->
      <div class="input-section">
        <div class="section-title">Input</div>

        <div class="form-group">
          <label>Widget Class Name</label>
          <input type="text" id="widgetClass" placeholder="team-member-bio">
          <div class="info-box">
            The CSS class on the widget's outer container (e.g., "team-member-bio")
          </div>
        </div>

        <div class="form-group">
          <label>Widget Display Name</label>
          <input type="text" id="widgetName" placeholder="Team Member Bio">
        </div>

        <div class="form-group">
          <label>Widget Description</label>
          <input type="text" id="widgetDescription" placeholder="Edit team member information and biography">
        </div>

        <div class="form-group">
          <label>Widget HTML Sample</label>
          <textarea id="htmlInput" placeholder="Paste your widget HTML here..."></textarea>
          <div class="info-box">
            Paste HTML with dynamic-object and dynamic-{type} classes. Generator will add data attributes and create extension code.
          </div>
        </div>

        <button onclick="generateCode()">Generate Code</button>

        <div id="analysisOutput"></div>
      </div>

      <!-- Output Section -->
      <div class="output-section">
        <div class="section-title">Generated Files</div>

        <div id="downloadSection" style="display: none;">
          <button id="downloadBtn" class="download-btn">
            ðŸ“¦ Download Extension Files (.zip)
          </button>
          <p class="download-info">
            Contains: content-script.js, sidepanel.js, manifest.json, processed-widget.html
          </p>
        </div>

        <div id="previewSection" style="display: none;">
          <h3 style="font-size: 13px; font-weight: 500; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #666;">Processed HTML Preview</h3>
          <div class="code-wrapper">
            <button class="copy-btn" onclick="copyCode()" title="Copy to clipboard">ðŸ“‹</button>
            <pre id="processedHTMLCode">// Generate code to see output</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let generatedFiles = {};

    function copyCode() {
      const code = document.getElementById('processedHTMLCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ“';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      });
    }

    function analyzeHTML(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      const widgetContainer = doc.body.firstElementChild;
      if (!widgetContainer) {
        return { error: 'No widget container found' };
      }

      const widgetClass = widgetContainer.className.split(' ')[0];
      const dynamicObjects = widgetContainer.querySelectorAll('.dynamic-object');
      const hasDynamicObjects = dynamicObjects.length > 0;
      const dynamicElements = widgetContainer.querySelectorAll('[class*="dynamic-"]');
      
      if (dynamicElements.length === 0) {
        return { error: 'No dynamic-* classes found in HTML' };
      }

      const fieldTypes = new Set();
      dynamicElements.forEach(el => {
        const classes = Array.from(el.classList);
        classes.forEach(cls => {
          if (cls.startsWith('dynamic-') && cls !== 'dynamic-object') {
            fieldTypes.add(cls.replace('dynamic-', ''));
          }
        });
      });

      return {
        widgetClass,
        hasDynamicObjects,
        objectCount: hasDynamicObjects ? dynamicObjects.length : 1,
        fieldTypes: Array.from(fieldTypes),
        dynamicElements: dynamicElements.length
      };
    }

    function getDirectText(el) {
      // Only get direct text nodes (nodeType 3), not text from child elements
      let text = '';
      el.childNodes.forEach(node => {
        if (node.nodeType === 3) {
          text += node.textContent.trim();
        }
      });
      return text;
    }

    function processHTML(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const widgetContainer = doc.body.firstElementChild;
      if (!widgetContainer) return null;

      const dynamicObjects = widgetContainer.querySelectorAll('.dynamic-object');
      const hasDynamicObjects = dynamicObjects.length > 0;

      if (hasDynamicObjects) {
        dynamicObjects.forEach((obj, objIndex) => {
          const fieldCounts = {};
          
          // Find all elements with dynamic-* classes (except dynamic-object)
          const allElements = obj.querySelectorAll('*');
          const dynamicElements = [];
          
          allElements.forEach(el => {
            const hasDynamicClass = Array.from(el.classList).some(cls => 
              cls.startsWith('dynamic-') && cls !== 'dynamic-object'
            );
            if (hasDynamicClass) {
              dynamicElements.push(el);
            }
          });
          
          dynamicElements.forEach(el => {
            Array.from(el.classList).forEach(cls => {
              if (cls.startsWith('dynamic-') && cls !== 'dynamic-object') {
                const type = cls.replace('dynamic-', '');
                fieldCounts[type] = (fieldCounts[type] || 0) + 1;
                const fieldNum = fieldCounts[type];
                
                // Extract text content as the data value - direct text nodes only
                const textContent = getDirectText(el);
                // For numbers, fall back to 0 rather than placeholder
                const dataValue = textContent !== '' ? textContent : (type === 'number' ? '0' : 'placeholder');
                
                // Add data attribute to THIS element
                el.setAttribute(`data-${type}-${fieldNum}`, dataValue);
                
                // Update the element's class
                el.classList.remove(cls);
                el.classList.add(`${type}-${fieldNum}`);
              }
            });
          });
          
          obj.setAttribute('data-object-id', (objIndex + 1).toString());
          obj.classList.remove('dynamic-object');
        });
      } else {
        const fieldCounts = {};
        
        // Find all dynamic-* classes at widget level
        const allElements = widgetContainer.querySelectorAll('*');
        const dynamicElements = [];
        
        allElements.forEach(el => {
          const hasDynamicClass = Array.from(el.classList).some(cls => 
            cls.startsWith('dynamic-')
          );
          if (hasDynamicClass) {
            dynamicElements.push(el);
          }
        });
        
        dynamicElements.forEach(el => {
          Array.from(el.classList).forEach(cls => {
            if (cls.startsWith('dynamic-')) {
              const type = cls.replace('dynamic-', '');
              fieldCounts[type] = (fieldCounts[type] || 0) + 1;
              const fieldNum = fieldCounts[type];
              
              // Extract text content as the data value - direct text nodes only
              const textContent = getDirectText(el);
              // For numbers, fall back to 0 rather than placeholder
              const dataValue = textContent !== '' ? textContent : (type === 'number' ? '0' : 'placeholder');
              
              // Add data attribute to THIS element
              el.setAttribute(`data-${type}-${fieldNum}`, dataValue);
              
              // Update the element's class
              el.classList.remove(cls);
              el.classList.add(`${type}-${fieldNum}`);
            }
          });
        });
      }

      return doc.body.innerHTML;
    }

    function toCamelCase(str) {
      return str.replace(/-([a-z])/g, (g) => g[1].toUpperCase());
    }

    function toDisplayName(str) {
      return str.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function showError(message) {
      document.getElementById('analysisOutput').innerHTML = `<div class="error-message">${message}</div>`;
    }

    function showAnalysis(analysis) {
      const html = `
        <div class="analysis-section">
          <div class="analysis-title">Detected Structure</div>
          <ul class="field-list">
            <li class="field-item">
              <span class="field-name">Widget Class:</span>
              <span class="field-type">${analysis.widgetClass}</span>
            </li>
            <li class="field-item">
              <span class="field-name">Pattern:</span>
              <span class="field-type">${analysis.hasDynamicObjects ? 'Multiple Objects' : 'Single Widget'}</span>
            </li>
            <li class="field-item">
              <span class="field-name">Field Types:</span>
              <span class="field-type">${analysis.fieldTypes.join(', ')}</span>
            </li>
          </ul>
        </div>
      `;
      document.getElementById('analysisOutput').innerHTML = html;
    }

    async function generateCode() {
      const widgetClass = document.getElementById('widgetClass').value.trim();
      const widgetName = document.getElementById('widgetName').value.trim();
      const widgetDescription = document.getElementById('widgetDescription').value.trim();
      const htmlInput = document.getElementById('htmlInput').value.trim();

      if (!widgetClass) {
        showError('Please enter a widget class name');
        return;
      }

      if (!htmlInput) {
        showError('Please paste widget HTML');
        return;
      }

      const analysis = analyzeHTML(htmlInput);
      
      if (analysis.error) {
        showError(analysis.error);
        return;
      }

      showAnalysis(analysis);

      const processedHTML = processHTML(htmlInput);
      document.getElementById('processedHTMLCode').textContent = processedHTML;
      document.getElementById('previewSection').style.display = 'block';

      const camelClass = toCamelCase(widgetClass);
      const functionName = camelClass.charAt(0).toUpperCase() + camelClass.slice(1);
      
      generateCompleteFiles(
        widgetClass, 
        widgetName || toDisplayName(widgetClass), 
        widgetDescription || `Edit ${widgetClass.replace(/-/g, ' ')} data`,
        analysis, 
        processedHTML, 
        functionName
      );

      document.getElementById('downloadSection').style.display = 'block';
      document.getElementById('downloadBtn').onclick = () => downloadZip(widgetClass);
    }

    function generateCompleteFiles(widgetClass, widgetName, widgetDescription, analysis, processedHTML, functionName) {
      const hasObjects = analysis.hasDynamicObjects;
      
      // Generate content-script.js
      generatedFiles['content-script.js'] = generateContentScript(widgetClass, widgetName, widgetDescription, hasObjects, functionName);
      
      // Generate sidepanel.js
      generatedFiles['sidepanel.js'] = generateSidepanel(widgetClass, widgetName, hasObjects, functionName);
      
      // Generate manifest.json
      generatedFiles['manifest.json'] = generateManifest();
      
      // Include processed HTML
      generatedFiles['processed-widget.html'] = processedHTML;
    }

    function generateContentScript(widgetClass, widgetName, widgetDescription, hasObjects, functionName) {
      const newWidgetRegistry = `  '${widgetClass}': {
    name: '${widgetName}',
    description: '${widgetDescription}'
  }`;

      const newGetData = hasObjects ? `
function get${functionName}Data() {
  const widget = findWidgetElement('${widgetClass}');
  if (!widget) return null;

  const objectElements = widget.querySelectorAll('[data-object-id]');
  const objects = [];

  objectElements.forEach(el => {
    const obj = { id: el.dataset.objectId || '' };
    
    // Find all elements with data attributes within this object
    const dataElements = el.querySelectorAll('[data-text-1], [data-number-1], [data-email-1], [data-phone-1], [data-url-1], [data-date-1], [data-textarea-1], [data-checkbox-1]');
    
    dataElements.forEach(dataEl => {
      Array.from(dataEl.attributes).forEach(attr => {
        if (attr.name.startsWith('data-') && attr.name !== 'data-object-id') {
          const fieldName = attr.name.replace('data-', '').replace(/-/g, '_');
          obj[fieldName] = attr.value;
        }
      });
    });
    
    objects.push(obj);
  });

  return { objects };
}` : `
function get${functionName}Data() {
  const widget = findWidgetElement('${widgetClass}');
  if (!widget) return null;

  const data = {};
  
  // Find all elements with data attributes
  const dataElements = widget.querySelectorAll('[data-text-1], [data-number-1], [data-email-1], [data-phone-1], [data-url-1], [data-date-1], [data-textarea-1], [data-checkbox-1]');
  
  dataElements.forEach(el => {
    Array.from(el.attributes).forEach(attr => {
      if (attr.name.startsWith('data-')) {
        const fieldName = attr.name.replace('data-', '').replace(/-/g, '_');
        data[fieldName] = attr.value;
      }
    });
  });
  
  return data;
}`;

      const newUpdateData = hasObjects ? `
function update${functionName}Data(data) {
  const widget = findWidgetElement('${widgetClass}');
  if (!widget) return false;

  const objectElements = widget.querySelectorAll('[data-object-id]');
  
  data.objects.forEach((obj, index) => {
    if (!objectElements[index]) return;
    const objEl = objectElements[index];

    Object.keys(obj).forEach(key => {
      if (key !== 'id') {
        const attrName = 'data-' + key.replace(/_/g, '-');
        
        // Find element with this data attribute within the object
        const targetEl = objEl.querySelector('[' + attrName + ']');
        if (targetEl) {
          targetEl.setAttribute(attrName, obj[key]);
          targetEl.textContent = obj[key];
        }
      }
    });
  });

  return true;
}` : `
function update${functionName}Data(data) {
  const widget = findWidgetElement('${widgetClass}');
  if (!widget) return false;

  Object.keys(data).forEach(key => {
    const attrName = 'data-' + key.replace(/_/g, '-');
    
    // Find element with this data attribute
    const targetEl = widget.querySelector('[' + attrName + ']');
    if (targetEl) {
      targetEl.setAttribute(attrName, data[key]);
      targetEl.textContent = data[key];
    }
  });

  return true;
}`;

      return `// =============================================================================
// Content Script â€” Scans page for widgets, reads/writes data, notifies Sitecore
// =============================================================================

// Widget registry â€” add new widgets here
const WIDGET_REGISTRY = {
  'insurance-comparison-tool': {
    name: 'Insurance Plan Comparison',
    description: 'Edit insurance plan details and comparison data'
  },
${newWidgetRegistry}
};

// ---------------------------------------------------------------------------
// Mutation observer for dynamically loaded widgets
// ---------------------------------------------------------------------------
let observer = null;

function setupMutationObserver() {
  if (observer) return;

  observer = new MutationObserver(() => {
    clearTimeout(observer._timeout);
    observer._timeout = setTimeout(() => {
      for (const className in WIDGET_REGISTRY) {
        const el = document.querySelector(\`.\${className}\`);
        if (el && !el.dataset.widgetDetected) {
          el.dataset.widgetDetected = 'true';
          console.log(\`[Widget Editor] Detected widget: \${className}\`);
        }
      }
    }, 500);
  });

  observer.observe(document.body, { childList: true, subtree: true });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', setupMutationObserver);
} else {
  setupMutationObserver();
}

// ---------------------------------------------------------------------------
// Message handler â€” communication with sidebar/popup
// ---------------------------------------------------------------------------
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {

  if (request.action === 'detectWidgets') {
    const foundWidgets = detectWidgets();
    if (foundWidgets.length > 0) {
      sendResponse({ widgets: foundWidgets });
    }
    return foundWidgets.length > 0;
  }

  if (request.action === 'getWidgetData') {
    const el = findWidgetElement(request.widgetClass);
    if (!el) return false;
    const data = getWidgetData(request.widgetClass);
    sendResponse({ data });
    return true;
  }

  if (request.action === 'updateWidgetData') {
    const el = findWidgetElement(request.widgetClass);
    if (!el) return false;
    const success = updateWidgetData(request.widgetClass, request.data);
    sendResponse({ success });
    return true;
  }

  return false;
});

// ---------------------------------------------------------------------------
// Widget detection
// ---------------------------------------------------------------------------
function detectWidgets() {
  const found = [];

  for (const className in WIDGET_REGISTRY) {
    const element = document.querySelector(\`.\${className}\`);

    if (element) {
      found.push({
        className,
        name: WIDGET_REGISTRY[className].name,
        description: WIDGET_REGISTRY[className].description
      });
    }
  }

  return found;
}

// ---------------------------------------------------------------------------
// Helper: find widget element in main document
// ---------------------------------------------------------------------------
function findWidgetElement(className) {
  return document.querySelector(\`.\${className}\`);
}

// ---------------------------------------------------------------------------
// Data extraction router
// ---------------------------------------------------------------------------
function getWidgetData(widgetClass) {
  if (widgetClass === 'insurance-comparison-tool') {
    return getInsuranceComparisonData();
  }
  if (widgetClass === '${widgetClass}') {
    return get${functionName}Data();
  }
  return null;
}

// ---------------------------------------------------------------------------
// Data update router â€” applies changes then notifies Sitecore
// ---------------------------------------------------------------------------
function updateWidgetData(widgetClass, data) {
  let success = false;

  if (widgetClass === 'insurance-comparison-tool') {
    success = updateInsuranceComparisonData(data);
  }
  if (widgetClass === '${widgetClass}') {
    success = update${functionName}Data(data);
  }

  if (success) {
    const widgetEl = findWidgetElement(widgetClass);
    if (widgetEl && window.SitecoreBridge) {
      const notified = window.SitecoreBridge.notifyChange(widgetEl);
      console.log(\`[Widget Editor] Sitecore notified: \${notified}\`);
    } else {
      console.warn('[Widget Editor] SitecoreBridge not available or widget not found');
    }
  }

  return success;
}


// =============================================================================
// INSURANCE COMPARISON TOOL
// =============================================================================

function getInsuranceComparisonData() {
  const tool = findWidgetElement('insurance-comparison-tool');
  if (!tool) return null;

  const planButtons = tool.querySelectorAll('[data-plan-id]');
  const plans = [];

  planButtons.forEach(btn => {
    plans.push({
      id:              btn.dataset.planId          || '',
      name:            btn.dataset.planName        || '',
      type:            btn.dataset.planType        || '',
      coverageType:    btn.dataset.coverageType    || '',
      price:           btn.dataset.price           || '',
      deductible:      btn.dataset.deductible      || '',
      maxOutOfPocket:  btn.dataset.maxOutOfPocket  || '',
      coveragePercent: btn.dataset.coveragePercent || '',
      doctorVisits:    btn.dataset.doctorVisits    || '',
      emergency:       btn.dataset.emergency       || '',
      prescription:    btn.dataset.prescription    || '',
      mentalHealth:    btn.dataset.mentalHealth    || '',
      dentalVision:    btn.dataset.dentalVision    || ''
    });
  });

  return { plans };
}

function updateInsuranceComparisonData(data) {
  const tool = findWidgetElement('insurance-comparison-tool');
  if (!tool) return false;

  const planButtons = tool.querySelectorAll('[data-plan-id]');
  const comparisonGrid = tool.querySelector('.comparison-grid');

  const fieldFormatters = {
    price:          function(v) { return '$' + v + '/mo'; },
    deductible:     function(v) { return '$' + Number(v).toLocaleString(); },
    maxOutOfPocket: function(v) { return '$' + Number(v).toLocaleString(); },
    coveragePercent:function(v) { return v + '%'; },
    doctorVisits:   function(v) { return '$' + v; },
    prescription:   function(v) { return v; },
    emergency:      function(v) { return '$' + v; },
    mentalHealth:   function(v) { return v; },
    dentalVision:   function(v) { return v; }
  };

  data.plans.forEach((plan, index) => {
    if (!planButtons[index]) return;
    const btn = planButtons[index];
    const planId = btn.dataset.planId;

    btn.dataset.planName       = plan.name;
    btn.dataset.planType       = plan.type;
    btn.dataset.coverageType   = plan.coverageType;
    btn.dataset.price          = plan.price;
    btn.dataset.deductible     = plan.deductible;
    btn.dataset.maxOutOfPocket = plan.maxOutOfPocket;
    btn.dataset.coveragePercent = plan.coveragePercent;
    btn.dataset.doctorVisits   = plan.doctorVisits;
    btn.dataset.emergency      = plan.emergency;
    btn.dataset.prescription   = plan.prescription;
    btn.dataset.mentalHealth   = plan.mentalHealth;
    btn.dataset.dentalVision   = plan.dentalVision;

    const typeEl = btn.querySelector('.plan-button-type');
    if (typeEl) typeEl.textContent = plan.type;

    const nameEl = btn.querySelector('.plan-button-name');
    if (nameEl) nameEl.textContent = plan.name;

    const coverageEl = btn.querySelector('.plan-button-coverage');
    if (coverageEl) coverageEl.textContent = plan.coverageType + ' Coverage';

    const priceEl = btn.querySelector('.plan-button-price');
    if (priceEl) {
      const periodSpan = priceEl.querySelector('.plan-button-period');
      if (periodSpan) {
        const textNodes = Array.from(priceEl.childNodes).filter(n => n.nodeType === 3);
        if (textNodes.length > 0) {
          textNodes[0].textContent = '$' + plan.price + ' ';
        }
      } else {
        priceEl.textContent = '$' + plan.price;
      }
    }

    if (comparisonGrid) {
      const planFields = {
        price: plan.price, deductible: plan.deductible,
        maxOutOfPocket: plan.maxOutOfPocket, coveragePercent: plan.coveragePercent,
        doctorVisits: plan.doctorVisits, prescription: plan.prescription,
        emergency: plan.emergency, mentalHealth: plan.mentalHealth,
        dentalVision: plan.dentalVision
      };

      for (const field in planFields) {
        const row = comparisonGrid.querySelector('.comparison-row[data-comparison="' + field + '"]');
        if (!row) continue;
        const cell = row.querySelector('.feature-value[data-plan="' + planId + '"]');
        if (!cell) continue;
        const formatter = fieldFormatters[field];
        cell.textContent = formatter ? formatter(planFields[field]) : planFields[field];
      }
    }
  });

  return true;
}

// =============================================================================
// ${widgetClass.toUpperCase().replace(/-/g, ' ')}
// =============================================================================
${newGetData}
${newUpdateData}
`;
    }

    function generateSidepanel(widgetClass, widgetName, hasObjects, functionName) {
      const newRenderCase = `
  if (widgetClass === '${widgetClass}') {
    container.innerHTML = render${functionName}Editor(data);
    attach${functionName}EditorEvents(data);
  }`;

      const inputTypeMap = {
        'text': 'text',
        'email': 'email',
        'number': 'text',
        'phone': 'tel',
        'url': 'url',
        'date': 'date',
        'textarea': 'textarea',
        'checkbox': 'checkbox'
      };

      const renderFunction = hasObjects ? `
function render${functionName}Editor(data) {
  const objects = data.objects;
  const inputTypes = ${JSON.stringify(inputTypeMap)};

  return \`
    <div class="editor-title">${widgetName}</div>

    \${objects.map((obj, index) => \`
      <div class="plan-section">
        <div class="plan-section-title">Item \${parseInt(index) + 1}</div>

        \${Object.keys(obj).filter(k => k !== 'id').map(key => {
          const fieldName = key.replace(/_/g, '-');
          const displayName = fieldName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
          const fieldType = fieldName.split('-')[0];
          const inputType = inputTypes[fieldType] || 'text';
          
          if (inputType === 'textarea') {
            return \`
              <div class="form-group">
                <label>\${displayName}</label>
                <textarea class="field-\${key}" data-object-index="\${index}" rows="4">\${obj[key]}</textarea>
              </div>
            \`;
          } else if (inputType === 'checkbox') {
            return \`
              <div class="form-group">
                <label>
                  <input type="checkbox" class="field-\${key}" data-object-index="\${index}" \${obj[key] === 'true' ? 'checked' : ''}>
                  \${displayName}
                </label>
              </div>
            \`;
          } else {
            return \`
              <div class="form-group">
                <label>\${displayName}</label>
                <input type="\${inputType}" class="field-\${key}" data-object-index="\${index}" value="\${obj[key]}">
              </div>
            \`;
          }
        }).join('')}
      </div>
    \`).join('')}

    <div class="button-group">
      <button class="btn-secondary" id="clearBtn">Reset</button>
      <button class="btn-primary" id="saveBtn">Apply Changes</button>
    </div>
  \`;
}` : `
function render${functionName}Editor(data) {
  const inputTypes = ${JSON.stringify(inputTypeMap)};

  return \`
    <div class="editor-title">${widgetName}</div>

    <div class="plan-section">
      \${Object.keys(data).map(key => {
        const fieldName = key.replace(/_/g, '-');
        const displayName = fieldName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        const fieldType = fieldName.split('-')[0];
        const inputType = inputTypes[fieldType] || 'text';
        
        if (inputType === 'textarea') {
          return \`
            <div class="form-group">
              <label>\${displayName}</label>
              <textarea class="field-\${key}" rows="4">\${data[key]}</textarea>
            </div>
          \`;
        } else if (inputType === 'checkbox') {
          return \`
            <div class="form-group">
              <label>
                <input type="checkbox" class="field-\${key}" \${data[key] === 'true' ? 'checked' : ''}>
                \${displayName}
              </label>
            </div>
          \`;
        } else {
          return \`
            <div class="form-group">
              <label>\${displayName}</label>
              <input type="\${inputType}" class="field-\${key}" value="\${data[key]}">
            </div>
          \`;
        }
      }).join('')}
    </div>

    <div class="button-group">
      <button class="btn-secondary" id="clearBtn">Reset</button>
      <button class="btn-primary" id="saveBtn">Apply Changes</button>
    </div>
  \`;
}`;

      const attachFunction = `
function attach${functionName}EditorEvents(originalData) {
  document.getElementById('saveBtn').addEventListener('click', save${functionName}Data);
  document.getElementById('clearBtn').addEventListener('click', () => {
    renderEditor('${widgetClass}', originalData);
  });
}`;

      const saveFunction = hasObjects ? `
async function save${functionName}Data() {
  const formData = { objects: [] };
  const objectCount = document.querySelectorAll('.plan-section').length;
  
  for (let i = 0; i < objectCount; i++) {
    const obj = { id: (i + 1).toString() };
    document.querySelectorAll(\`[data-object-index="\${i}"]\`).forEach(input => {
      const key = input.className.replace('field-', '');
      obj[key] = input.type === 'checkbox' ? input.checked.toString() : input.value;
    });
    formData.objects.push(obj);
  }

  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  chrome.tabs.sendMessage(tab.id, {
    action: 'updateWidgetData',
    widgetClass: '${widgetClass}',
    data: formData
  }, (response) => {
    if (response && response.success) {
      showSuccess('Changes applied successfully! The page has been updated.');
    } else {
      showError('Failed to apply changes. Please try again.');
    }
  });
}` : `
async function save${functionName}Data() {
  const formData = {};
  document.querySelectorAll('[class^="field-"]').forEach(input => {
    const key = input.className.replace('field-', '');
    formData[key] = input.type === 'checkbox' ? input.checked.toString() : input.value;
  });

  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  chrome.tabs.sendMessage(tab.id, {
    action: 'updateWidgetData',
    widgetClass: '${widgetClass}',
    data: formData
  }, (response) => {
    if (response && response.success) {
      showSuccess('Changes applied successfully! The page has been updated.');
    } else {
      showError('Failed to apply changes. Please try again.');
    }
  });
}`;

      return `// =============================================================================
// Sidepanel script â€” Widget editor UI
// =============================================================================

let currentWidgets = [];
let selectedWidget = null;
let activeTab = null;

const MAX_RETRIES = 3;
const RETRY_DELAY = 1000;
let retryCount = 0;

document.addEventListener('DOMContentLoaded', async () => {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
  activeTab = tab;
  await scanForWidgets();
  setupRescanButton();
});

function setupRescanButton() {
  const headerDiv = document.querySelector('.header');
  const rescanBtn = document.createElement('button');
  rescanBtn.id = 'rescanBtn';
  rescanBtn.innerHTML = 'â†» Rescan Page';
  rescanBtn.onclick = async () => {
    retryCount = 0;
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').textContent = 'Scanning page for widgets...';
    document.getElementById('noWidgets').style.display = 'none';
    document.getElementById('widgetSelector').style.display = 'none';
    document.getElementById('editorContainer').style.display = 'none';
    document.getElementById('messageArea').innerHTML = '';
    await scanForWidgets();
  };
  headerDiv.appendChild(rescanBtn);
}

async function scanForWidgets() {
  if (!activeTab) {
    const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
    activeTab = tab;
  }

  chrome.tabs.sendMessage(activeTab.id, { action: 'detectWidgets' }, (response) => {
    if (chrome.runtime.lastError) {
      showError('Could not connect to page. Please refresh and try again.');
      return;
    }

    if (response && response.widgets) {
      if (response.widgets.length > 0) {
        retryCount = 0;
        handleWidgetsDetected(response.widgets);
      } else {
        if (retryCount < MAX_RETRIES) {
          retryCount++;
          const loadingEl = document.getElementById('loading');
          loadingEl.textContent = \`Scanning page for widgets... (attempt \${retryCount + 1} of \${MAX_RETRIES + 1})\`;
          setTimeout(() => { scanForWidgets(); }, RETRY_DELAY);
        } else {
          retryCount = 0;
          handleWidgetsDetected([]);
        }
      }
    }
  });
}

function handleWidgetsDetected(widgets) {
  document.getElementById('loading').style.display = 'none';
  currentWidgets = widgets;

  if (widgets.length === 0) {
    document.getElementById('noWidgets').style.display = 'block';
  } else if (widgets.length === 1) {
    selectedWidget = widgets[0];
    loadEditor(widgets[0].className);
  } else {
    showWidgetSelector(widgets);
  }
}

function showWidgetSelector(widgets) {
  const selector = document.getElementById('widgetSelector');
  const dropdown = document.getElementById('widgetDropdown');

  dropdown.innerHTML = '<option value="">-- Select a widget --</option>';

  widgets.forEach(widget => {
    const option = document.createElement('option');
    option.value = widget.className;
    option.textContent = widget.name;
    dropdown.appendChild(option);
  });

  dropdown.addEventListener('change', (e) => {
    if (e.target.value) {
      const widget = widgets.find(w => w.className === e.target.value);
      selectedWidget = widget;
      loadEditor(e.target.value);
    }
  });

  selector.style.display = 'block';
}

async function loadEditor(widgetClass) {
  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  chrome.tabs.sendMessage(tab.id, {
    action: 'getWidgetData',
    widgetClass: widgetClass
  }, (response) => {
    if (chrome.runtime.lastError) {
      showError('Could not connect to page. Please refresh and try again.');
      return;
    }
    if (response && response.data) {
      renderEditor(widgetClass, response.data);
    } else {
      showError('Could not read widget data from the page.');
    }
  });
}

function renderEditor(widgetClass, data) {
  const container = document.getElementById('editorContainer');

  if (widgetClass === 'insurance-comparison-tool') {
    container.innerHTML = renderInsuranceEditor(data);
    attachInsuranceEditorEvents(data);
  }
${newRenderCase}

  container.style.display = 'block';
}


// =============================================================================
// INSURANCE COMPARISON EDITOR
// =============================================================================

function renderInsuranceEditor(data) {
  const plans = data.plans;

  return \`
    <div class="editor-title">Insurance Plan Comparison</div>

    \${plans.map((plan, index) => \`
      <div class="plan-section">
        <div class="plan-section-title">Plan \${parseInt(index) + 1}</div>

        <div class="form-group">
          <label>Plan Name</label>
          <input type="text" class="plan-name" data-plan-index="\${index}" value="\${plan.name}">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Plan Type</label>
            <select class="plan-type" data-plan-index="\${index}">
              <option value="basic" \${plan.type === 'basic' ? 'selected' : ''}>Basic</option>
              <option value="standard" \${plan.type === 'standard' ? 'selected' : ''}>Standard</option>
              <option value="premium" \${plan.type === 'premium' ? 'selected' : ''}>Premium</option>
              <option value="family" \${plan.type === 'family' ? 'selected' : ''}>Family</option>
            </select>
          </div>

          <div class="form-group">
            <label>Coverage Type</label>
            <select class="plan-coverage-type" data-plan-index="\${index}">
              <option value="Individual" \${plan.coverageType === 'Individual' ? 'selected' : ''}>Individual</option>
              <option value="Family" \${plan.coverageType === 'Family' ? 'selected' : ''}>Family</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Monthly Price ($)</label>
            <input type="text" class="plan-price" data-plan-index="\${index}" value="\${plan.price}">
          </div>

          <div class="form-group">
            <label>Annual Deductible ($)</label>
            <input type="text" class="plan-deductible" data-plan-index="\${index}" value="\${plan.deductible}">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Max Out-of-Pocket ($)</label>
            <input type="text" class="plan-max-out" data-plan-index="\${index}" value="\${plan.maxOutOfPocket}">
          </div>

          <div class="form-group">
            <label>Coverage Percent (%)</label>
            <input type="text" class="plan-coverage-percent" data-plan-index="\${index}" value="\${plan.coveragePercent}">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Doctor Visit Copay ($)</label>
            <input type="text" class="plan-doctor-visits" data-plan-index="\${index}" value="\${plan.doctorVisits}">
          </div>

          <div class="form-group">
            <label>Emergency Care Copay ($)</label>
            <input type="text" class="plan-emergency" data-plan-index="\${index}" value="\${plan.emergency}">
          </div>
        </div>

        <div class="form-group">
          <label>Prescription Coverage</label>
          <input type="text" class="plan-prescription" data-plan-index="\${index}" value="\${plan.prescription}">
          <div class="help-text">e.g., "Generic only", "Generic & Brand", "Full coverage"</div>
        </div>

        <div class="form-group">
          <label>Mental Health Coverage</label>
          <input type="text" class="plan-mental-health" data-plan-index="\${index}" value="\${plan.mentalHealth}">
          <div class="help-text">e.g., "Limited", "Included", "Full coverage"</div>
        </div>

        <div class="form-group">
          <label>Dental & Vision</label>
          <input type="text" class="plan-dental-vision" data-plan-index="\${index}" value="\${plan.dentalVision}">
          <div class="help-text">e.g., "Not included", "Vision only", "Both included"</div>
        </div>
      </div>
    \`).join('')}

    <div class="button-group">
      <button class="btn-secondary" id="clearBtn">Clear Form</button>
      <button class="btn-primary" id="saveBtn">Apply Changes</button>
    </div>
  \`;
}

function attachInsuranceEditorEvents(originalData) {
  document.getElementById('saveBtn').addEventListener('click', saveInsuranceData);
  document.getElementById('clearBtn').addEventListener('click', () => {
    clearInsuranceForm(originalData);
  });
}

function clearInsuranceForm(originalData) {
  const plans = originalData.plans;
  plans.forEach((plan, index) => {
    const i = index.toString();
    const field = (cls) => document.querySelector(\`.\${cls}[data-plan-index="\${i}"]\`);

    field('plan-name').value = plan.name || '';
    field('plan-type').value = plan.type || 'basic';
    field('plan-coverage-type').value = plan.coverageType || 'Individual';
    field('plan-price').value = plan.price || '';
    field('plan-deductible').value = plan.deductible || '';
    field('plan-max-out').value = plan.maxOutOfPocket || '';
    field('plan-coverage-percent').value = plan.coveragePercent || '';
    field('plan-doctor-visits').value = plan.doctorVisits || '';
    field('plan-emergency').value = plan.emergency || '';
    field('plan-prescription').value = plan.prescription || '';
    field('plan-mental-health').value = plan.mentalHealth || '';
    field('plan-dental-vision').value = plan.dentalVision || '';
  });
  document.getElementById('messageArea').innerHTML = '';
}

async function saveInsuranceData() {
  const plans = [];
  const planCount = document.querySelectorAll('.plan-section').length;

  for (let i = 0; i < planCount; i++) {
    const field = (cls) => document.querySelector(\`.\${cls}[data-plan-index="\${i}"]\`);

    plans.push({
      id: (i + 1).toString(),
      name: field('plan-name').value,
      type: field('plan-type').value,
      coverageType: field('plan-coverage-type').value,
      price: field('plan-price').value,
      deductible: field('plan-deductible').value,
      maxOutOfPocket: field('plan-max-out').value,
      coveragePercent: field('plan-coverage-percent').value,
      doctorVisits: field('plan-doctor-visits').value,
      emergency: field('plan-emergency').value,
      prescription: field('plan-prescription').value,
      mentalHealth: field('plan-mental-health').value,
      dentalVision: field('plan-dental-vision').value
    });
  }

  const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });

  chrome.tabs.sendMessage(tab.id, {
    action: 'updateWidgetData',
    widgetClass: 'insurance-comparison-tool',
    data: { plans: plans }
  }, (response) => {
    if (response && response.success) {
      showSuccess('Changes applied successfully! The page has been updated.');
    } else {
      showError('Failed to apply changes. Please try again.');
    }
  });
}


// =============================================================================
// ${widgetClass.toUpperCase().replace(/-/g, ' ')} EDITOR
// =============================================================================
${renderFunction}
${attachFunction}
${saveFunction}


// =============================================================================
// HELPERS
// =============================================================================

function showSuccess(message) {
  const messageArea = document.getElementById('messageArea');
  messageArea.innerHTML = \`<div class="success-message">\${message}</div>\`;
  setTimeout(() => { messageArea.innerHTML = ''; }, 5000);
}

function showError(message) {
  const messageArea = document.getElementById('messageArea');
  messageArea.innerHTML = \`<div class="error-message">\${message}</div>\`;
  document.getElementById('loading').style.display = 'none';
}
`;
    }

    function generateManifest() {
      const now = new Date();
      const version = `1.${now.getMonth() + 1}.${now.getDate()}`;
      
      return JSON.stringify({
        "manifest_version": 3,
        "name": "Sitecore Widget Editor",
        "version": version,
        "description": "Edit custom widgets on Sitecore pages with a visual interface",
        "permissions": ["activeTab", "scripting", "sidePanel"],
        "side_panel": { "default_path": "sidepanel.html" },
        "action": {
          "default_icon": {
            "16": "icon16.png",
            "48": "icon48.png",
            "128": "icon128.png"
          }
        },
        "background": { "service_worker": "background.js" },
        "icons": {
          "16": "icon16.png",
          "48": "icon48.png",
          "128": "icon128.png"
        },
        "content_scripts": [{
          "matches": ["<all_urls>"],
          "js": ["sitecore-bridge.js", "content-script.js"],
          "run_at": "document_idle",
          "all_frames": false
        }]
      }, null, 2);
    }

    async function downloadZip(widgetClass) {
      const zip = new JSZip();
      
      Object.keys(generatedFiles).forEach(filename => {
        zip.file(filename, generatedFiles[filename]);
      });

      const content = await zip.generateAsync({type: "blob"});
      const link = document.createElement('a');
      link.href = URL.createObjectURL(content);
      link.download = `${widgetClass}-extension-files.zip`;
      link.click();
    }
  </script>

</body>
</html>